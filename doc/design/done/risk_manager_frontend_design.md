# 风控管理器前端设计文档

**版本**: v1.0
**创建时间**: 2025-11-12
**状态**: 设计中
**关联文档**:
- 后端设计: `doc/design/risk_manager_detailed_design.md`
- PRD: `doc/requirements/product_requirements_stock_pal.md`
- 竞品分析: `doc/requirements/competitor_analysis.md`

---

## 1. 设计理念与产品定位

### 1.1 核心价值主张

基于PRD的北极星指标（**用户完成"筛股 → 回测 → 次日计划 → 提醒 → 复盘"的完整闭环次数**），风控管理器的前端设计围绕3个核心价值：

1. **让风险可见** - 用可视化让小白用户"看懂"风险
2. **让风控易用** - 无需复杂配置，提供预设模板
3. **让风控有用** - 通过对比展示风控的实际效果，建立信任

### 1.2 目标用户与使用场景

根据竞品分析，我们的核心用户是**小白散户（60%）**，他们的痛点是：
- ❌ 不知道何时止损止盈
- ❌ 看到亏损心态崩溃，不知道如何控制回撤
- ❌ 同花顺的风控功能太复杂（需要设置公式）

**我们的解决方案**：
- ✅ 预设3种风控模板（保守/平衡/激进），一键应用
- ✅ 实时展示风控触发事件，帮助用户理解
- ✅ 对比分析：有风控 vs 无风控的效果差异

### 1.3 设计原则

| 原则 | 说明 | 体现 |
|------|------|------|
| **简单优先** | 不让用户面对复杂参数 | 提供预设模板，高级选项默认折叠 |
| **教育为本** | 帮助用户理解风控 | 展示风控对比、事件时间线 |
| **透明可见** | 所有风控触发都可追溯 | 风控事件卡片、K线标注 |
| **闭环服务** | 回测→次日计划→提醒 | 风控建议融入次日计划 |

---

## 2. 功能架构与信息架构

### 2.1 功能地图

```
BacktestPage（回测页面）
│
├─ 1. 参数配置区
│   ├─ 基础参数（股票代码、日期、资金）
│   └─ 【新增】风控配置面板
│       ├─ 快速模板（保守/平衡/激进）
│       └─ 自定义配置（折叠）
│
├─ 2. 回测结果展示区
│   ├─ 指标卡片组
│   │   ├─ 收益指标（年化、总收益）
│   │   ├─ 风险指标（夏普、最大回撤）
│   │   └─ 【新增】风控影响卡片
│   │
│   ├─ K线图
│   │   ├─ 买卖点标注
│   │   └─ 【新增】风控事件标注（止损/止盈/回撤保护）
│   │
│   ├─ 权益曲线图
│   │   ├─ 策略曲线
│   │   └─ 【新增】无风控对比曲线
│   │
│   └─ 【新增】风控事件时间线
│       └─ 展示所有风控触发事件
│
└─ 3. 交易记录表
    ├─ 交易明细
    └─ 【新增】退出原因列（策略信号/止损/止盈/回撤保护）

---

【新增】DailyPlanPage（次日计划页）
│
└─ 策略选股结果
    ├─ 候选股票列表
    └─ 【新增】每只股票的风控建议
        ├─ 建议止损价
        ├─ 建议止盈价
        └─ 最大仓位建议
```

### 2.2 页面流程图

```
用户旅程：回测 → 理解风控 → 应用到实盘

┌─────────────────────────────────────────────────────────┐
│ Step 1: 配置回测                                          │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 1. 选择策略（如MA Cross）                             │ │
│ │ 2. 点击"风控配置"                                     │ │
│ │ 3. 选择模板（推荐：平衡型）或自定义                    │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ Step 2: 查看回测结果                                      │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 1. 查看"风控影响卡片"（止损3次、胜率提升）            │ │
│ │ 2. 查看权益曲线对比（有风控 vs 无风控）               │ │
│ │ 3. 查看K线图上的风控事件标注                          │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ Step 3: 理解风控效果（教育环节）                           │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 1. 点击"风控对比分析"按钮                             │ │
│ │ 2. 查看详细对比表格                                   │ │
│ │ 3. 查看风控事件时间线（了解每次触发原因）              │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ Step 4: 应用到实盘（闭环）                                │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 1. 进入"次日计划"页面                                 │ │
│ │ 2. 查看选股结果 + 风控建议                            │ │
│ │ 3. 设置提醒（到止损价/止盈价时通知）                   │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 详细UI设计

### 3.1 风控配置面板

#### 3.1.1 快速模板选择（默认展开）

**设计目标**：让小白用户无需理解参数含义，一键应用

**布局**：

```
┌─────────────────────────────────────────────────────────┐
│ 风控配置                                     [?] 什么是风控 │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 选择风控模板：                                             │
│                                                           │
│ ┌────────────┐  ┌────────────┐  ┌────────────┐         │
│ │  🛡️ 保守型  │  │  ⚖️ 平衡型  │  │  🚀 激进型  │         │
│ │            │  │  [已选中]  │  │            │         │
│ │ 止损 8%    │  │ 止损 10%   │  │ 止损 15%   │         │
│ │ 止盈 15%   │  │ 止盈 20%   │  │ 止盈 30%   │         │
│ │ 回撤 15%   │  │ 回撤 20%   │  │ 回撤 25%   │         │
│ │ 仓位 20%   │  │ 仓位 30%   │  │ 仓位 50%   │         │
│ └────────────┘  └────────────┘  └────────────┘         │
│                                                           │
│ [▼ 自定义配置]                         [不启用风控]        │
└─────────────────────────────────────────────────────────┘
```

**交互说明**：
1. 默认选中"平衡型"（最推荐）
2. 点击卡片切换模板
3. 鼠标悬停显示模板说明（Tooltip）
4. "自定义配置"默认折叠，点击展开

**模板参数定义**：

| 参数 | 保守型 | 平衡型 | 激进型 | 说明 |
|------|-------|-------|-------|------|
| 止损 | 8% | 10% | 15% | 亏损多少时自动卖出 |
| 止盈 | 15% | 20% | 30% | 盈利多少时自动卖出 |
| 回撤保护 | 15% | 20% | 25% | 从最高点回撤多少时清仓 |
| 单票仓位 | 20% | 30% | 50% | 单只股票最多占资金比例 |

#### 3.1.2 自定义配置（点击展开）

**设计目标**：为进阶用户提供灵活性，但不干扰小白用户

**布局**：

```
┌─────────────────────────────────────────────────────────┐
│ [▲ 自定义配置]                                            │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 止损止盈                                                   │
│ ├─ 止损线     [●────────] 10%   [✓] 启用                 │
│ └─ 止盈线     [●────────] 20%   [✓] 启用                 │
│                                                           │
│ 仓位控制                                                   │
│ ├─ 单票仓位   [●────────] 30%                            │
│ └─ 总仓位     [●────────] 95%                            │
│                                                           │
│ 组合风控                                                   │
│ └─ 回撤保护   [●────────] 20%   [✓] 启用                 │
│                                                           │
│ [恢复默认]                          [应用]                │
└─────────────────────────────────────────────────────────┘
```

**交互说明**：
1. 使用滑块（Slider）+ 数字输入框
2. 每个参数右侧有"?"图标，悬停显示详细说明
3. "启用"开关控制该规则是否生效
4. "恢复默认"按钮重置为平衡型模板

---

### 3.2 风控影响卡片（新增MetricsCard）

**设计目标**：用户一眼看出风控的效果

**布局**：

```
┌─────────────────────────────────────────────────────────┐
│ 📊 风控影响分析                          [查看详细对比]    │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│ │ 止损触发    │  │ 止盈触发    │  │ 回撤保护    │      │
│ │   3 次      │  │   5 次      │  │   1 次      │      │
│ │ ↓ 避免亏损  │  │ ↑ 锁定收益  │  │ ↓ 止住出血  │      │
│ │   -12.5%    │  │   +18.3%    │  │   -8.2%     │      │
│ └─────────────┘  └─────────────┘  └─────────────┘      │
│                                                           │
│ ┌─────────────┐  ┌─────────────┐                        │
│ │ 拒绝订单    │  │ 总体效果    │                        │
│ │   2 次      │  │ 收益提升    │                        │
│ │ 🛡️ 防止超仓 │  │   +5.2%     │                        │
│ │             │  │ 回撤降低    │                        │
│ │             │  │   -3.1%     │                        │
│ └─────────────┘  └─────────────┘                        │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

**数据说明**：
- **止损触发**：显示止损次数 + 避免的额外亏损
- **止盈触发**：显示止盈次数 + 锁定的收益
- **回撤保护**：显示触发次数 + 当时的回撤幅度
- **拒绝订单**：显示因仓位限制拒绝的订单次数
- **总体效果**：对比有/无风控的收益和回撤差异

**交互**：
- 点击"查看详细对比"按钮 → 展开风控对比抽屉（见3.5节）

---

### 3.3 K线图风控标注

**设计目标**：让用户直观看到风控在何时何处触发

**视觉设计**：

```
K线图（ECharts）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   ▲ 价格
   │
15 │         ╭──╮              ╭──╮
   │    ╭──╮ │  │         ╭──╮ │  │
14 │    │  │ ╰──╯    ╭──╮│  │ ╰──╯
   │ ╭──╯  ╰──────╮  │  ╰╯  ╰─────╮
13 │ │            │╭─╯             │
   │─┼────────────┼┼───────────────┼──→ 时间
   │ ▲            ▼│               ▼
   │ 买入        止损             止盈
   │ (策略)      (风控)           (风控)
   │
   │ 图例：
   │ ▲ 绿色 - 策略买入    ▼ 橙色 - 止损卖出
   │ ▼ 蓝色 - 策略卖出    ⚠️ 红色 - 回撤保护清仓
```

**标注样式**：

| 事件类型 | 图标 | 颜色 | 说明 |
|---------|------|------|------|
| 策略买入 | ▲ | 绿色 | 正常策略信号 |
| 策略卖出 | ▼ | 蓝色 | 正常策略信号 |
| 止损卖出 | ⚠️▼ | 橙色 | 风控触发止损 |
| 止盈卖出 | 💰▼ | 金色 | 风控触发止盈 |
| 回撤保护 | 🛑 | 红色 | 风控触发清仓 |
| 拒绝买入 | 🚫 | 灰色 | 风控拒绝订单 |

**交互**：
1. 鼠标悬停显示详细信息（Tooltip）
   ```
   ┌─────────────────────────────┐
   │ 2023-05-15                  │
   │ 止损卖出                     │
   │ 触发价格：12.50元            │
   │ 成本价格：13.89元            │
   │ 亏损：-10.01%               │
   │ 止损线设置：-10%             │
   └─────────────────────────────┘
   ```

2. 点击标注 → 在侧边栏展示该事件详情

---

### 3.4 权益曲线对比图

**设计目标**：直观展示风控的保护作用

**视觉设计**：

```
权益曲线图（ECharts 双线图）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   ▲ 权益
   │                            ┌────── 有风控（实线）
140k│                    ╭──────┤
   │                ╭───╯       └────── 无风控（虚线）
130k│            ╭──╯      ╭─────╮
   │        ╭───╯      ╭───╯     ╰─╮
120k│    ╭──╯      ╭───╯           ╰╮
   │╭───╯      ╭───╯   ⚠️           ╰─╮
110k│──────╭───╯       止损          ╰──╮
   │      │           触发              ╰─────╮
100k│──────┼────────────────────────────┼─────┼──→ 时间
   │    2022         2023             2024   2025
   │
   │ 说明：
   │ 实线 = 启用风控（止损-10%、止盈+20%、回撤20%）
   │ 虚线 = 未启用风控（对照组）
```

**关键展示点**：
1. 在关键风控触发点标注（如上图⚠️处）
2. 图例清晰标注两条曲线的配置
3. 最终收益差异高亮显示

**交互**：
1. 图表右上角有开关按钮：
   ```
   [✓] 显示无风控对比
   [✓] 标注风控事件
   ```
2. 鼠标悬停显示两条曲线的数值差异

---

### 3.5 风控对比分析抽屉（Drawer）

**设计目标**：详细展示风控的量化效果，建立用户信任

**触发方式**：点击"风控影响卡片"上的"查看详细对比"按钮

**布局**：

```
┌───────────────────────────────────────────────────────────────┐
│ 风控对比分析                                      [X] 关闭      │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│ 📊 整体效果对比                                                 │
│                                                                 │
│ ┌─────────────────────┬──────────┬──────────┬──────────┐     │
│ │ 指标                │ 无风控   │ 有风控   │ 差异     │     │
│ ├─────────────────────┼──────────┼──────────┼──────────┤     │
│ │ 总收益              │ +22.5%   │ +27.7%   │ +5.2% ↗️ │     │
│ │ 年化收益            │ +10.2%   │ +12.8%   │ +2.6% ↗️ │     │
│ │ 最大回撤            │ -25.3%   │ -22.2%   │ +3.1% ↗️ │     │
│ │ 夏普比率            │  1.05    │  1.23    │ +0.18 ↗️ │     │
│ │ 胜率                │  48.5%   │  52.3%   │ +3.8% ↗️ │     │
│ │ 盈亏比              │  1.52    │  1.68    │ +0.16 ↗️ │     │
│ └─────────────────────┴──────────┴──────────┴──────────┘     │
│                                                                 │
│ 💡 解读：启用风控后，收益提升5.2%，同时最大回撤降低3.1%，       │
│         风险调整后的收益（夏普比率）显著提升。                  │
│                                                                 │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│ 🎯 风控触发明细                                                 │
│                                                                 │
│ ┌─ 止损事件（3次，避免额外亏损 -12.5%）                         │
│ │                                                               │
│ │ 1️⃣ 2023-05-15  600000浦发银行                               │
│ │    成本：13.89元 → 卖出：12.50元  亏损 -10.01%               │
│ │    💡 若不止损，后续最低跌至11.20元，会多亏 -19.3%            │
│ │                                                               │
│ │ 2️⃣ 2023-08-22  000001平安银行                               │
│ │    成本：11.20元 → 卖出：10.05元  亏损 -10.3%                │
│ │    💡 若不止损，后续最低跌至9.50元，会多亏 -15.2%             │
│ │                                                               │
│ │ 3️⃣ 2024-02-10  600036招商银行                               │
│ │    成本：36.80元 → 卖出：33.10元  亏损 -10.1%                │
│ │    💡 若不止损，后续最低跌至31.50元，会多亏 -14.4%            │
│ └─                                                              │
│                                                                 │
│ ┌─ 止盈事件（5次，锁定收益 +18.3%）                             │
│ │                                                               │
│ │ 1️⃣ 2023-06-20  600519贵州茅台                               │
│ │    成本：1680元 → 卖出：2016元  盈利 +20.0%                  │
│ │    💡 若不止盈，后续回落至1850元，收益会降至 +10.1%           │
│ │                                                               │
│ │ ... (其余4次)                                                 │
│ └─                                                              │
│                                                                 │
│ ┌─ 回撤保护（1次，避免进一步亏损 -8.2%）                        │
│ │                                                               │
│ │ 1️⃣ 2024-03-15  全仓清空                                      │
│ │    峰值权益：142,000元 → 当前权益：113,600元  回撤 -20.0%    │
│ │    💡 触发后市场继续下跌，避免了额外 -8.2% 的亏损             │
│ └─                                                              │
│                                                                 │
└───────────────────────────────────────────────────────────────┘
```

**关键设计点**：
1. **对比表格**：清晰展示有/无风控的指标差异
2. **事件明细**：每个风控触发点都有"反事实推理"（若不止损会怎样）
3. **用户教育**：通过💡解读帮助用户理解风控的价值

---

### 3.6 交易记录表增强

**新增列：退出原因**

```
┌─────────────────────────────────────────────────────────────┐
│ 交易记录                                [导出CSV]             │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 日期         操作  股票    价格    数量   金额    退出原因   │
│ ─────────────────────────────────────────────────────────── │
│ 2023-01-05   买入  600000  13.89  1000   13,890   -        │
│ 2023-05-15   卖出  600000  12.50  1000   12,500  🛑 止损    │
│                                            盈亏: -1,390      │
│                                                               │
│ 2023-06-10   买入  600519  1680   10     16,800   -        │
│ 2023-06-20   卖出  600519  2016   10     20,160  💰 止盈    │
│                                            盈亏: +3,360      │
│                                                               │
│ 2024-03-15   卖出  全部持仓            -        ⚠️ 回撤保护 │
│                                            盈亏: -8,400      │
└─────────────────────────────────────────────────────────────┘
```

**视觉区分**：
- 策略信号：无特殊标记
- 止损：🛑 + 橙色文字
- 止盈：💰 + 金色文字
- 回撤保护：⚠️ + 红色文字

---

## 4. 次日计划页面集成

### 4.1 选股结果 + 风控建议

**设计目标**：将风控能力应用到实盘，完成闭环

**场景**：用户使用策略扫描全市场后，获得候选股票列表，系统自动计算风控建议

**布局**：

```
┌─────────────────────────────────────────────────────────────┐
│ 次日计划 - 2025-11-13                        [生成PDF报告]   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ 基于策略：MA Cross (5日/20日均线)                            │
│ 风控配置：平衡型（止损-10%、止盈+20%、回撤20%）              │
│                                                               │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 1️⃣ 600000 浦发银行                    信号强度: ⭐⭐⭐⭐    │
│ │                                                         │   │
│ │ 当前价格：9.85元                                        │   │
│ │ 📊 建议买入：9.80 - 10.00元（接近5日均线金叉）          │   │
│ │ 🛡️ 风控建议：                                           │   │
│ │    ├─ 建议止损价：8.87元（-10%）                        │   │
│ │    ├─ 建议止盈价：11.82元（+20%）                       │   │
│ │    └─ 最大仓位：30%（30,000元，约3,045股）             │   │
│ │                                                         │   │
│ │ [设置提醒]  [加入观察列表]                              │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 2️⃣ 600519 贵州茅台                    信号强度: ⭐⭐⭐     │
│ │                                                         │   │
│ │ 当前价格：1,685元                                       │   │
│ │ 📊 建议买入：1,680 - 1,700元                            │   │
│ │ 🛡️ 风控建议：                                           │   │
│ │    ├─ 建议止损价：1,517元（-10%）                       │   │
│ │    ├─ 建议止盈价：2,022元（+20%）                       │   │
│ │    └─ 最大仓位：30%（30,000元，约17股）                │   │
│ │                                                         │   │
│ │ [设置提醒]  [加入观察列表]                              │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 提醒设置集成

**触发**：点击"设置提醒"按钮

**弹窗设计**：

```
┌─────────────────────────────────────────────────────────┐
│ 设置提醒 - 600000 浦发银行              [X] 关闭          │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 买入提醒                                                  │
│ [✓] 价格进入买入区间（9.80 - 10.00元）                   │
│     └─ 提醒方式：[✓] 站内通知  [✓] 邮件                  │
│                                                           │
│ 风控提醒                                                  │
│ [✓] 跌破止损价（8.87元，-10%）                           │
│ [✓] 突破止盈价（11.82元，+20%）                          │
│     └─ 提醒方式：[✓] 站内通知  [✓] 邮件  [ ] 微信        │
│                                                           │
│ 其他提醒                                                  │
│ [ ] 均线死叉（卖出信号）                                  │
│ [ ] 成交量放大（>昨日2倍）                                │
│                                                           │
│                            [取消]        [确认设置]       │
└─────────────────────────────────────────────────────────┘
```

**关键设计点**：
1. 风控提醒默认勾选（引导用户使用）
2. 止损/止盈价格自动填充（基于回测配置）
3. 支持多通道通知（站内/邮件/微信）

---

## 5. 用户教育与引导

### 5.1 首次使用引导（Onboarding）

**场景**：用户第一次使用风控功能

**引导流程**：

```
Step 1: 欢迎弹窗
┌─────────────────────────────────────────────────────────┐
│ 🎉 新功能：风控管理                                       │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 风控可以帮助你：                                          │
│ ✓ 自动止损，避免深度套牢                                  │
│ ✓ 自动止盈，锁定利润                                      │
│ ✓ 回撤保护，防止账户大幅亏损                              │
│                                                           │
│ 我们为你准备了3种预设模板：                                │
│ • 保守型：适合新手，风控较严格                            │
│ • 平衡型：推荐使用，风险收益平衡                          │
│ • 激进型：追求高收益，风控较宽松                          │
│                                                           │
│                     [跳过]        [开始体验]              │
└─────────────────────────────────────────────────────────┘

Step 2: 指向风控配置面板
┌────────────────────┐
│ 👇 点这里选择模板   │
└────────────────────┘
         │
         ↓
    [风控配置按钮]

Step 3: 指向风控影响卡片
┌────────────────────┐
│ 👈 这里看风控效果   │
└────────────────────┘
         │
         ↓
    [风控影响卡片]

Step 4: 完成引导
┌─────────────────────────────────────────────────────────┐
│ ✅ 引导完成                                               │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 你已经了解了风控功能的基本用法！                          │
│                                                           │
│ 接下来，试试对比有/无风控的回测结果，                      │
│ 看看风控能为你的策略带来什么改变。                        │
│                                                           │
│                                       [我知道了]          │
└─────────────────────────────────────────────────────────┘
```

### 5.2 帮助文档入口

**位置**：风控配置面板标题右侧 `[?] 什么是风控`

**点击后展开侧边栏**：

```
┌───────────────────────────────────────────────────────────┐
│ 风控管理 - 帮助文档                        [X] 关闭        │
├───────────────────────────────────────────────────────────┤
│                                                             │
│ 📖 什么是风控？                                             │
│                                                             │
│ 风控（风险控制）是一套规则，在回测或实盘中自动执行，        │
│ 帮助你控制亏损、锁定收益、防止账户大幅回撤。                │
│                                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━             │
│                                                             │
│ 🛡️ 止损                                                    │
│                                                             │
│ 定义：股价亏损超过设定比例时自动卖出                        │
│ 例子：设置止损-10%，买入价10元，跌至9元时自动卖出           │
│ 作用：避免深度套牢，控制单笔亏损                            │
│                                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━             │
│                                                             │
│ 💰 止盈                                                     │
│                                                             │
│ 定义：股价盈利超过设定比例时自动卖出                        │
│ 例子：设置止盈+20%，买入价10元，涨至12元时自动卖出          │
│ 作用：锁定利润，避免回吐收益                                │
│                                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━             │
│                                                             │
│ ⚠️ 回撤保护                                                 │
│                                                             │
│ 定义：账户从最高点回撤超过设定比例时清空所有持仓            │
│ 例子：设置回撤20%，权益最高14万，跌至11.2万时清仓           │
│ 作用：在系统性下跌中保护本金                                │
│                                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━             │
│                                                             │
│ 🔢 仓位限制                                                 │
│                                                             │
│ 定义：限制单只股票或总持仓占资金的比例                      │
│ 例子：单票仓位30%，10万资金最多买3万元一只股票              │
│ 作用：分散风险，避免重仓一只股票                            │
│                                                             │
└───────────────────────────────────────────────────────────┘
```

### 5.3 智能提示（Tooltip）

**触发场景**：用户配置风控参数时，悬停显示提示

**示例**：

```
止损线滑块 (悬停时显示)
┌─────────────────────────────────────┐
│ 💡 止损建议                          │
├─────────────────────────────────────┤
│ • 5-8%：短线交易                     │
│ • 10-15%：中线波段（推荐）           │
│ • 20%+：长线持有                     │
│                                      │
│ 注意：止损线太紧容易频繁触发，       │
│      太松则保护作用有限              │
└─────────────────────────────────────┘
```

---

## 6. 响应式设计

### 6.1 桌面端（>1200px）

- 风控配置面板：3列模板卡片横排
- 风控影响卡片：5个小卡片横排
- K线图和权益曲线：并排显示

### 6.2 平板端（768px - 1200px）

- 风控配置面板：模板卡片2列显示
- 风控影响卡片：2-3个一排
- K线图和权益曲线：上下堆叠

### 6.3 移动端（<768px）

- 风控配置面板：模板卡片竖排显示
- 风控影响卡片：竖排列表
- K线图和权益曲线：全宽显示，可左右滑动

**移动端简化**：
- 自定义配置默认不显示（仅显示模板选择）
- 风控对比抽屉改为全屏展示
- 次日计划页面改为卡片列表

---

## 7. 数据流与状态管理

### 7.1 组件状态

```
BacktestPage (回测页面)
│
├─ riskConfig (风控配置)
│   ├─ template: 'balanced' | 'conservative' | 'aggressive' | 'custom'
│   ├─ stopLossPct: number | null
│   ├─ stopProfitPct: number | null
│   ├─ maxDrawdownPct: number | null
│   ├─ maxPositionPct: number
│   └─ maxTotalExposure: number
│
├─ backtestResult (回测结果)
│   ├─ results (原有指标)
│   ├─ risk_stats (新增：风控统计)
│   │   ├─ stop_loss_count
│   │   ├─ stop_profit_count
│   │   ├─ drawdown_protection_count
│   │   └─ rejected_orders_count
│   │
│   ├─ trades (交易记录，增加reason字段)
│   ├─ equity_curve (权益曲线)
│   └─ metadata.risk_events (风控事件列表)
│
└─ comparisonResult (对比结果，可选)
    ├─ withRisk (有风控的回测结果)
    └─ withoutRisk (无风控的回测结果)
```

### 7.2 API调用流程

```
用户操作：选择风控模板
    ↓
更新 riskConfig 状态
    ↓
点击"开始回测"
    ↓
POST /api/v1/backtest
    body: {
        symbol, strategy_id, dates, capital,
        risk_config: riskConfig  // 传入风控配置
    }
    ↓
后端返回：
    {
        results: { ...metrics, risk_stats },
        trades: [..., {reason: 'stop_loss'}],
        metadata: { risk_events: [...] }
    }
    ↓
更新 backtestResult 状态
    ↓
渲染：风控影响卡片、K线标注、交易记录
```

### 7.3 对比分析流程

```
用户操作：点击"查看详细对比"
    ↓
检查是否已有无风控的对比数据
    ↓
如果没有 → 自动发起第二次回测
    ↓
POST /api/v1/backtest
    body: {
        ...相同参数,
        risk_config: null  // 不传风控配置
    }
    ↓
将两次结果对比计算差异
    ↓
展示对比抽屉
```

---

## 8. 开发优先级与里程碑

### Phase 1: 核心功能（Week 1）

**目标**：风控基础功能可用

- [ ] 风控配置面板（模板选择）
- [ ] 风控影响卡片
- [ ] 交易记录表增加reason列
- [ ] API集成（传入risk_config，解析risk_stats）

**验收标准**：
- 用户可选择模板并查看回测结果
- 风控影响卡片正确展示统计数据
- 交易记录区分策略信号和风控触发

### Phase 2: 可视化增强（Week 2）

**目标**：让风控可见、易懂

- [ ] K线图风控事件标注
- [ ] 权益曲线对比（有/无风控双线）
- [ ] 风控对比分析抽屉
- [ ] 自定义配置面板

**验收标准**：
- K线图清晰标注止损/止盈点
- 权益曲线对比直观展示差异
- 对比抽屉展示详细事件明细

### Phase 3: 闭环集成（Week 3）

**目标**：打通回测→次日计划→提醒

- [ ] 次日计划页面风控建议
- [ ] 提醒设置集成风控价格
- [ ] 用户引导流程
- [ ] 帮助文档

**验收标准**：
- 次日计划自动计算止损/止盈价
- 提醒设置一键配置风控通知
- 新用户有引导流程

### Phase 4: 优化迭代（Week 4）

**目标**：完善细节，提升体验

- [ ] 移动端适配
- [ ] 性能优化（大数据量）
- [ ] 用户反馈收集与迭代
- [ ] A/B测试（模板使用率）

---

## 9. 成功指标（Metrics）

### 9.1 使用率指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 风控启用率 | >60% | 有多少回测使用了风控 |
| 模板使用分布 | 平衡型>50% | 验证推荐模板的有效性 |
| 对比分析查看率 | >40% | 用户对风控效果的好奇度 |

### 9.2 教育效果指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 帮助文档打开率 | >30% | 用户是否查看帮助 |
| 自定义配置使用率 | 10-20% | 进阶用户占比 |
| 模板切换次数 | 平均2次/回测 | 用户是否尝试不同配置 |

### 9.3 闭环转化指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 次日计划生成率 | >50% | 回测后是否生成计划 |
| 风控提醒设置率 | >30% | 是否设置止损/止盈提醒 |
| 完整闭环完成率 | >20% | 回测→计划→提醒→复盘 |

### 9.4 质量指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 风控配置错误率 | <5% | 参数验证是否充分 |
| 对比分析加载时长 | <2s | 第二次回测性能 |
| 移动端可用性得分 | >8/10 | 移动端体验 |

---

## 10. 风险与注意事项

### 10.1 用户理解风险

**风险**：用户可能不理解风控参数含义，乱设置导致回测失真

**缓解措施**：
1. 默认推荐"平衡型"模板
2. 每个参数有详细说明和建议值
3. 设置合理的参数范围限制（如止损不能>50%）
4. 通过对比分析教育用户

### 10.2 过度依赖风控

**风险**：用户以为设置了风控就万无一失，忽视策略本身质量

**缓解措施**：
1. 在风控配置处提示"风控是辅助，策略是核心"
2. 展示风控对比时强调"策略选择更重要"
3. 提供"策略体检"功能（后续P2）

### 10.3 参数过拟合

**风险**：用户通过调整风控参数让回测结果更好看，但实盘无效

**缓解措施**：
1. 提示"频繁调整参数可能导致过拟合"
2. 提供"参数稳健性测试"（后续P2）
3. 鼓励使用固定模板而非过度自定义

### 10.4 性能问题

**风险**：对比分析需要跑两次回测，可能耗时过长

**缓解措施**：
1. 第二次回测时使用缓存的股票数据
2. 对比分析异步加载，不阻塞主流程
3. 提供"稍后对比"选项

---

## 11. 后续优化方向

### P1: 风控预设场景

根据不同交易风格提供更多模板：
- 短线激进：止损5%、止盈10%、仓位50%
- 中线稳健：止损10%、止盈20%、仓位30%
- 长线价值：止损20%、止盈50%、仓位20%

### P2: 移动止损（Trailing Stop）

可视化展示：
- K线图上动态展示止损线如何随价格上移
- 权益曲线标注移动止损触发点

### P3: 风控影响归因分析

详细分解风控对收益的贡献：
```
总收益提升 +5.2%
├─ 止损避免亏损：+3.8%
├─ 止盈锁定收益：+1.6%
├─ 回撤保护：+1.2%
└─ 仓位控制：-1.4%（降低收益但控制风险）
```

### P4: 智能风控建议

基于回测结果，AI推荐最优风控配置：
```
💡 系统建议

根据该策略的历史表现，建议：
• 止损设置为 8%（过松会增加回撤）
• 止盈设置为 25%（该策略持股周期较长）
• 仓位限制 40%（策略胜率较高，可适当集中）
```

---

## 12. 附录

### 附录A：配色方案

| 元素 | 颜色 | 用途 |
|------|------|------|
| 策略买入 | #52c41a (绿色) | 正常信号 |
| 策略卖出 | #1890ff (蓝色) | 正常信号 |
| 止损卖出 | #fa8c16 (橙色) | 警告 |
| 止盈卖出 | #faad14 (金色) | 成功 |
| 回撤保护 | #f5222d (红色) | 危险 |
| 拒绝订单 | #d9d9d9 (灰色) | 中性 |

### 附录B：图标库

| 功能 | 图标 | 来源 |
|------|------|------|
| 风控 | 🛡️ | Unicode Emoji |
| 止损 | ⚠️ | Unicode Emoji |
| 止盈 | 💰 | Unicode Emoji |
| 回撤保护 | 🛑 | Unicode Emoji |
| 拒绝 | 🚫 | Unicode Emoji |
| 保守型 | 🛡️ | Unicode Emoji |
| 平衡型 | ⚖️ | Unicode Emoji |
| 激进型 | 🚀 | Unicode Emoji |

### 附录C：用户反馈收集

**内嵌问卷（风控对比抽屉底部）**：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💬 这个功能对你有帮助吗？

[ 很有帮助 ]  [ 一般 ]  [ 没帮助 ]

你最想要的风控功能是什么？
┌─────────────────────────────────────────┐
│                                           │
│ 请输入...                                 │
│                                           │
└─────────────────────────────────────────┘

[提交反馈]
```

---

**文档状态**: ✅ 前端设计完成
**下一步**: 等待后端风控管理器开发完成，启动前端开发
