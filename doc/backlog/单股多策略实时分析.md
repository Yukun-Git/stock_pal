# Backlog: 单股多策略实时分析功能

**创建日期**: 2025-11-18
**优先级**: Medium (中)
**预估工作量**: 3-5天
**状态**: Backlog
**标签**: `feature`, `strategy`, `analysis`, `real-time`

---

## 1. 需求概述

### 1.1 背景

当前系统主要聚焦于历史回测，帮助用户评估策略的历史表现。但用户真正需要做交易决策的是"现在"——当前这只股票是否接近买点或卖点？

**现状问题**:
- 用户需要自己逐个研究技术指标，门槛高
- 单一策略可能有盲区，判断不够全面
- 从"历史分析"到"实盘决策"缺少关键一环
- 不熟悉技术分析的新手难以做出有效决策

### 1.2 目标

对于用户选定的单只股票，使用系统中所有可用策略进行分析，给出每个策略对当前市场状态的判断（买入/卖出/观望），帮助用户快速做出交易决策。

**核心价值**:
- **降低决策门槛**: 一键查看多个策略的综合判断
- **提高决策质量**: 多策略交叉验证，发现策略间的分歧和共识
- **实用性强**: 弥补从"历史分析"到"实盘决策"的关键缺口

---

## 2. 用户故事

### US-1: 查看单股的多策略分析结果
**作为** 散户投资者
**我希望** 输入一只股票代码后，立即看到所有策略的当前信号
**以便** 快速判断这只股票当前是否有交易机会

**验收标准**:
- [ ] 用户输入股票代码（如 600000）
- [ ] 系统调用所有可用策略进行分析
- [ ] 展示每个策略的信号类型：买入🟢 / 卖出🔴 / 观望⚪
- [ ] 显示关键指标值（如 MACD DIFF、RSI值、KDJ值等）
- [ ] 明确标注数据截止时间（如：数据截止 2025-11-17 收盘）

### US-2: 理解策略信号的依据
**作为** 量化交易学习者
**我希望** 了解每个策略为什么给出这个信号
**以便** 学习技术分析方法，提升自己的判断能力

**验收标准**:
- [ ] 展示每个策略的关键技术指标值
- [ ] 提供策略说明链接（链接到策略文档）
- [ ] 可选：显示信号强度（如 ★★★☆☆）

### US-3: 查看综合建议
**作为** 决策者
**我希望** 看到所有策略的汇总结论
**以便** 快速理解多数策略的倾向

**验收标准**:
- [ ] 统计买入信号数量、卖出信号数量、观望数量
- [ ] 给出简单的综合建议（如："3个买入信号，1个卖出信号，建议关注"）
- [ ] 当策略分歧较大时，提示用户谨慎决策

---

## 3. 功能范围

### 3.1 MVP 功能（第一版）

**输入**:
- 股票代码（6位数字，如 600000）

**处理**:
- 获取该股票最新的历史数据（建议至少60个交易日，满足各指标计算需求）
- 计算所有技术指标（MA、EMA、MACD、KDJ、RSI、布林带等）
- 对每个策略执行 `generate_signals()` 方法
- 提取最后一个交易日的信号状态

**输出**:
- 策略分析表格：
  - 策略名称
  - 信号类型（买入/卖出/观望）
  - 关键指标值（如 MACD DIFF: +0.23, RSI: 52）
  - 数据时间戳
- 综合统计：
  - 买入信号数量
  - 卖出信号数量
  - 观望信号数量
  - 综合建议文本

**时效性说明**:
- 使用 AkShare 数据（通常 T+1，即昨日收盘后更新）
- UI 上明确标注"数据截止时间"，避免用户误解为实时数据

### 3.2 暂不包括（未来扩展）

- ❌ 批量股票扫描（一次分析多只股票）
- ❌ 信号提醒/订阅功能
- ❌ 自定义策略组合（选择关注哪些策略）
- ❌ 历史信号统计（过去30天信号准确率）
- ❌ "即将触发"的预判功能（如 MACD 快要金叉）

---

## 4. 技术要点

### 4.1 后端设计

**新增 API 端点**:
```
POST /api/v1/stocks/multi-strategy-analysis
```

**请求参数**:
- `symbol`: 股票代码（必填）
- `end_date`: 截止日期（可选，默认最新交易日）
- `lookback_days`: 回溯天数（可选，默认 120 天，用于计算指标）

**响应结构**:
```
{
  "symbol": "600000",
  "symbol_name": "浦发银行",
  "analysis_date": "2025-11-17",
  "strategies": [
    {
      "strategy_id": "macd_cross",
      "strategy_name": "MACD金叉",
      "signal": "buy",  // "buy" | "sell" | "hold"
      "indicators": {
        "macd_diff": 0.23,
        "macd_dea": 0.15,
        "macd_histogram": 0.08
      }
    },
    ...
  ],
  "summary": {
    "buy_count": 2,
    "sell_count": 1,
    "hold_count": 3,
    "recommendation": "谨慎关注，多数策略未触发明确信号"
  }
}
```

**核心逻辑**:
1. 调用 `data_service.get_stock_data(symbol, start_date, end_date)` 获取数据
2. 调用 `indicator_service` 计算所有技术指标
3. 遍历所有策略：
   - 调用策略的 `generate_signals(df, params)` 方法
   - 提取最后一行（最新交易日）的 `buy_signal` 和 `sell_signal`
   - 提取该策略相关的指标值
4. 汇总统计信号分布
5. 生成综合建议文本

**服务层复用**:
- 复用现有的 `DataService`、`IndicatorService`、`StrategyService`
- 新增 `MultiStrategyAnalysisService` 负责编排和汇总

### 4.2 前端设计

**新增页面/组件**:
- 页面路径：`/analysis` 或在现有页面添加新 Tab
- 组件：
  - `StockSearchInput`: 股票代码输入
  - `MultiStrategyAnalysisTable`: 策略分析结果表格
  - `AnalysisSummary`: 综合统计和建议

**表格展示**:
```
┌──────────────┬────────┬──────────────────┬────────┐
│ 策略         │ 信号   │ 关键指标         │ 说明   │
├──────────────┼────────┼──────────────────┼────────┤
│ MACD金叉     │ 🟢 买入 │ DIFF: +0.23      │ [详情] │
│ MA均线交叉   │ ⚪ 观望 │ MA5: 12.3, MA20: 12.1 │ [详情] │
│ KDJ交叉      │ 🔴 卖出 │ K: 85 (超买)     │ [详情] │
│ RSI反转      │ ⚪ 观望 │ RSI: 52 (中性)   │ [详情] │
│ 布林突破     │ 🟢 买入 │ 接近下轨         │ [详情] │
│ 早晨之星     │ ⚪ 观望 │ 无形态           │ [详情] │
└──────────────┴────────┴──────────────────┴────────┘

综合建议：2个买入信号，1个卖出信号，3个观望
数据截止：2025-11-17 收盘
```

**交互流程**:
1. 用户输入股票代码
2. 点击"分析"按钮
3. 调用后端 API
4. 显示加载动画
5. 渲染结果表格和综合建议

### 4.3 数据时效性处理

**问题**: AkShare 数据通常是 T+1（当天收盘后更新）

**解决方案**:
- 在 UI 上明确显示"数据截止时间"
- 添加提示文案："本分析基于历史数据，仅供参考，不构成投资建议"
- 如果当天数据未更新，使用最近一个有效交易日

---

## 5. 非功能需求

### 5.1 性能要求
- 单股分析响应时间 < 5 秒
- 支持并发请求（至少 10 个并发）

### 5.2 数据准确性
- 技术指标计算必须与回测引擎一致（复用相同代码）
- 信号判断必须与策略定义一致

### 5.3 用户体验
- 清晰的加载状态提示
- 数据时间戳明确可见
- 风险提示清晰展示

---

## 6. 未来扩展方向

### 6.1 批量股票扫描（优先级：High）
- 用户输入自选股列表（或上传 CSV）
- 一次性分析多只股票
- 筛选出当前有明确信号的股票

### 6.2 信号提醒与订阅（优先级：Medium）
- 用户订阅关注的股票
- 当触发买入/卖出信号时，推送通知（邮件/站内消息）
- 支持自定义提醒规则（如：至少2个策略同时买入才提醒）

### 6.3 自定义策略组合（优先级：Medium）
- 用户可选择关注哪些策略
- 保存自己的策略组合配置
- 只看选定策略的信号

### 6.4 历史信号统计（优先级：Low）
- 显示该股票过去 30/60 天各策略的信号历史
- 统计信号准确率（信号后 N 天的收益情况）
- 帮助用户评估策略在该股票上的有效性

### 6.5 "即将触发"预判（优先级：Low）
- 检测指标是否接近关键阈值
- 例如：MACD DIFF 接近 0，可能即将金叉
- 提示用户"潜在机会"

---

## 7. 依赖与风险

### 7.1 依赖项
- 现有的 `DataService`、`IndicatorService`、`StrategyService`
- AkShare 数据源稳定性

### 7.2 风险
- **数据时效性**: 用户可能误解为实时数据（需要明确提示）
- **策略分歧**: 不同策略给出相反信号时，用户可能困惑（需要合理引导）
- **法律风险**: 必须明确声明"不构成投资建议"

---

## 8. 验收标准

- [ ] 用户可以输入股票代码并获得分析结果
- [ ] 所有可用策略都参与分析（至少 6 个策略）
- [ ] 每个策略显示信号类型和关键指标值
- [ ] 数据时间明确标注
- [ ] 综合建议正确统计信号分布
- [ ] 响应时间 < 5 秒
- [ ] 单元测试覆盖率 > 80%
- [ ] 风险提示文案已添加

---

## 9. 相关文档

- 策略文档：`doc/strategy/`
- 现有策略列表：`backend/app/services/strategy_service.py`
- 指标计算逻辑：`backend/app/services/indicator_service.py`

---

**备注**: 此功能与现有的"回测"功能形成互补。回测用于评估策略历史表现，选出好策略；实时分析用选出的策略判断当前交易机会。
