# Backlog: 配置管理系统

## 功能概述

允许用户保存、管理和复用回测配置（策略组合 + 参数 + 风控规则），支持版本管理、导入导出、公开/私有切换等功能。这是连接个人使用和社区分享的桥梁。

## 核心价值

- **提升效率**：无需每次重新配置参数，一键加载历史配置
- **知识沉淀**：优质配置可以持续优化和迭代
- **分享基础**：为竞技场和市场提供标准化的配置格式
- **数据资产**：用户的配置成为可管理的数字资产

## 主要功能点

### 1. 配置保存与加载

**保存配置：**
- 配置名称（必填，唯一性校验）
- 配置描述（选填，支持Markdown）
- 策略组合（多个策略及其参数）
- 风控规则（止损、止盈、仓位控制等）
- 初始资金、手续费率等基础参数
- 标签（如"均线策略"、"震荡市"、"稳健型"）

**加载配置：**
- 从"我的配置"列表选择
- 一键应用到回测页面
- 支持预览配置详情（不立即应用）

**快速保存：**
- 在回测页面点击"保存当前配置"
- 自动生成配置名称（如"配置_20241114_001"）
- 可后续编辑完善

### 2. 配置管理

**配置列表：**
- 列表展示：名称、创建时间、最后使用时间、标签
- 排序：按创建时间/使用频率/收益率
- 筛选：按标签/公开状态/策略类型
- 搜索：按名称/描述关键词

**配置操作：**
- 编辑：修改名称、描述、参数
- 删除：软删除（可恢复）
- 克隆：基于现有配置创建副本
- 导出：JSON格式下载
- 导入：上传JSON文件恢复配置

**批量操作：**
- 批量删除
- 批量打标签
- 批量导出

### 3. 版本管理

**版本历史：**
- 每次编辑配置自动创建新版本
- 显示版本号、修改时间、修改说明
- 对比两个版本的差异（Diff视图）

**版本回滚：**
- 查看历史版本详情
- 一键恢复到指定版本
- 版本分支（从历史版本创建新配置）

**版本限制：**
- 免费用户：保留最近10个版本
- VIP用户：保留所有版本

### 4. 配置详情页

**基础信息：**
- 配置名称、描述、标签
- 创建者、创建时间、更新时间
- 使用次数、收藏次数（如果公开）

**配置内容：**
- 策略列表：展示每个策略的名称和参数
- 风控规则：展示止损、止盈、仓位等配置
- 参数表格：可视化展示所有参数

**历史表现（关联回测历史）：**
- 使用该配置的回测记录
- 平均收益率、胜率、最大回撤
- 在不同股票上的表现对比

**操作按钮：**
- 使用此配置（跳转回测页面并加载）
- 克隆此配置
- 编辑/删除（仅自己的配置）
- 收藏（他人的公开配置）

### 5. 公开/私有切换

**私有配置：**
- 仅自己可见
- 不出现在竞技场和市场
- 默认新建配置为私有

**公开配置：**
- 所有用户可见（只读）
- 可参与竞技场排名
- 可在市场出售
- 显示创建者信息

**公开前检查：**
- 至少运行过一次完整回测
- 配置名称和描述不为空
- 确认公开协议（不可撤回警告）

### 6. 配置模板

**官方模板：**
- 平台提供的经典配置（如"经典双均线"、"MACD金叉"）
- 新手可直接使用，降低学习门槛
- 标注"官方推荐"标签

**用户模板：**
- 高排名配置自动成为推荐模板
- 社区投票选出优质模板

### 7. 配置标签系统

**系统标签（自动）：**
- 策略类型：趋势跟踪、均值回归、突破、套利
- 风险等级：保守、稳健、激进
- 适用市场：牛市、熊市、震荡市
- 持仓周期：短线、中线、长线

**用户标签（手动）：**
- 自定义标签（如"我的最爱"、"实盘使用"）
- 支持多标签
- 标签颜色自定义

## 技术要点

### 数据库设计

```sql
-- 配置表
CREATE TABLE configurations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,

    -- 配置内容（JSON存储）
    strategies JSON NOT NULL,  -- 策略列表及参数
    risk_config JSON,          -- 风控配置
    basic_params JSON,         -- 初始资金、手续费等

    -- 元数据
    tags JSON,                 -- 标签数组
    is_public BOOLEAN DEFAULT FALSE,
    is_template BOOLEAN DEFAULT FALSE,

    -- 统计
    use_count INT DEFAULT 0,
    favorite_count INT DEFAULT 0,

    -- 状态
    status ENUM('active', 'deleted') DEFAULT 'active',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_is_public (is_public),
    INDEX idx_created_at (created_at),
    UNIQUE KEY uk_user_name (user_id, name, status)
);

-- 配置版本表
CREATE TABLE configuration_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_id BIGINT NOT NULL,
    version_number INT NOT NULL,

    -- 配置快照
    strategies JSON NOT NULL,
    risk_config JSON,
    basic_params JSON,

    -- 变更说明
    change_note TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (config_id) REFERENCES configurations(id) ON DELETE CASCADE,
    INDEX idx_config_id (config_id),
    UNIQUE KEY uk_config_version (config_id, version_number)
);

-- 配置收藏表
CREATE TABLE configuration_favorites (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    config_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (config_id) REFERENCES configurations(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_config (user_id, config_id),
    INDEX idx_user_id (user_id),
    INDEX idx_config_id (config_id)
);

-- 配置标签表
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL,
    type ENUM('system', 'user') DEFAULT 'user',
    color VARCHAR(20),  -- 标签颜色
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 配置-标签关联表
CREATE TABLE configuration_tags (
    config_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,

    PRIMARY KEY (config_id, tag_id),
    FOREIGN KEY (config_id) REFERENCES configurations(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

### API设计

```
# 配置CRUD
POST   /api/v1/configs                    # 创建配置
GET    /api/v1/configs                    # 获取配置列表（我的/公开）
GET    /api/v1/configs/:id                # 获取配置详情
PUT    /api/v1/configs/:id                # 更新配置
DELETE /api/v1/configs/:id                # 删除配置
POST   /api/v1/configs/:id/clone          # 克隆配置

# 配置操作
POST   /api/v1/configs/:id/publish        # 公开配置
POST   /api/v1/configs/:id/unpublish      # 取消公开
POST   /api/v1/configs/:id/favorite       # 收藏配置
DELETE /api/v1/configs/:id/favorite       # 取消收藏
POST   /api/v1/configs/:id/use            # 记录使用（更新last_used_at）

# 版本管理
GET    /api/v1/configs/:id/versions       # 获取版本历史
GET    /api/v1/configs/:id/versions/:vid  # 获取指定版本详情
POST   /api/v1/configs/:id/versions/:vid/restore  # 恢复到指定版本

# 导入导出
GET    /api/v1/configs/:id/export         # 导出配置（JSON下载）
POST   /api/v1/configs/import             # 导入配置（上传JSON）

# 标签管理
GET    /api/v1/tags                       # 获取标签列表
POST   /api/v1/tags                       # 创建标签
PUT    /api/v1/configs/:id/tags           # 更新配置标签

# 模板
GET    /api/v1/configs/templates          # 获取官方模板
GET    /api/v1/configs/recommended        # 获取推荐配置（高排名）
```

### 前端实现

**页面结构：**
- `/configs` - 我的配置列表
- `/configs/:id` - 配置详情页
- `/configs/:id/edit` - 编辑配置
- `/configs/public` - 公开配置广场
- `/configs/templates` - 配置模板

**核心组件：**
- `ConfigList` - 配置列表（支持筛选、排序）
- `ConfigCard` - 配置卡片
- `ConfigForm` - 配置编辑表单
- `ConfigViewer` - 配置查看器
- `VersionHistory` - 版本历史
- `TagSelector` - 标签选择器

### 配置JSON格式示例

```json
{
  "name": "稳健双均线策略",
  "description": "适用于震荡市，控制回撤",
  "strategies": [
    {
      "strategy_id": "ma_cross",
      "params": {
        "short_period": 5,
        "long_period": 20
      }
    }
  ],
  "risk_config": {
    "stop_loss": 0.05,
    "take_profit": 0.15,
    "max_position_ratio": 0.3,
    "max_single_loss": 0.02
  },
  "basic_params": {
    "initial_capital": 100000,
    "commission_rate": 0.0003
  },
  "tags": ["均线策略", "稳健型", "震荡市"]
}
```

## 优先级

**P0（必须）：**
- 配置保存/加载
- 配置列表展示
- 配置详情查看
- 配置编辑/删除

**P1（重要）：**
- 配置克隆
- 标签系统
- 导入/导出
- 公开/私有切换
- 收藏功能

**P2（可选）：**
- 版本管理
- 批量操作
- 官方模板
- 配置对比（Diff）

## 依赖关系

**前置依赖：**
- 用户账户系统（需要user_id）

**后置依赖：**
- 竞技场系统（使用公开配置）
- 配置市场（交易配置）
- 回测历史（关联配置）

## 风险与挑战

1. **数据一致性**：
   - 策略参数结构变更后，历史配置如何兼容？
   - 解决方案：配置schema版本管理，自动迁移

2. **存储成本**：
   - 版本历史可能导致数据膨胀
   - 解决方案：限制版本数量，压缩JSON存储

3. **配置质量**：
   - 如何防止用户公开低质量配置？
   - 解决方案：公开前需通过基础回测验证

## 成功指标

- 平均每用户保存配置数 > 3
- 配置复用率（加载配置次数/回测次数）> 60%
- 公开配置占比 > 20%
- 模板使用率（新用户）> 50%

## 参考案例

- TradingView：Pine脚本保存和分享
- 聚宽：策略研究模块
- Notion：文档版本管理
