# Backlog: 自选股管理系统

## 功能概述

建立完整的自选股管理系统，让散户用户可以便捷地收藏关注的股票，通过分组管理、快速回测、实时行情监控等功能，提升用户的投资决策效率。自选股作为散户最常用的基础功能，将显著提升用户粘性和系统易用性。

## 核心价值

- **提升效率**：避免重复输入股票代码，一键快速发起回测
- **聚焦关注**：集中管理感兴趣的股票，形成个人投资池
- **分类管理**：通过分组功能实现板块轮动、风格分类等策略
- **决策支持**：结合实时行情和技术指标，辅助买卖时机判断
- **用户粘性**：作为用户每日访问的起点页面，提高使用频率

## 主要功能点

### 1. 自选股基础管理

**添加自选股：**
- 从股票搜索结果页一键添加
- 在回测页面直接添加当前股票
- 批量导入（支持粘贴股票代码列表）
- 添加时支持选择分组
- 重复添加时提示已存在

**查看自选股列表：**
- 表格形式展示，包含：
  - 股票代码、股票名称
  - 所属分组
  - 当前价格、今日涨跌幅（实时行情）
  - 添加时间
- 支持按分组筛选
- 支持按涨跌幅、添加时间排序
- 支持模糊搜索过滤

**删除自选股：**
- 单个删除（确认提示）
- 批量删除（多选后批量操作）
- 删除时可选是否同时删除该股票的回测历史

**编辑自选股：**
- 修改股票所属分组
- 添加个人备注（如"突破平台"、"等待回调"等）
- 设置价格提醒（可选，未来扩展）

### 2. 分组管理

**创建分组：**
- 自定义分组名称（如"科技板块"、"价值投资"、"短线机会"）
- 设置分组颜色标签
- 设置分组排序
- 默认分组"未分类"（不可删除）

**管理分组：**
- 重命名分组
- 删除分组（分组内股票移至"未分类"）
- 调整分组顺序
- 查看每个分组的股票数量

**分组视图：**
- 按分组折叠/展开显示股票列表
- 分组卡片视图（显示分组内股票数、平均涨跌幅）
- 快速切换分组

### 3. 快速回测集成

**单股快速回测：**
- 在自选股列表每一行提供"回测"按钮
- 点击后跳转到回测页面，自动填充股票代码
- 保留用户上次使用的回测参数（策略、时间范围等）
- 回测完成后可快速返回自选股列表

**批量回测（未来扩展）：**
- 勾选多只股票，统一策略批量回测
- 生成批量回测报告，对比各股表现
- 筛选出最佳表现的股票

### 4. 实时行情展示

**基础行情数据：**
- 当前价格
- 今日涨跌幅（红涨绿跌）
- 成交量
- 换手率（可选）
- 市盈率（可选）

**数据更新机制：**
- 页面加载时获取最新行情
- 支持手动刷新按钮
- 交易时段自动定时刷新（每30秒/1分钟）
- 非交易时段显示上次收盘数据

**数据来源：**
- 继续使用AkShare获取实时行情数据
- 调用`ak.stock_zh_a_spot_em()`获取A股实时行情

### 5. 统计与分析

**整体统计：**
- 自选股总数
- 各分组股票数量分布
- 今日上涨/下跌股票数量
- 平均涨跌幅

**个股历史：**
- 显示该股票的历史回测次数
- 最近一次回测结果摘要（收益率、胜率）
- 快速查看历史回测记录

## 技术要点

### 后端实现

**技术栈：**
- Flask-RESTful（API层）
- SQLAlchemy（ORM）
- AkShare（实时行情数据源）
- Redis（缓存实时行情数据）

**数据库设计：**

```sql
-- 自选股分组表
CREATE TABLE watchlist_groups (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(50) NOT NULL,
    color VARCHAR(20),
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    UNIQUE KEY uk_user_group (user_id, name)
);

-- 自选股表
CREATE TABLE watchlist_stocks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    stock_code VARCHAR(20) NOT NULL,
    stock_name VARCHAR(50) NOT NULL,
    group_id BIGINT,
    note TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (group_id) REFERENCES watchlist_groups(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_group_id (group_id),
    UNIQUE KEY uk_user_stock (user_id, stock_code)
);
```

**API设计：**

```
# 自选股管理
GET    /api/v1/watchlist                    # 获取自选股列表
POST   /api/v1/watchlist                    # 添加自选股
DELETE /api/v1/watchlist/{id}               # 删除单个自选股
DELETE /api/v1/watchlist/batch              # 批量删除自选股
PUT    /api/v1/watchlist/{id}               # 更新自选股（修改分组、备注）
POST   /api/v1/watchlist/import             # 批量导入自选股

# 分组管理
GET    /api/v1/watchlist/groups             # 获取分组列表
POST   /api/v1/watchlist/groups             # 创建分组
PUT    /api/v1/watchlist/groups/{id}        # 更新分组
DELETE /api/v1/watchlist/groups/{id}        # 删除分组
PUT    /api/v1/watchlist/groups/reorder     # 调整分组顺序

# 实时行情
GET    /api/v1/watchlist/quotes             # 获取自选股实时行情（批量）
GET    /api/v1/watchlist/stats              # 获取自选股统计数据

# 快速回测
GET    /api/v1/watchlist/{id}/backtest-history  # 获取该股票的历史回测记录
```

**服务层设计：**

创建新的服务模块：
- `watchlist_service.py` - 自选股业务逻辑
- `quote_service.py` - 实时行情获取与缓存

**实时行情缓存策略：**
- 交易时段：Redis缓存30秒-1分钟
- 非交易时段：Redis缓存到当日收盘
- 批量获取优化：一次性获取所有自选股行情

### 前端实现

**页面结构：**
- `/watchlist` - 自选股主页（列表视图）
- `/watchlist/groups` - 分组管理页面
- `/watchlist/import` - 批量导入页面

**核心组件：**
- `WatchlistPage` - 自选股主页组件
- `WatchlistTable` - 自选股表格组件
  - 集成实时行情展示
  - 支持排序、筛选、搜索
  - 集成快速操作按钮（回测、删除）
- `GroupManager` - 分组管理组件
- `QuickBacktestButton` - 快速回测按钮组件
- `StockQuote` - 实时行情显示组件
- `BatchImportModal` - 批量导入弹窗

**状态管理：**
- 使用Context API或Zustand管理自选股列表状态
- 实时行情数据定时刷新机制
- 乐观更新（添加/删除时立即更新UI）

**交互设计：**
- 添加自选股成功后Toast提示
- 删除操作需二次确认
- 拖拽排序分组（可选）
- 分组折叠/展开动画
- 行情数据更新时的视觉反馈（闪烁效果）

**响应式设计：**
- 桌面端：表格视图，信息丰富
- 移动端：卡片视图，核心信息优先

## 优先级

**P0（必须）：**
- 自选股增删改查
- 分组创建和管理
- 股票列表展示（基本信息）
- 快速回测按钮跳转
- 用户账户关联（需要登录）

**P1（重要）：**
- 实时行情展示（价格、涨跌幅）
- 按分组筛选和排序
- 批量删除
- 搜索过滤
- 个人备注功能

**P2（可选）：**
- 批量导入
- 批量回测
- 统计分析看板
- 拖拽排序
- 价格提醒（需要后台任务）

## 依赖关系

**前置依赖：**
- **用户账户系统**（BL-003）- 必须完成用户登录认证
- 现有的股票搜索API（已实现）
- 现有的回测功能（已实现）

**后置依赖：**
- 可为"批量回测"功能提供股票池
- 可为"配置管理系统"提供目标股票列表
- 可为"持仓退出管理"提供监控股票列表

**并行开发建议：**
- 与用户账户系统协调，确保认证机制统一
- 与回测结果存储功能协调，关联自选股与回测历史

## 风险与挑战

1. **数据源稳定性**：
   - AkShare实时行情API可能存在延迟或限流
   - 需要设计降级策略（显示延迟数据、提示服务暂不可用）
   - 考虑备用数据源（如东方财富、新浪财经）

2. **性能问题**：
   - 用户自选股数量可能很多（100+）
   - 批量获取实时行情需要优化请求（分批、并发控制）
   - 前端渲染大量数据需要虚拟滚动优化

3. **用户体验**：
   - 非交易时段行情数据可能过时，需要清晰提示
   - 分组功能不宜过于复杂，避免增加用户学习成本
   - 需要引导新用户如何使用自选股功能

4. **数据一致性**：
   - 用户在多个设备同时操作时的数据同步问题
   - 删除分组时股票的归属处理

## 成功指标

- 用户自选股使用率 > 60%（注册用户中添加自选股的比例）
- 平均每用户自选股数量 > 10只
- 从自选股发起回测的比例 > 40%
- 自选股页面日均访问次数 > 5次/活跃用户
- 分组功能使用率 > 30%
- 实时行情加载时间 < 2秒（50只股票）

## 实施计划

### Phase 1: MVP（1周）
- 自选股基础CRUD（添加、删除、列表查看）
- 分组创建和管理
- 基础信息展示（代码、名称、添加时间）
- 快速回测按钮

### Phase 2: 行情集成（3-5天）
- 实时行情数据接入
- 行情缓存机制
- 定时刷新功能
- 交易时段判断

### Phase 3: 增强功能（3-5天）
- 搜索、排序、筛选
- 批量操作
- 个人备注
- 统计数据看板

## 参考案例

- **同花顺**：自选股功能完善，支持多维度排序和行情监控
- **雪球**：组合管理和自选股结合，社交化特色
- **东方财富**：自选股与资讯、研报深度整合
- **聚宽（JoinQuant）**：自选股与回测策略紧密集成
- **TradingView**：Watchlist功能简洁高效，实时更新流畅

## 后续扩展方向

1. **智能推荐**：基于用户回测历史推荐相似股票
2. **技术指标信号**：在自选股列表直接显示MA、MACD等指标状态
3. **行业板块联动**：查看自选股所属行业的整体表现
4. **消息提醒**：重要公告、财报发布等事件提醒
5. **跨市场支持**：未来支持港股、美股自选
