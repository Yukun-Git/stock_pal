# Backlog: 市场自适应配置

## 功能概述

市场自适应配置允许用户针对不同市场环境（牛市、熊市、震荡市）配置不同的策略组合和风控参数。系统自动识别当前市场状态，在回测和实盘中动态切换配置，实现"全天候策略"，大幅提升策略适应性和收益稳定性。

## 核心价值

- **提升适应性**：单一策略难以适应所有市场，动态切换是专业交易的标配
- **降低风险**：熊市自动收紧止损、降低仓位，避免重大亏损
- **提高收益**：牛市激进追涨，震荡市高抛低吸，最大化不同环境下的收益
- **真实交易逻辑**：符合成熟投资者的实际操作习惯
- **差异化竞争**：多数回测平台不支持此功能，形成技术壁垒

## 主要功能点

### 1. 市场状态识别

#### 1.1 自动识别算法

**基础算法（涨跌幅 + 波动率）：**

```python
def detect_market_state_basic(stock_data, window=20):
    """
    基于涨跌幅和波动率识别市场状态

    参数:
        stock_data: 股票历史数据
        window: 观察窗口（天数）

    返回:
        'bull' | 'bear' | 'range'
    """
    # 计算窗口期涨跌幅
    returns = (stock_data['close'].iloc[-1] / stock_data['close'].iloc[-window] - 1)

    # 计算年化波动率
    daily_returns = stock_data['close'].pct_change()
    volatility = daily_returns.std() * np.sqrt(252)

    # 判断逻辑
    if returns > 0.10 and volatility > 0.02:
        return 'bull', f'{returns:.1%}涨幅，高波动'
    elif returns < -0.10:
        return 'bear', f'{returns:.1%}跌幅'
    elif abs(returns) < 0.05 and volatility < 0.015:
        return 'range', '窄幅震荡'
    else:
        return 'range', '宽幅震荡'
```

**进阶算法（趋势强度 + 均线排列）：**

```python
def detect_market_state_advanced(stock_data):
    """
    基于多维度指标识别市场状态

    考虑因素:
        1. 均线排列（多头/空头）
        2. ADX趋势强度
        3. 涨跌幅
        4. 波动率
    """
    # 计算均线
    ma5 = stock_data['close'].rolling(5).mean()
    ma20 = stock_data['close'].rolling(20).mean()
    ma60 = stock_data['close'].rolling(60).mean()

    # 计算ADX（趋势强度）
    adx = calculate_adx(stock_data, period=14)

    # 计算涨跌幅
    returns_20 = stock_data['close'].pct_change(20).iloc[-1]

    # 判断逻辑
    current_ma5 = ma5.iloc[-1]
    current_ma20 = ma20.iloc[-1]
    current_ma60 = ma60.iloc[-1]
    current_adx = adx.iloc[-1]

    # 牛市特征：均线多头排列 + 趋势强劲
    if (current_ma5 > current_ma20 > current_ma60 and
        current_adx > 25 and
        returns_20 > 0.05):
        return 'bull', f'多头排列，ADX={current_adx:.1f}'

    # 熊市特征：均线空头排列
    elif (current_ma5 < current_ma20 < current_ma60 and
          returns_20 < -0.05):
        return 'bear', f'空头排列，{returns_20:.1%}跌幅'

    # 震荡市：趋势不明显
    elif current_adx < 20:
        return 'range', f'无明显趋势，ADX={current_adx:.1f}'

    else:
        return 'range', '市场不确定'
```

**机器学习算法（高级，可选）：**

```python
def train_market_classifier(historical_data):
    """
    使用机器学习训练市场状态分类器

    特征工程:
        - 涨跌幅（5/10/20/60日）
        - 波动率
        - ADX、RSI、MACD等技术指标
        - 成交量变化

    标注策略:
        - 人工标注历史典型牛熊震荡时期
        - 或根据收益率自动标注（>10%牛市，<-10%熊市）

    模型选择:
        - Random Forest
        - XGBoost
        - LSTM（时间序列）
    """
    # 特征提取
    features = extract_features(historical_data)

    # 标签生成（基于未来收益率）
    labels = generate_labels(historical_data)

    # 训练模型
    model = RandomForestClassifier(n_estimators=100)
    model.fit(features, labels)

    return model
```

#### 1.2 手动指定

**场景：**
- 用户基于宏观分析判断市场状态
- 短期事件驱动（如政策利好、黑天鹅）
- 对自动识别结果不满意

**功能：**
- 下拉菜单手动选择：牛市/熊市/震荡市
- 设置生效时间范围（如"2024-01-01至2024-03-31为牛市"）
- 覆盖自动识别结果

#### 1.3 识别参数配置

**可配置项：**
```json
{
  "detection_method": "advanced",  // basic | advanced | ml
  "observation_window": 20,  // 观察窗口（天）
  "update_frequency": 5,  // 每N天重新判断一次
  "thresholds": {
    "bull_return": 0.10,  // 牛市阈值：20日涨幅>10%
    "bear_return": -0.10,  // 熊市阈值：20日跌幅>10%
    "high_volatility": 0.02,  // 高波动阈值
    "adx_threshold": 25  // ADX趋势强度阈值
  }
}
```

### 2. 市场环境配置界面

#### 2.1 页面结构

**新增Tab页：**
```
回测配置页面：
┌───────────────────────────────────────────┐
│ [策略配置] [风控配置] [市场环境配置]      │
└───────────────────────────────────────────┘
```

**市场环境配置页布局：**

```
┌─────────────────────────────────────────────────┐
│ 市场自适应配置                                  │
│ ☑ 启用市场自适应（根据市场环境自动切换策略）    │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 市场状态识别设置                                │
│                                                 │
│ 识别模式：                                      │
│ ○ 自动识别（推荐）                              │
│ ● 手动指定                                      │
│                                                 │
│ 识别算法：[进阶算法 ▼]                         │
│ 观察窗口：[20] 天                               │
│ 更新频率：[5] 天                                │
│                                                 │
│ 当前市场状态：震荡市 🟡                        │
│ （基于最近20日数据判断，下次更新：3天后）      │
│                                                 │
│ [高级设置] [测试识别算法]                       │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 🐂 牛市配置                                     │
│ ├─ 策略组合 ─────────────────────────────────  │
│ │  ☑ 双均线突破（短期5日，长期20日）           │
│ │  ☑ MACD金叉（快线12，慢线26，信号线9）       │
│ │  ☐ KDJ超买（K>80卖出）                       │
│ │  [+ 添加策略]                                │
│ │                                               │
│ ├─ 风控参数 ─────────────────────────────────  │
│ │  止损：[-8%]  止盈：[+25%]                   │
│ │  最大仓位：[80%]                             │
│ │  单笔最大亏损：[3%]                          │
│ │                                               │
│ └─ 触发条件 ─────────────────────────────────  │
│    20日涨幅 > [10]% 且 ADX > [25]              │
│    [自定义条件]                                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 🐻 熊市配置                                     │
│ ├─ 策略组合 ─────────────────────────────────  │
│ │  ☑ 空仓策略（观望，不交易）                  │
│ │  ☐ 超跌反弹（RSI<20时小仓位抄底）            │
│ │  [+ 添加策略]                                │
│ │                                               │
│ ├─ 风控参数 ─────────────────────────────────  │
│ │  止损：[-3%] (严格)  止盈：[+8%]             │
│ │  最大仓位：[20%] (防守)                      │
│ │  单笔最大亏损：[1%]                          │
│ │                                               │
│ └─ 触发条件 ─────────────────────────────────  │
│    20日跌幅 > [10]% 或 空头排列                │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 📊 震荡市配置                                   │
│ ├─ 策略组合 ─────────────────────────────────  │
│ │  ☑ 布林带突破（周期20，标准差2）             │
│ │  ☑ RSI超买超卖（RSI>70卖，RSI<30买）        │
│ │  ☐ 网格交易（价格区间3-5%）                  │
│ │  [+ 添加策略]                                │
│ │                                               │
│ ├─ 风控参数 ─────────────────────────────────  │
│ │  止损：[-5%]  止盈：[+12%]                   │
│ │  最大仓位：[50%]                             │
│ │  单笔最大亏损：[2%]                          │
│ │                                               │
│ └─ 触发条件 ─────────────────────────────────  │
│    -5% < 20日涨跌幅 < 5% 且 ADX < [20]         │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [保存配置] [预览回测] [重置为默认配置]          │
└─────────────────────────────────────────────────┘
```

#### 2.2 交互体验

**配置模板：**
- 提供官方推荐配置模板（保守型/稳健型/激进型）
- 用户可基于模板快速配置

**参数联动：**
- 选择策略后，自动填充推荐参数
- 风控参数根据市场类型显示建议值

**实时预览：**
- 配置过程中显示预估收益和风险
- "测试识别算法"按钮：在历史数据上测试识别准确性

**保存为配置模板：**
- 用户可将当前市场配置保存为模板
- 其他配置快速应用

### 3. 回测引擎改造

#### 3.1 自适应回测流程

**改造前（静态策略）：**
```python
def run_backtest(stock_data, config):
    # 1. 计算指标
    indicators = calculate_indicators(stock_data, config.indicators)

    # 2. 生成信号（固定策略）
    signals = generate_signals(indicators, config.strategies)

    # 3. 模拟交易
    trades, equity = simulate_trading(signals, config.risk_config)

    return BacktestResult(trades, equity)
```

**改造后（自适应策略）：**
```python
def run_adaptive_backtest(stock_data, config):
    """
    支持市场自适应的回测引擎
    """
    trades = []
    equity_curve = []
    market_history = []  # 记录市场状态变化

    current_market = None
    active_config = None

    for i in range(config.start_index, len(stock_data)):
        current_date = stock_data.index[i]

        # 每隔N天重新判断市场状态
        if i % config.detection_config.update_frequency == 0:
            historical_window = stock_data.iloc[max(0, i-config.observation_window):i+1]

            # 识别市场状态
            new_market, reason = detect_market_state(
                historical_window,
                method=config.detection_config.method
            )

            # 市场状态发生变化
            if new_market != current_market:
                logger.info(f"[{current_date}] Market switched: {current_market} -> {new_market} ({reason})")

                current_market = new_market
                market_history.append({
                    'date': current_date,
                    'market': new_market,
                    'reason': reason
                })

                # 切换到对应的配置
                if new_market == 'bull':
                    active_config = config.bull_config
                elif new_market == 'bear':
                    active_config = config.bear_config
                else:
                    active_config = config.range_config

                # 记录切换事件
                trades.append({
                    'type': 'MARKET_SWITCH',
                    'date': current_date,
                    'from': current_market,
                    'to': new_market
                })

        # 使用当前市场对应的策略生成信号
        current_data = stock_data.iloc[:i+1]
        signals = generate_signals(current_data, active_config.strategies)

        # 执行交易（使用对应的风控参数）
        if signals['buy_signal'].iloc[-1]:
            execute_buy(current_data, active_config.risk_config, trades, equity_curve)
        elif signals['sell_signal'].iloc[-1]:
            execute_sell(current_data, active_config.risk_config, trades, equity_curve)

        # 更新权益
        update_equity(current_data, position, equity_curve)

    # 计算性能指标
    metrics = calculate_metrics(equity_curve, trades)

    return BacktestResult(
        trades=trades,
        equity_curve=equity_curve,
        market_history=market_history,
        metrics=metrics
    )
```

#### 3.2 市场切换逻辑

**切换时机：**
- 定期检查（如每5个交易日）
- 避免频繁切换（增加交易成本）

**切换时的仓位处理：**
```python
def handle_market_switch(old_market, new_market, current_position):
    """
    市场切换时的仓位调整

    场景1: 牛市 -> 熊市
        如果持仓：立即清仓（止损）

    场景2: 熊市 -> 牛市
        如果空仓：等待新买入信号

    场景3: 震荡 -> 牛市
        如果持仓：继续持有，调整止盈点
    """
    if old_market == 'bull' and new_market == 'bear':
        # 牛转熊：立即清仓
        if current_position:
            return 'FORCE_SELL', '市场转熊，止损离场'

    elif old_market == 'bear' and new_market == 'bull':
        # 熊转牛：等待买入信号
        return 'WAIT_BUY', '市场转牛，准备入场'

    else:
        # 其他切换：调整风控参数，不强制平仓
        return 'ADJUST_RISK', '调整风控参数'
```

#### 3.3 性能优化

**数据预加载：**
- 一次性加载所有股票数据
- 避免重复计算指标

**并行计算：**
- 市场状态识别可以并行处理多只股票
- 使用多进程加速回测

**缓存机制：**
- 缓存市场状态识别结果（相同时间窗口）
- 缓存指标计算结果

### 4. 回测结果展示增强

#### 4.1 市场状态时间轴

**可视化展示：**
```
收益曲线图（新增背景色）：
  ┌────────────────────────────────────┐
  │ 收益率                              │
  │  30% ┼                              │
  │      │    🟢牛市      🔴熊市        │
  │  20% ┼───────┐    ┌─────────       │
  │      │ 🟡震荡│    │  🟡震荡        │
  │  10% ┼───────┴────┴────────────    │
  │      │                              │
  │   0% ┼──────────────────────────    │
  │      └──────────────────────────    │
  │      1月  3月  5月  7月  9月  11月 │
  └────────────────────────────────────┘

  背景色：
  - 牛市：浅绿色
  - 熊市：浅红色
  - 震荡：浅灰色

  切换点：竖线标记 + 标注
```

**市场状态统计：**
```
市场环境统计：
┌──────────────────────────────────┐
│ 牛市：120天 (33%)  收益：+18%    │
│ 熊市：90天  (25%)  收益：-2%     │
│ 震荡：150天 (42%)  收益：+8%     │
└──────────────────────────────────┘

市场切换记录：
┌──────────────────────────────────────────┐
│ 日期       │ 从     │ 到     │ 触发原因  │
│ 2023-03-15 │ 震荡   │ 牛市   │ 涨幅12%   │
│ 2023-07-20 │ 牛市   │ 熊市   │ 跌幅11%   │
│ 2023-10-10 │ 熊市   │ 震荡   │ 趋势转弱  │
└──────────────────────────────────────────┘
```

#### 4.2 对比分析

**固定策略 vs 自适应策略：**
```
对比结果：
┌────────────────────────────────────┐
│ 指标           │ 固定  │ 自适应    │
│ 总收益率       │ +15%  │ +24% ↑   │
│ 最大回撤       │ -18%  │ -8%  ↓   │
│ 夏普比率       │ 1.2   │ 1.8  ↑   │
│ 胜率           │ 55%   │ 62%  ↑   │
└────────────────────────────────────┘

自适应策略优势：
✓ 收益提升 60%
✓ 回撤减少 56%
✓ 在熊市成功防守，避免重大亏损
```

#### 4.3 市场状态详情

**点击时间轴查看详情：**
```
2023-03-15 ~ 2023-07-20 (牛市)
┌─────────────────────────────────────┐
│ 持续时间：127天                      │
│ 涨幅：+18.5%                         │
│ 使用策略：双均线 + MACD             │
│ 交易次数：8次                        │
│ 胜率：75%                            │
│ 最大单笔收益：+5.2%                 │
│ 风控参数：止损-8%，止盈+25%         │
│                                      │
│ 为什么判断为牛市：                   │
│ - 均线多头排列                       │
│ - ADX=32（强趋势）                  │
│ - 20日涨幅12.3%                     │
└─────────────────────────────────────┘
```

### 5. 高级功能

#### 5.1 市场预测（AI驱动）

**功能：**
- 基于历史数据和机器学习模型预测未来5-10天的市场状态
- 提前给出策略调整建议

**展示：**
```
AI市场预测：
┌────────────────────────────────────┐
│ 未来7天市场预测：震荡市 (置信度75%) │
│                                     │
│ 建议：                              │
│ - 当前牛市可能结束，注意止盈        │
│ - 考虑降低仓位至50%                 │
│ - 启用布林带策略应对震荡            │
└────────────────────────────────────┘
```

#### 5.2 用户自定义市场状态

**扩展市场类型：**
- 快牛（急涨）vs 慢牛（缓涨）
- 暴跌（崩盘）vs 阴跌（慢熊）
- 单边震荡 vs 宽幅震荡

**自定义判断条件：**
```
用户可创建新市场状态"快牛"：
条件：
- 10日涨幅 > 15%
- 连续5日阳线
- 成交量放大 > 50%

策略：
- 激进追涨
- 止损-10%（给予更大容忍）
- 止盈+40%
```

#### 5.3 实时监控与推送

**场景：**
- 用户关注某只股票
- 市场状态发生变化时推送通知

**推送内容：**
```
📢 市场状态变化提醒

股票：贵州茅台 (600519)
时间：2024-01-15 14:00

市场状态：震荡市 → 牛市
触发原因：10日涨幅12%，均线多头排列

建议操作：
- 切换至牛市配置
- 使用双均线策略
- 止损-8%，止盈+25%

[立即查看] [忽略提醒]
```

#### 5.4 市场状态回测验证

**功能：**
- 测试市场识别算法的准确性
- 在历史数据上验证判断是否正确

**展示：**
```
算法验证报告：
┌────────────────────────────────────┐
│ 测试周期：2020-01-01 ~ 2023-12-31 │
│ 总样本数：972天                    │
│                                     │
│ 识别准确率：78%                    │
│ - 牛市识别准确率：82%              │
│ - 熊市识别准确率：75%              │
│ - 震荡识别准确率：76%              │
│                                     │
│ 典型错误：                          │
│ - 2021-07: 误判熊市为震荡（2次）   │
│ - 2022-03: 未能及时识别牛市（延迟7天）│
└────────────────────────────────────┘
```

## 技术要点

### 数据库设计

```sql
-- 扩展configurations表，增加市场自适应配置
ALTER TABLE configurations
ADD COLUMN market_adaptive_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN detection_config JSON,
ADD COLUMN bull_market_config JSON,
ADD COLUMN bear_market_config JSON,
ADD COLUMN range_market_config JSON;

-- 配置JSON结构示例
/*
detection_config: {
  "mode": "auto",  // auto | manual
  "method": "advanced",  // basic | advanced | ml
  "observation_window": 20,
  "update_frequency": 5,
  "thresholds": {
    "bull_return": 0.10,
    "bear_return": -0.10,
    "high_volatility": 0.02,
    "adx_threshold": 25
  },
  "manual_overrides": [
    {"start_date": "2024-01-01", "end_date": "2024-03-31", "market": "bull"}
  ]
}

bull_market_config: {
  "strategies": [
    {"strategy_id": "ma_cross", "params": {"short": 5, "long": 20}},
    {"strategy_id": "macd_cross", "params": {"fast": 12, "slow": 26, "signal": 9}}
  ],
  "risk_config": {
    "stop_loss": 0.08,
    "take_profit": 0.25,
    "max_position_ratio": 0.8,
    "max_single_loss": 0.03
  },
  "trigger_conditions": {
    "return_threshold": 0.10,
    "adx_threshold": 25
  }
}

bear_market_config: {
  "strategies": [],  // 空仓策略
  "risk_config": {
    "stop_loss": 0.03,
    "take_profit": 0.08,
    "max_position_ratio": 0.2,
    "max_single_loss": 0.01
  }
}

range_market_config: {
  "strategies": [
    {"strategy_id": "bollinger", "params": {"period": 20, "std": 2}},
    {"strategy_id": "rsi", "params": {"period": 14, "overbought": 70, "oversold": 30}}
  ],
  "risk_config": {
    "stop_loss": 0.05,
    "take_profit": 0.12,
    "max_position_ratio": 0.5,
    "max_single_loss": 0.02
  }
}
*/

-- 市场状态历史记录表
CREATE TABLE market_state_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    symbol VARCHAR(20) NOT NULL,
    date DATE NOT NULL,
    market_state ENUM('bull', 'bear', 'range') NOT NULL,

    -- 识别依据
    detection_method VARCHAR(50),
    detection_reason TEXT,
    confidence DECIMAL(5, 4),  -- 置信度（ML模型）

    -- 关键指标
    return_20d DECIMAL(10, 4),
    volatility DECIMAL(10, 4),
    adx DECIMAL(10, 4),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_symbol_date (symbol, date),
    INDEX idx_market_state (market_state)
);

-- 市场切换事件表
CREATE TABLE market_switch_events (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    backtest_id BIGINT,
    symbol VARCHAR(20) NOT NULL,
    switch_date DATE NOT NULL,

    from_market ENUM('bull', 'bear', 'range'),
    to_market ENUM('bull', 'bear', 'range') NOT NULL,

    trigger_reason TEXT,

    -- 切换时的仓位操作
    position_action ENUM('HOLD', 'FORCE_SELL', 'WAIT_BUY', 'ADJUST_RISK'),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (backtest_id) REFERENCES backtest_results(id),
    INDEX idx_backtest_id (backtest_id),
    INDEX idx_symbol (symbol)
);
```

### API设计

```
# 市场状态识别
POST   /api/v1/market/detect             # 识别指定股票的当前市场状态
POST   /api/v1/market/batch-detect       # 批量识别多只股票
GET    /api/v1/market/history/:symbol    # 获取历史市场状态

# 市场自适应配置
POST   /api/v1/configs/:id/market-adaptive      # 保存市场自适应配置
GET    /api/v1/configs/:id/market-adaptive      # 获取配置
PUT    /api/v1/configs/:id/market-adaptive      # 更新配置

# 回测（支持自适应）
POST   /api/v1/backtest/adaptive         # 运行自适应回测
GET    /api/v1/backtest/:id/market-switches  # 获取市场切换记录

# 算法验证
POST   /api/v1/market/validate-algorithm # 验证识别算法准确性
GET    /api/v1/market/algorithm-performance  # 算法性能统计

# 配置模板
GET    /api/v1/market/templates          # 获取官方配置模板
POST   /api/v1/market/templates          # 保存自定义模板
```

### API详细设计

#### 1. 识别市场状态

**请求：**
```http
POST /api/v1/market/detect
Content-Type: application/json

{
  "symbol": "600519",
  "method": "advanced",  // basic | advanced | ml
  "observation_window": 20,
  "end_date": "2024-01-15"  // 可选，默认今天
}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "symbol": "600519",
    "market_state": "bull",
    "confidence": 0.85,
    "reason": "均线多头排列，ADX=32.5，20日涨幅12.3%",
    "indicators": {
      "return_20d": 0.123,
      "volatility": 0.025,
      "adx": 32.5,
      "ma5": 1850.2,
      "ma20": 1780.5,
      "ma60": 1720.8
    },
    "detected_at": "2024-01-15T14:30:00Z"
  }
}
```

#### 2. 保存市场自适应配置

**请求：**
```http
POST /api/v1/configs/:id/market-adaptive
Content-Type: application/json

{
  "enabled": true,
  "detection_config": {
    "mode": "auto",
    "method": "advanced",
    "observation_window": 20,
    "update_frequency": 5,
    "thresholds": {
      "bull_return": 0.10,
      "bear_return": -0.10,
      "adx_threshold": 25
    }
  },
  "bull_config": {
    "strategies": [
      {"strategy_id": "ma_cross", "params": {"short": 5, "long": 20}}
    ],
    "risk_config": {
      "stop_loss": 0.08,
      "take_profit": 0.25,
      "max_position_ratio": 0.8
    }
  },
  "bear_config": {
    "strategies": [],
    "risk_config": {
      "stop_loss": 0.03,
      "take_profit": 0.08,
      "max_position_ratio": 0.2
    }
  },
  "range_config": {
    "strategies": [
      {"strategy_id": "bollinger", "params": {"period": 20, "std": 2}}
    ],
    "risk_config": {
      "stop_loss": 0.05,
      "take_profit": 0.12,
      "max_position_ratio": 0.5
    }
  }
}
```

**响应：**
```json
{
  "code": 0,
  "message": "市场自适应配置保存成功",
  "data": {
    "config_id": 123
  }
}
```

#### 3. 运行自适应回测

**请求：**
```http
POST /api/v1/backtest/adaptive
Content-Type: application/json

{
  "symbol": "600519",
  "config_id": 123,
  "start_date": "2023-01-01",
  "end_date": "2023-12-31",
  "initial_capital": 100000,
  "commission_rate": 0.0003
}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "backtest_id": 456,
    "summary": {
      "total_return": 0.245,
      "max_drawdown": 0.082,
      "sharpe_ratio": 1.85,
      "win_rate": 0.62,
      "total_trades": 35
    },
    "market_statistics": {
      "bull_days": 120,
      "bear_days": 90,
      "range_days": 150,
      "switch_count": 8
    },
    "performance_by_market": {
      "bull": {"return": 0.18, "trades": 12, "win_rate": 0.75},
      "bear": {"return": -0.02, "trades": 5, "win_rate": 0.40},
      "range": {"return": 0.08, "trades": 18, "win_rate": 0.61}
    },
    "equity_curve": [...],
    "trades": [...],
    "market_switches": [
      {
        "date": "2023-03-15",
        "from": "range",
        "to": "bull",
        "reason": "20日涨幅12%, ADX>25"
      },
      ...
    ]
  }
}
```

### 前端实现

#### 核心组件

```typescript
// 市场自适应配置组件
interface MarketAdaptiveConfigProps {
  configId: number;
  onSave: (config: MarketAdaptiveConfig) => void;
}

const MarketAdaptiveConfig: React.FC<MarketAdaptiveConfigProps> = ({
  configId,
  onSave
}) => {
  const [enabled, setEnabled] = useState(false);
  const [detectionConfig, setDetectionConfig] = useState<DetectionConfig>({
    mode: 'auto',
    method: 'advanced',
    observationWindow: 20,
    updateFrequency: 5
  });

  const [bullConfig, setBullConfig] = useState<MarketConfig>({...});
  const [bearConfig, setBearConfig] = useState<MarketConfig>({...});
  const [rangeConfig, setRangeConfig] = useState<MarketConfig>({...});

  const handleSave = () => {
    onSave({
      enabled,
      detectionConfig,
      bullConfig,
      bearConfig,
      rangeConfig
    });
  };

  return (
    <div className="market-adaptive-config">
      <Switch checked={enabled} onChange={setEnabled}>
        启用市场自适应
      </Switch>

      <DetectionSettings
        config={detectionConfig}
        onChange={setDetectionConfig}
      />

      <Tabs>
        <TabPane tab="🐂 牛市配置" key="bull">
          <MarketConfigPanel
            config={bullConfig}
            onChange={setBullConfig}
            marketType="bull"
          />
        </TabPane>

        <TabPane tab="🐻 熊市配置" key="bear">
          <MarketConfigPanel
            config={bearConfig}
            onChange={setBearConfig}
            marketType="bear"
          />
        </TabPane>

        <TabPane tab="📊 震荡市配置" key="range">
          <MarketConfigPanel
            config={rangeConfig}
            onChange={setRangeConfig}
            marketType="range"
          />
        </TabPane>
      </Tabs>

      <Button type="primary" onClick={handleSave}>
        保存配置
      </Button>
    </div>
  );
};

// 回测结果展示（增强）
const AdaptiveBacktestResult: React.FC<{result: BacktestResult}> = ({result}) => {
  return (
    <div className="adaptive-backtest-result">
      {/* 收益曲线（带市场状态背景色） */}
      <EquityCurveWithMarketStates
        equityCurve={result.equity_curve}
        marketSwitches={result.market_switches}
      />

      {/* 市场状态统计 */}
      <MarketStatistics statistics={result.market_statistics} />

      {/* 分市场表现对比 */}
      <PerformanceByMarket data={result.performance_by_market} />

      {/* 市场切换时间轴 */}
      <MarketSwitchTimeline switches={result.market_switches} />

      {/* 固定策略 vs 自适应策略对比 */}
      <ComparisonChart
        fixedStrategy={result.fixed_strategy_comparison}
        adaptiveStrategy={result.adaptive_strategy_result}
      />
    </div>
  );
};
```

#### ECharts可视化

**收益曲线带市场状态背景：**
```typescript
const EquityCurveWithMarketStates = ({equityCurve, marketSwitches}) => {
  const option = {
    xAxis: {
      type: 'category',
      data: equityCurve.map(d => d.date)
    },
    yAxis: {
      type: 'value',
      axisLabel: {
        formatter: '{value}%'
      }
    },
    series: [
      {
        name: '收益率',
        type: 'line',
        data: equityCurve.map(d => d.return * 100),
        smooth: true
      }
    ],
    // 添加背景色区域
    visualMap: {
      show: false,
      dimension: 0,
      pieces: marketSwitches.map((sw, idx) => {
        const nextSwitch = marketSwitches[idx + 1];
        return {
          gt: getDateIndex(sw.date),
          lte: nextSwitch ? getDateIndex(nextSwitch.date) : equityCurve.length,
          color: sw.to === 'bull' ? '#e8f5e9' :
                 sw.to === 'bear' ? '#ffebee' : '#f5f5f5'
        };
      })
    },
    // 切换点标记
    markLine: {
      data: marketSwitches.map(sw => ({
        xAxis: sw.date,
        label: {
          formatter: `${sw.to}市`
        }
      }))
    }
  };

  return <ReactECharts option={option} />;
};
```

### 算法实现

#### ADX计算（趋势强度）

```python
def calculate_adx(stock_data, period=14):
    """
    计算ADX（平均趋向指数）

    ADX > 25: 强趋势
    ADX < 20: 无明显趋势（震荡）
    """
    high = stock_data['high']
    low = stock_data['low']
    close = stock_data['close']

    # 计算+DM和-DM
    plus_dm = high.diff()
    minus_dm = -low.diff()

    plus_dm[plus_dm < 0] = 0
    minus_dm[minus_dm < 0] = 0

    # 计算TR（真实波幅）
    tr1 = high - low
    tr2 = abs(high - close.shift())
    tr3 = abs(low - close.shift())
    tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)

    # 平滑+DM、-DM和TR
    atr = tr.rolling(period).mean()
    plus_di = 100 * (plus_dm.rolling(period).mean() / atr)
    minus_di = 100 * (minus_dm.rolling(period).mean() / atr)

    # 计算DX和ADX
    dx = 100 * abs(plus_di - minus_di) / (plus_di + minus_di)
    adx = dx.rolling(period).mean()

    return adx
```

## 优先级划分

### P0（MVP - 必须实现）

**时间：2周**

1. **基础市场识别算法**
   - 涨跌幅 + 波动率判断
   - 三种市场状态（牛/熊/震荡）
   - 手动指定模式

2. **配置界面**
   - 市场环境配置Tab
   - 三种市场的策略和风控配置
   - 保存/加载功能

3. **回测引擎改造**
   - 支持自适应回测
   - 市场状态检测逻辑
   - 策略切换机制

4. **基础结果展示**
   - 分市场统计
   - 市场切换记录表格

### P1（重要功能）

**时间：1-2周**

5. **进阶识别算法**
   - ADX趋势强度
   - 均线排列判断
   - 可配置阈值

6. **结果可视化增强**
   - 收益曲线带市场状态背景色
   - 市场切换时间轴
   - 对比分析（固定 vs 自适应）

7. **算法验证工具**
   - 测试识别准确性
   - 历史回测验证

8. **官方配置模板**
   - 保守/稳健/激进模板
   - 一键应用

### P2（高级功能）

**时间：2-3周**

9. **机器学习识别**
   - 训练分类模型
   - 特征工程
   - 模型部署

10. **AI市场预测**
    - 预测未来市场状态
    - 策略调整建议

11. **用户自定义市场**
    - 创建新市场类型
    - 自定义判断条件

12. **实时监控推送**
    - 监控关注股票
    - 市场切换提醒

## 依赖关系

### 前置依赖

1. **回测引擎**：需要现有回测功能正常运行
2. **策略配置系统**：需要能够配置多个策略组合
3. **风控配置系统**：需要能够设置止损止盈等参数
4. **技术指标库**：需要MA、ADX等指标计算功能

### 后置依赖

1. **配置管理系统**：市场自适应配置需要保存到配置表
2. **竞技场**：竞技场可以使用自适应配置
3. **AI优化**：可以优化市场识别算法参数

## 风险与挑战

### 1. 识别准确性

**风险：**
- 市场状态识别错误导致策略切换失误
- 滞后识别（如牛市已经过半才识别出）

**解决方案：**
- 提供多种识别算法，用户可选择
- 显示识别置信度
- 支持手动干预
- 历史回测验证算法准确性

### 2. 过度切换

**风险：**
- 市场在牛熊之间频繁切换
- 增加交易成本

**解决方案：**
- 设置最小持续时间（如必须持续5天）
- 切换确认机制（需连续2次判断一致）
- 可配置更新频率

### 3. 参数过拟合

**风险：**
- 用户针对历史数据调整阈值
- 未来表现差

**解决方案：**
- 提供样本外测试
- 警告用户避免过度优化
- 推荐使用默认参数

### 4. 用户理解成本

**风险：**
- 新手不理解市场自适应概念
- 配置复杂度增加

**解决方案：**
- 提供详细教程和示例
- 官方模板快速上手
- 默认关闭，高级用户开启

### 5. 计算性能

**风险：**
- 每N天重新识别市场，增加计算量
- 回测速度变慢

**解决方案：**
- 缓存市场状态识别结果
- 并行计算
- 预加载数据

## 成功指标

### 产品指标

- **功能使用率**：> 30% 的活跃用户启用市场自适应
- **配置保存率**：> 60% 的用户保存自适应配置
- **满意度**：用户评分 > 4.2/5.0

### 性能指标

- **收益提升**：平均收益率提升 > 20%（vs 固定策略）
- **回撤减少**：最大回撤平均减少 > 30%
- **夏普比率**：提升 > 25%
- **胜率提升**：> 5个百分点

### 技术指标

- **识别准确率**：> 75%
- **回测速度**：自适应回测时间 < 固定策略的1.5倍
- **API响应时间**：< 500ms

### 用户反馈

- **功能反馈**：收集用户意见，迭代优化
- **教程完成率**：> 50% 的新用户完成自适应配置教程
- **复购率**：使用自适应功能的用户VIP转化率提升 > 30%

## 参考案例

### 国内平台

1. **聚宽（JoinQuant）**
   - 支持自定义择时信号
   - 可根据市场状态调整仓位
   - 但没有完整的市场自适应配置体系

2. **优矿（Uqer）**
   - 提供市场情绪指标
   - 用户需自行编码实现自适应逻辑

### 国外平台

3. **QuantConnect**
   - Universe Selection（股票池动态调整）
   - 支持多策略切换
   - 但市场状态需用户手动判断

4. **TradeStation**
   - 支持策略网络（Strategy Network）
   - 可根据条件切换策略
   - 更偏向机构用户

### 传统投资策略

5. **美林时钟**
   - 经济周期四阶段：复苏/过热/滞胀/衰退
   - 不同阶段配置不同资产
   - 我们的简化版：牛/熊/震荡

6. **风险平价策略**
   - 根据波动率动态调整仓位
   - 波动率高时降低仓位
   - 可作为风控参数调整依据

## 实施计划

### 第1周：基础功能

- [ ] 数据库设计和迁移
- [ ] 基础市场识别算法实现
- [ ] 后端API开发（市场检测、配置保存）
- [ ] 回测引擎改造（支持自适应）

### 第2周：前端界面

- [ ] 市场环境配置Tab开发
- [ ] 三种市场配置面板
- [ ] 识别算法设置界面
- [ ] 保存/加载功能

### 第3周：结果展示

- [ ] 回测结果页面增强
- [ ] 市场状态时间轴
- [ ] 分市场统计展示
- [ ] 对比分析图表

### 第4周：测试与优化

- [ ] 功能测试（单元测试、集成测试）
- [ ] 性能优化（缓存、并行计算）
- [ ] 用户体验优化
- [ ] 文档和教程编写

### 第5-6周：高级功能（可选）

- [ ] 进阶识别算法（ADX、均线）
- [ ] 算法验证工具
- [ ] 官方配置模板
- [ ] AI市场预测（P2）

## 总结

市场自适应配置是一个**非常有价值且差异化**的功能，能够：

1. **显著提升策略表现**：收益提升20%+，回撤减少30%+
2. **符合真实交易逻辑**：专业投资者的标准操作
3. **降低风险**：熊市防守，避免重大亏损
4. **技术壁垒**：竞品少有完整实现
5. **用户粘性**：高级功能提升用户留存

**建议优先级：High（P0-P1功能2-3周完成）**

这个功能可以作为平台的**核心竞争力**之一，在产品宣传时重点突出。
