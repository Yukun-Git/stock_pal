# Backlog: 配置竞技场

## 功能概述

配置竞技场是一个公平的策略PK平台，所有公开配置在统一的股票池和时间窗口上运行回测，生成实时更新的排行榜。用户可以看到不同配置的表现对比，学习优质策略，并通过排名获得荣誉和奖励。

## 核心价值

- **公平竞争**：统一测试环境，真实反映策略优劣
- **学习平台**：新手可以学习高排名配置的思路
- **激励机制**：排名和奖励驱动用户优化策略
- **数据验证**：样本外测试，避免过拟合
- **社区活跃**：定期竞赛增强用户粘性

## 主要功能点

### 1. 竞技场赛道设计

**赛道分类：**
- **大盘股赛道**：沪深300成分股
- **中小盘赛道**：中证500成分股
- **科技股赛道**：科创板50/创业板50
- **行业赛道**：医药、金融、新能源等特定行业
- **全市场赛道**：随机抽取100只股票

**赛道属性：**
- 股票池（固定或动态更新）
- 测试时间窗口（如最近1年）
- 初始资金（统一10万）
- 手续费率（统一0.0003）
- 更新频率（每日/每周）

**赛道级别：**
- **新手场**：简单股票池，时间窗口短（3个月）
- **进阶场**：中等难度，6个月
- **高手场**：全市场，1年以上

### 2. 排行榜机制

**排名指标：**
- **主要指标**：综合得分（加权计算）
- **收益类**：总收益率、年化收益率、超额收益
- **风险类**：最大回撤、夏普比率、索提诺比率
- **稳定性**：胜率、盈亏比、波动率
- **交易类**：交易次数、换手率、平均持仓时间

**综合得分公式：**
```
综合得分 = 年化收益率 * 0.3
         + 夏普比率 * 0.25
         + (1 - 最大回撤) * 0.25
         + 胜率 * 0.2
```

**排行榜类型：**
- **总榜**：所有时间的累计排名
- **赛季榜**：当前赛季（如Q1、Q2）排名
- **周榜/月榜**：短期表现排名

**榜单展示：**
- Top 10 详细信息
- 11-50 简略信息（VIP可查看）
- 自己的排名和分数高亮显示

### 3. 竞赛机制

**定期竞赛：**
- **周赛**：每周一开始，周五结算
- **月赛**：每月1号开始，月底结算
- **赛季赛**：每季度一次大型竞赛

**竞赛规则：**
- 提交截止：赛前24小时
- 锁定配置：提交后不可修改
- 统一运行：后台自动执行所有配置的回测
- 结果公示：排行榜实时更新

**竞赛奖励：**
- **积分奖励**：
  - 第1名：1000积分
  - 第2-3名：500积分
  - 第4-10名：200积分
  - 参与奖：50积分

- **荣誉徽章**：
  - "周冠军"徽章（金色）
  - "月度之星"徽章（银色）
  - "赛季王者"徽章（钻石）

- **实物奖励**（可选）：
  - 季度Top 3：实体奖杯 + 礼品卡
  - 年度总冠军：高额奖金

### 4. 配置提交与参赛

**提交流程：**
1. 选择要参赛的配置（必须是公开配置）
2. 选择参加的赛道
3. 确认参赛协议（公平竞赛、不作弊）
4. 提交成功，获得参赛编号

**提交限制：**
- 每个赛道每个用户最多提交3个配置
- 配置必须至少运行过一次完整回测
- 免费用户：每周最多参加2个赛道
- VIP用户：无限制

**自动参赛：**
- 用户可设置"自动参赛"
- 每次竞赛自动提交指定配置
- 减少操作负担

### 5. 竞技场详情页

**赛道信息：**
- 赛道名称、类型、难度
- 股票池列表（可展开查看）
- 测试时间范围
- 当前参赛配置数量

**排行榜：**
- 表格展示：排名、配置名、创建者、各项指标
- 可按不同指标排序
- 点击配置名查看详情

**我的参赛记录：**
- 我提交的配置列表
- 每个配置的排名和得分
- 历史参赛记录

### 6. 配置对战（PK）

**1v1对战：**
- 选择两个配置（自己的 vs 他人的）
- 在同一股票、同一时间段运行回测
- 生成对比报告（收益曲线、各项指标对比）

**多人对战：**
- 选择3-5个配置
- 显示多条收益曲线对比图
- 雷达图展示多维度指标

**挑战赛：**
- 榜单前10的配置可以接受挑战
- 其他用户发起挑战
- 胜者获得额外积分

### 7. 实时监控与通知

**回测进度：**
- 竞赛开始后显示总体进度（如"已完成 30/100"）
- 预计完成时间

**排名变化通知：**
- 我的配置进入Top 10：推送通知
- 被超越/超越他人：实时提醒
- 竞赛结束：排名和奖励通知

**异常处理：**
- 配置运行失败：标注"运行失败"
- 数据缺失：跳过该股票
- 超时：限制单个回测最大运行时间（5分钟）

### 8. 防作弊机制

**策略审核：**
- 检测未来函数（使用未来数据）
- 检测异常收益（如收益率>1000%）
- 人工复核可疑配置

**提交限制：**
- 短时间内不可重复提交相同配置
- 检测批量注册小号刷榜

**举报机制：**
- 用户可举报作弊配置
- 管理员审核，确认后取消资格并扣除积分

## 技术要点

### 系统架构

**任务调度：**
- 使用 Celery + Redis 实现分布式任务队列
- 每个配置回测作为一个异步任务
- 支持任务优先级（VIP用户优先）

**性能优化：**
- 预加载股票数据（避免重复获取）
- 并行执行多个配置回测（Worker池）
- 结果缓存（Redis）

**数据库设计：**

```sql
-- 赛道表
CREATE TABLE arenas (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type ENUM('large_cap', 'mid_cap', 'tech', 'industry', 'full_market'),
    difficulty ENUM('beginner', 'intermediate', 'expert'),

    -- 股票池（JSON数组）
    stock_pool JSON NOT NULL,

    -- 测试参数
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    initial_capital DECIMAL(15, 2) DEFAULT 100000,
    commission_rate DECIMAL(6, 6) DEFAULT 0.0003,

    -- 更新频率
    update_frequency ENUM('daily', 'weekly', 'monthly'),
    last_run_at TIMESTAMP,
    next_run_at TIMESTAMP,

    -- 状态
    status ENUM('active', 'paused', 'archived') DEFAULT 'active',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_type (type),
    INDEX idx_status (status)
);

-- 竞赛表
CREATE TABLE competitions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    arena_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    type ENUM('weekly', 'monthly', 'seasonal', 'custom'),

    -- 竞赛时间
    registration_start TIMESTAMP NOT NULL,
    registration_end TIMESTAMP NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,

    -- 状态
    status ENUM('upcoming', 'registration', 'running', 'finished') DEFAULT 'upcoming',

    -- 参赛统计
    participant_count INT DEFAULT 0,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (arena_id) REFERENCES arenas(id),
    INDEX idx_arena_id (arena_id),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time)
);

-- 参赛记录表
CREATE TABLE arena_submissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    config_id BIGINT NOT NULL,

    -- 回测结果（JSON）
    backtest_result JSON,

    -- 排名和得分
    rank INT,
    score DECIMAL(10, 4),

    -- 各项指标
    total_return DECIMAL(10, 4),
    sharpe_ratio DECIMAL(10, 4),
    max_drawdown DECIMAL(10, 4),
    win_rate DECIMAL(10, 4),

    -- 状态
    status ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending',
    error_message TEXT,

    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,

    FOREIGN KEY (competition_id) REFERENCES competitions(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (config_id) REFERENCES configurations(id),

    UNIQUE KEY uk_comp_user_config (competition_id, user_id, config_id),
    INDEX idx_competition_id (competition_id),
    INDEX idx_user_id (user_id),
    INDEX idx_rank (rank)
);

-- 奖励记录表
CREATE TABLE arena_rewards (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    submission_id BIGINT NOT NULL,

    rank INT NOT NULL,
    reward_type ENUM('points', 'badge', 'physical'),
    reward_value VARCHAR(100),  -- 积分数量或徽章名称

    is_claimed BOOLEAN DEFAULT FALSE,
    claimed_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (competition_id) REFERENCES competitions(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (submission_id) REFERENCES arena_submissions(id),

    INDEX idx_user_id (user_id),
    INDEX idx_competition_id (competition_id)
);
```

### API设计

```
# 赛道
GET    /api/v1/arenas                     # 获取赛道列表
GET    /api/v1/arenas/:id                 # 获取赛道详情
GET    /api/v1/arenas/:id/leaderboard     # 获取排行榜
GET    /api/v1/arenas/:id/submissions     # 获取参赛配置列表

# 竞赛
GET    /api/v1/competitions               # 获取竞赛列表
GET    /api/v1/competitions/:id           # 获取竞赛详情
POST   /api/v1/competitions/:id/submit    # 提交参赛配置
GET    /api/v1/competitions/:id/my-submissions  # 我的参赛记录

# 对战
POST   /api/v1/arena/battle               # 发起配置对战
GET    /api/v1/arena/battle/:id           # 获取对战结果

# 奖励
GET    /api/v1/arena/rewards              # 获取我的奖励列表
POST   /api/v1/arena/rewards/:id/claim    # 领取奖励

# 管理（Admin）
POST   /api/v1/admin/arenas               # 创建赛道
PUT    /api/v1/admin/arenas/:id           # 更新赛道
POST   /api/v1/admin/competitions         # 创建竞赛
POST   /api/v1/admin/competitions/:id/run # 手动触发竞赛运行
```

### 后台任务设计

**Celery任务：**

```python
@celery.task
def run_arena_competition(competition_id):
    """运行竞赛，执行所有提交的配置回测"""
    submissions = get_submissions(competition_id)
    for submission in submissions:
        run_backtest_task.delay(submission.id)

@celery.task
def run_backtest_task(submission_id):
    """运行单个配置回测"""
    submission = get_submission(submission_id)
    try:
        result = execute_backtest(submission.config, arena.stock_pool, ...)
        save_result(submission_id, result)
        calculate_score(submission_id)
    except Exception as e:
        mark_failed(submission_id, str(e))

@celery.task
def update_leaderboard(competition_id):
    """更新排行榜"""
    submissions = get_completed_submissions(competition_id)
    submissions = sorted(submissions, key=lambda x: x.score, reverse=True)
    for i, sub in enumerate(submissions):
        update_rank(sub.id, i + 1)
```

**定时任务（Celery Beat）：**
- 每日更新赛道数据（凌晨2点）
- 每周一创建新的周赛
- 竞赛结束自动结算奖励

### 前端实现

**页面结构：**
- `/arena` - 竞技场首页（赛道列表）
- `/arena/:id` - 赛道详情 + 排行榜
- `/arena/:id/submit` - 提交配置
- `/competitions` - 竞赛列表
- `/competitions/:id` - 竞赛详情
- `/arena/battle` - 配置对战

**核心组件：**
- `ArenaCard` - 赛道卡片
- `Leaderboard` - 排行榜组件
- `SubmitConfig` - 提交配置表单
- `BattleComparison` - 对战对比图表
- `CompetitionBadge` - 竞赛徽章展示

**数据可视化：**
- 排行榜前10配置的收益曲线对比（ECharts多线图）
- 雷达图展示多维度指标对比
- 动态更新排名变化（WebSocket）

## 优先级

**P0（MVP）：**
- 单一赛道（如沪深300）
- 简化排行榜（仅收益率排序）
- 手动提交配置
- 手动触发竞赛运行

**P1（重要）：**
- 多赛道
- 综合得分算法
- 定期竞赛机制
- 奖励系统（积分 + 徽章）
- 自动任务调度

**P2（可选）：**
- 配置对战
- 实时排名通知
- 挑战赛
- 防作弊机制
- 实物奖励

## 依赖关系

**前置依赖：**
- 用户账户系统
- 配置管理系统
- 回测引擎（需支持批量运行）

**后置依赖：**
- 配置市场（高排名配置可出售）

## 风险与挑战

1. **性能瓶颈**：
   - 大量配置并发回测可能导致服务器过载
   - 解决方案：任务队列限流、扩展Worker数量

2. **数据公平性**：
   - 不同股票难度差异大，如何公平？
   - 解决方案：分赛道、标准化股票池

3. **过拟合问题**：
   - 用户针对测试股票池优化参数
   - 解决方案：定期更换股票池、样本外测试

4. **作弊风险**：
   - 使用未来函数、批量刷榜
   - 解决方案：代码审核、异常检测

## 成功指标

- 竞赛参与率（提交配置数/活跃用户数）> 30%
- 排行榜查看率（查看榜单次数/访问量）> 50%
- 用户留存：参与竞赛的用户7日留存 > 60%
- 配置优化：用户修改配置频率提升

## 参考案例

- Kaggle：数据科学竞赛平台
- LeetCode：算法竞赛排行榜
- 聚宽：量化策略社区榜单
