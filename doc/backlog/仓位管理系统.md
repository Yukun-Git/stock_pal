# Backlog: 仓位管理系统

## 功能概述

仓位管理系统允许用户配置多种专业的资金分配和加减仓策略，包括固定比例、金字塔加仓、凯利公式、ATR仓位管理等。系统在回测和实盘中根据配置自动计算每次交易的仓位大小，实现精细化的资金管理，提升收益稳定性，降低风险。

## 核心价值

- **提升收益稳定性**：科学的仓位管理比策略本身更重要，合理仓位可提升长期收益
- **控制风险**：单笔风险可控，避免重仓导致的爆仓
- **专业化**：提供华尔街级别的仓位管理方法（凯利公式、ATR等）
- **灵活性**：不同市场环境、不同策略可配置不同仓位方法
- **教育意义**：帮助散户学习专业的资金管理理念

## 主要功能点

### 1. 基础仓位管理方法

#### 1.1 固定比例建仓
- **描述**：每次买入使用总资金的固定百分比
- **配置参数**：
  - 仓位比例：10%-100%（如30%）
  - 是否使用可用资金还是总资金
- **适用场景**：简单直接，适合新手
- **示例**：账户10万，配置30%，每次买入3万元

#### 1.2 固定金额建仓
- **描述**：每次买入固定金额
- **配置参数**：
  - 固定金额：如10000元
- **适用场景**：小资金账户，严格控制单笔投入
- **示例**：无论账户多少，每次只买1万元

#### 1.3 固定手数建仓
- **描述**：每次买入固定股数
- **配置参数**：
  - 固定股数：如1000股
- **适用场景**：股价波动小的大盘蓝筹股
- **示例**：每次买入1000股，不论价格

### 2. 加减仓策略

#### 2.1 金字塔加仓
- **描述**：盈利后逐步加仓，每次加仓金额递减
- **配置参数**：
  - 初始仓位：如50%
  - 加仓次数：1-5次
  - 加仓比例递减：如50% → 30% → 20%
  - 加仓触发条件：盈利达到X%
- **适用场景**：趋势明确，盈利后加仓摊低成本
- **示例**：首次买入5万，盈利5%后加仓3万，再盈利5%加仓2万

#### 2.2 倒金字塔加仓
- **描述**：每次加仓金额递增
- **配置参数**：
  - 初始仓位：如20%
  - 加仓比例递增：如20% → 30% → 50%
  - 加仓触发条件
- **适用场景**：对信号极度自信
- **风险提示**：后期仓位重，回撤风险大

#### 2.3 等额加仓
- **描述**：每次加仓金额相同
- **配置参数**：
  - 单次仓位：如20%
  - 最大加仓次数：如5次
  - 加仓间隔：盈利X%或等待N天
- **适用场景**：均衡风险

#### 2.4 盈利加仓（反马丁格尔）
- **描述**：盈利时加仓，亏损时减仓或不加
- **配置参数**：
  - 盈利阈值：盈利>X%才加仓
  - 加仓比例：盈利越多，加仓越多
- **适用场景**：顺势而为，趋势跟踪
- **示例**：盈利5%加仓20%，盈利10%加仓30%

#### 2.5 马丁格尔加仓（高风险，可选）
- **描述**：亏损后加倍仓位，期望回本
- **配置参数**：
  - 亏损阈值：亏损>X%时加仓
  - 加仓倍数：1倍、2倍等
  - 最大加仓次数：限制风险
- **风险提示**：⚠️ 极高风险，可能爆仓，需明确警告用户

### 3. 动态仓位管理

#### 3.1 凯利公式
- **描述**：根据胜率和盈亏比计算数学最优仓位
- **公式**：`仓位 = (胜率 × 盈亏比 - (1 - 胜率)) / 盈亏比`
- **配置参数**：
  - 胜率：历史回测胜率或用户预估
  - 盈亏比：平均盈利/平均亏损
  - 凯利分数：全凯利(1)、半凯利(0.5)、1/4凯利(0.25)
  - 最大仓位限制：如不超过80%
- **适用场景**：有足够历史数据，追求长期最优
- **示例**：胜率60%，盈亏比2，全凯利仓位40%

#### 3.2 波动率调整仓位
- **描述**：根据股票波动率动态调整仓位，波动率高则仓位低
- **公式**：`仓位 = 目标风险 / 股票波动率`
- **配置参数**：
  - 目标风险：单笔风险百分比（如2%）
  - 波动率计算周期：20日、60日等
  - 波动率类型：标准差、ATR等
- **适用场景**：控制风险一致性
- **示例**：目标风险2%，股票波动率30%，仓位=6.67%

#### 3.3 ATR仓位管理
- **描述**：基于平均真实波幅（ATR）计算仓位
- **公式**：`可买股数 = 账户风险金额 / (ATR × 止损倍数)`
- **配置参数**：
  - ATR周期：14日、20日等
  - 止损倍数：2倍ATR、3倍ATR等
  - 单笔风险比例：如2%
- **适用场景**：专业交易者常用，适应市场波动
- **示例**：账户10万，风险2%（2000元），ATR=5元，止损2倍ATR，可买200股

### 4. 信号强度加权

#### 4.1 信号强度仓位
- **描述**：根据买入信号的强度决定仓位大小
- **配置参数**：
  - 单一信号仓位：如30%
  - 两个信号共振仓位：如50%
  - 三个及以上信号仓位：如70%
- **适用场景**：多策略组合，信号越强越重仓
- **示例**：只有MACD金叉买入30%，MACD+均线同时买入50%

#### 4.2 多因子评分仓位
- **描述**：综合多个因子打分，根据评分决定仓位
- **配置参数**：
  - 因子列表：技术指标强度、基本面评分等
  - 评分权重：各因子权重分配
  - 仓位映射：评分0-100对应仓位0-100%
- **适用场景**：量化选股，精细化仓位控制
- **示例**：综合评分80分，对应仓位80%

### 5. 资金曲线仓位管理

#### 5.1 盈利加仓，亏损减仓
- **描述**：根据账户盈亏状态动态调整仓位
- **配置参数**：
  - 基础仓位：如50%
  - 盈利加仓系数：账户盈利时仓位×1.2
  - 亏损减仓系数：账户亏损时仓位×0.5
  - 判断基准：相对初始资金或历史最高权益
- **适用场景**：顺势而为，盈利时放大收益
- **示例**：盈利时仓位60%，亏损时仓位25%

#### 5.2 回撤控制仓位
- **描述**：根据当前回撤幅度调整仓位
- **配置参数**：
  - 回撤阈值和对应仓位：
    - 回撤<5%：正常仓位
    - 回撤5-10%：减半仓位
    - 回撤>10%：空仓或极小仓位
- **适用场景**：保护资金，避免连续亏损
- **示例**：回撤8%时，仓位降至25%

### 6. 分批建仓策略

#### 6.1 时间分批
- **描述**：在N个交易日内分批买入
- **配置参数**：
  - 分批次数：2-10次
  - 时间间隔：每隔N天买入一次
  - 每批比例：等额或递减
- **适用场景**：降低择时风险，均摊成本
- **示例**：3天内每天买入1/3

#### 6.2 价格分批
- **描述**：设定价格区间，价格达到时分批买入
- **配置参数**：
  - 价格区间：如9-10元
  - 分批价格点：如10元、9.5元、9元
  - 每批比例：等额或递增
- **适用场景**：预判价格区间，逢低加仓
- **示例**：10元买1/3，9.5元买1/3，9元买1/3

#### 6.3 网格建仓
- **描述**：在价格网格上分批买卖
- **配置参数**：
  - 网格上限和下限
  - 网格间距：固定价差或百分比
  - 每格资金比例
- **适用场景**：震荡市，高抛低吸
- **示例**：9-11元区间，每0.5元一格，每格投入10%

### 7. 风险平价（高级）

#### 7.1 等风险仓位
- **描述**：每个持仓的风险贡献相同，仓位与波动率成反比
- **配置参数**：
  - 目标风险：整体组合风险目标
  - 波动率计算方法
  - 再平衡频率：多久调整一次仓位
- **适用场景**：多股票组合，平衡风险
- **示例**：波动率30%的股票仓位10%，波动率15%的股票仓位20%

### 8. 仓位管理与市场环境结合

#### 8.1 不同市场环境的仓位策略
- **牛市仓位管理**：
  - 建议：凯利公式、金字塔加仓
  - 最大仓位：可放宽至80%
  - 加仓积极
- **熊市仓位管理**：
  - 建议：固定小比例、回撤控制
  - 最大仓位：限制20%
  - 严格止损
- **震荡市仓位管理**：
  - 建议：网格建仓、分批建仓
  - 仓位：中等，50%左右
  - 高抛低吸

#### 8.2 不同策略的仓位匹配
- **趋势跟踪策略**：适合金字塔加仓、盈利加仓
- **均值回归策略**：适合分批建仓、网格交易
- **突破策略**：适合信号强度加权、ATR仓位管理

### 9. 仓位管理配置界面

#### 9.1 仓位管理Tab
- 在风控配置页面新增"仓位管理"Tab
- 选择仓位管理方法（下拉菜单）
- 根据选择显示对应参数配置表单

#### 9.2 配置模板
- 官方提供配置模板：
  - 保守型：固定比例20%，回撤控制
  - 稳健型：凯利公式（半凯利），波动率调整
  - 激进型：全凯利，金字塔加仓
- 用户可保存自定义模板

#### 9.3 仓位预览
- 配置过程中实时显示：
  - 首次建仓金额
  - 加仓次数和金额
  - 最大可能仓位
  - 风险提示

#### 9.4 参数建议
- 根据历史回测数据给出参数建议：
  - 凯利公式：自动计算胜率和盈亏比
  - ATR：显示当前ATR值
  - 波动率：显示近期波动率

### 10. 回测结果展示增强

#### 10.1 仓位变化曲线
- 展示回测期间仓位变化曲线
- 标注加减仓时点
- 显示每次交易的仓位大小

#### 10.2 仓位统计
- 平均仓位
- 最大仓位
- 最小仓位
- 仓位变化次数
- 满仓天数占比

#### 10.3 仓位与收益关系分析
- 不同仓位水平下的收益率分布
- 重仓交易 vs 轻仓交易的胜率对比
- 仓位对回撤的影响分析

#### 10.4 对比分析
- 对比不同仓位管理方法的表现：
  - 固定比例 vs 凯利公式
  - 金字塔加仓 vs 等额加仓
- 展示收益、回撤、夏普比率等指标对比

## 优先级划分

### P0（MVP - 必须实现）

**时间：1-2周**

1. **基础仓位管理**
   - 固定比例建仓
   - 固定金额建仓
   - 配置界面（基础）

2. **金字塔加仓**
   - 最经典的加仓方法
   - 配置参数和触发条件

3. **回测引擎改造**
   - 支持仓位管理配置
   - 计算每次交易仓位

4. **基础结果展示**
   - 仓位统计
   - 交易明细中显示仓位

### P1（重要功能）

**时间：1-2周**

5. **动态仓位管理**
   - 凯利公式
   - ATR仓位管理
   - 波动率调整

6. **分批建仓**
   - 时间分批
   - 价格分批

7. **信号强度加权**
   - 根据信号数量调整仓位

8. **配置模板**
   - 官方模板（保守/稳健/激进）
   - 参数建议功能

9. **结果展示增强**
   - 仓位变化曲线
   - 对比分析

### P2（高级功能）

**时间：2-3周**

10. **资金曲线仓位管理**
    - 盈利加仓、亏损减仓
    - 回撤控制仓位

11. **风险平价**
    - 等风险仓位分配

12. **多因子评分仓位**
    - 综合评分决定仓位

13. **网格建仓**
    - 价格网格策略

14. **马丁格尔加仓**
    - 高风险策略，需明确警告

15. **与市场环境结合**
    - 不同市场环境推荐不同仓位方法
    - 自动匹配

## 依赖关系

### 前置依赖

1. **回测引擎**：需要能够执行交易逻辑
2. **策略配置系统**：需要策略信号生成
3. **风控配置系统**：需要止损止盈等风控参数
4. **技术指标库**：需要ATR、波动率计算

### 后置依赖

1. **市场自适应配置**：可以为不同市场配置不同仓位管理
2. **配置管理系统**：仓位配置需要保存和管理
3. **竞技场**：竞技场可以比较不同仓位方法的表现
4. **AI优化**：AI可以优化仓位管理参数

### 协同关系

- **与市场自适应配置**：牛市用金字塔加仓，熊市用回撤控制
- **与风控配置**：仓位管理+止损止盈=完整风控体系
- **与策略配置**：不同策略匹配不同仓位方法

## 风险与挑战

### 1. 用户理解成本

**风险：**
- 专业术语多（凯利公式、ATR、风险平价）
- 新手不理解各方法的区别
- 配置复杂，容易出错

**解决方案：**
- 提供详细的帮助文档和示例
- 每个方法附带"适用场景"和"风险提示"
- 官方模板降低配置门槛
- 视频教程讲解

### 2. 参数估计不准确

**风险：**
- 凯利公式需要准确的胜率和盈亏比
- 用户可能过度乐观估计
- 导致仓位过重，风险失控

**解决方案：**
- 基于历史回测数据自动计算参数
- 提供保守估计选项（半凯利、1/4凯利）
- 设置最大仓位限制（如不超过80%）
- 明确警告：历史数据不代表未来

### 3. 过度优化

**风险：**
- 用户针对历史数据优化仓位参数
- 过拟合，实盘表现差

**解决方案：**
- 样本外测试
- 建议使用简单方法（固定比例、金字塔）
- 避免过于复杂的动态调整

### 4. 马丁格尔风险

**风险：**
- 马丁格尔加仓极易爆仓
- 用户可能不理解风险

**解决方案：**
- 明确标注"⚠️ 极高风险"
- 强制设置最大加仓次数
- 弹窗警告并要求确认
- 限制使用（如仅VIP或需通过风险测评）

### 5. 回测准确性

**风险：**
- 分批建仓、网格交易的回测实现复杂
- 可能与实盘偏差

**解决方案：**
- 详细记录每笔交易
- 考虑滑点和交易成本
- 提供回测日志供验证

## 成功指标

### 产品指标

- **功能使用率**：> 50% 的用户配置仓位管理
- **配置保存率**：> 70% 的用户保存仓位配置
- **高级方法使用率**：> 20% 的用户使用凯利公式、ATR等高级方法
- **用户满意度**：评分 > 4.3/5.0

### 性能指标

- **收益提升**：使用科学仓位管理后，平均夏普比率提升 > 15%
- **回撤控制**：回撤控制仓位有效降低最大回撤 > 20%
- **风险一致性**：波动率调整仓位使不同股票风险趋于一致

### 教育指标

- **教程完成率**：> 40% 的新用户完成仓位管理教程
- **模板使用率**：> 60% 的用户使用官方模板

## 参考案例

### 国内平台

1. **聚宽（JoinQuant）**
   - 支持order_target_value（目标金额）、order_percent（百分比）
   - 但没有系统化的仓位管理配置
   - 需要用户编程实现

2. **优矿（Uqer）**
   - 提供资金管理API
   - 同样需要编程

### 国外平台

3. **QuantConnect**
   - SetHoldings方法（按比例）
   - Portfolio Management模块
   - 更偏向机构

4. **TradeStation**
   - 内置多种仓位管理算法
   - 专业交易者使用

### 经典理论

5. **《海龟交易法则》**
   - ATR仓位管理的经典应用
   - 单元风险控制

6. **《股票大作手回忆录》**
   - 利弗莫尔的金字塔加仓法
   - 盈利后逐步加仓

7. **《战胜一切市场的人》**
   - 凯利公式的实际应用
   - 资金管理的重要性

### 风险平价

8. **桥水基金全天候策略**
   - 风险平价理念
   - 等风险贡献

## 实施建议

### 第1周：基础功能

- 固定比例、固定金额建仓
- 基础配置界面
- 回测引擎改造（支持仓位计算）

### 第2周：金字塔加仓

- 金字塔加仓逻辑实现
- 加仓参数配置
- 结果展示（仓位曲线）

### 第3周：动态仓位

- 凯利公式
- ATR仓位管理
- 波动率调整
- 参数自动计算

### 第4周：高级功能

- 分批建仓
- 信号强度加权
- 配置模板
- 对比分析

### 第5-6周：扩展功能（可选）

- 资金曲线仓位管理
- 风险平价
- 网格交易
- 与市场环境集成

## 总结

仓位管理系统是量化交易的**核心基础设施**，重要性不亚于策略本身。专业交易者常说：

> "新手关注策略，高手关注仓位，大师关注风控。"

通过提供完善的仓位管理工具，我们可以：
1. **提升平台专业度**：提供华尔街级别的资金管理工具
2. **帮助用户成长**：从关注策略到关注资金管理的进阶
3. **降低风险**：科学仓位管理避免爆仓
4. **提高收益稳定性**：长期复利增长

**建议优先级：High（与市场自适应配置同等重要）**

这两个功能结合后，用户可以实现：
- 不同市场环境 → 不同策略 → 不同仓位管理
- 形成完整的"全天候、全方位"交易系统

是平台的**核心差异化竞争力**。
