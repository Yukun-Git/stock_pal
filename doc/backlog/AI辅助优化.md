# Backlog: AI辅助优化

## 功能概述

AI辅助优化通过机器学习算法帮助用户自动寻找最优策略参数、诊断策略弱点、预测策略表现、生成个性化推荐。降低量化策略开发门槛，提升策略优化效率，让普通散户也能享受AI赋能。

## 核心价值

- **降低门槛**：新手无需深入了解参数含义，AI自动优化
- **提升效率**：替代人工试错，快速找到最优参数组合
- **发现盲点**：AI发现人类容易忽视的策略缺陷
- **个性化服务**：根据用户风险偏好定制策略
- **技术壁垒**：AI功能成为平台核心竞争力

## 主要功能点

### 1. 智能参数优化（遗传算法）

**问题场景：**
用户选择了"双均线策略"，但不知道短期均线和长期均线设置多少天最优。

**AI解决方案：**
使用遗传算法（Genetic Algorithm）在参数空间中搜索最优解。

**功能流程：**
1. 用户选择策略和股票
2. 设置优化目标：
   - 最大化收益率
   - 最大化夏普比率
   - 最小化最大回撤
   - 平衡收益与风险（多目标优化）
3. 设置参数搜索范围：
   - 短期均线：5-20天
   - 长期均线：20-60天
4. AI开始优化：
   - 初始化种群（随机生成N组参数）
   - 迭代进化（选择、交叉、变异）
   - 评估适应度（运行回测，计算目标函数）
   - 收敛后返回最优参数
5. 展示优化结果：
   - 最优参数组合
   - 优化前后性能对比
   - 参数对性能的影响曲线

**技术细节：**
- 使用DEAP库或自实现GA
- 种群大小：50-100
- 迭代次数：20-50代
- 适应度函数：可自定义（收益率、夏普比率等）
- 并行计算加速（多进程回测）

**高级功能：**
- **多策略联合优化**：同时优化多个策略的参数
- **约束优化**：限制最大回撤、胜率等条件
- **鲁棒性测试**：优化后的参数在不同股票上是否稳定

### 2. 策略弱点诊断

**问题场景：**
用户的策略在回测中表现不错，但不知道在什么市场环境下会失效。

**AI解决方案：**
通过机器学习分析策略在不同市场状态下的表现，识别弱点。

**功能流程：**
1. 用户提交配置
2. AI分析策略在历史不同市场环境下的表现：
   - 牛市（上涨趋势）
   - 熊市（下跌趋势）
   - 震荡市（横盘整理）
   - 高波动 vs 低波动
3. 生成诊断报告：
   - **擅长环境**：震荡市，胜率65%
   - **弱点环境**：单边下跌，最大回撤30%
   - **建议**：添加止损规则，或在熊市信号出现时减仓

**技术实现：**
- 市场状态分类：
  - 使用滑动窗口计算涨跌幅、波动率
  - K-Means聚类划分市场状态
- 策略表现分析：
  - 统计每种状态下的胜率、收益率、回撤
  - 识别显著差异

**可视化展示：**
- 雷达图：不同市场状态下的表现评分
- 时间轴：标注策略失效的时间段（红色区域）
- 热力图：参数对不同市场的敏感度

### 3. 策略智能推荐

**问题场景：**
新手不知道选择什么策略，或者想找到适合自己风险偏好的策略。

**AI解决方案：**
基于用户画像和协同过滤推荐策略。

**推荐维度：**
- **基于用户画像**：
  - 风险偏好（保守/稳健/激进）
  - 投资经验（新手/有经验/专家）
  - 历史行为（收藏、使用过的策略）
- **基于协同过滤**：
  - "和你相似的用户还喜欢..."
  - 相似度计算：余弦相似度、皮尔逊相关系数
- **基于内容**：
  - 策略特征提取（指标类型、参数范围、风险等级）
  - 匹配用户需求

**推荐结果：**
- Top 10 推荐策略
- 推荐理由："因为你是稳健型投资者，该策略回撤小于5%"
- 相似度评分

**冷启动问题：**
- 新用户：根据问卷调查初始化画像
- 新策略：使用基于内容的推荐

### 4. 预测策略未来表现

**问题场景：**
用户想知道策略在未来一个月的表现会如何。

**AI解决方案：**
使用时间序列预测模型预测策略收益曲线。

**技术方案：**
- **简单方法**：
  - 蒙特卡洛模拟：基于历史收益分布随机模拟未来走势
  - 展示置信区间（如90%概率下的收益范围）
- **复杂方法**：
  - LSTM预测股价走势
  - 在预测股价上运行策略，得到未来表现
  - 注意：仅供参考，不保证准确性

**风险提示：**
- 明确标注"AI预测，不构成投资建议"
- 展示预测误差范围
- 避免过度自信

### 5. 智能止损与止盈建议

**问题场景：**
用户不知道如何设置合理的止损止盈点。

**AI解决方案：**
根据历史回测数据，推荐最优止损止盈参数。

**分析方法：**
- 统计历史交易的盈亏分布
- 识别最优止损点（最大化收益/风险比）
- 推荐：
  - "建议止损：-5%"
  - "建议止盈：+15%"
  - "理由：历史数据显示，单笔亏损超过5%后反弹概率低于10%"

**动态调整：**
- 根据市场波动率动态调整止损位
- 牛市放宽止盈，熊市收紧止损

### 6. 策略组合优化（投资组合理论）

**问题场景：**
用户有多个策略，不知道如何分配资金比例。

**AI解决方案：**
使用现代投资组合理论（Markowitz模型）优化资金配置。

**功能流程：**
1. 用户选择3-5个策略
2. AI分析每个策略的：
   - 预期收益率
   - 收益波动率
   - 策略间相关性
3. 优化目标：
   - 最大化夏普比率
   - 给定收益下最小化风险
   - 给定风险下最大化收益
4. 输出最优配置：
   - 策略A：40%资金
   - 策略B：30%资金
   - 策略C：30%资金

**可视化：**
- 有效前沿曲线（风险-收益）
- 不同配置方案对比

### 7. 异常交易检测

**问题场景：**
策略在某些特殊情况下会产生异常交易（如频繁买卖、单笔巨亏）。

**AI解决方案：**
使用异常检测算法识别不合理交易。

**检测内容：**
- 单日交易次数异常（超过10次）
- 单笔亏损异常（超过平均值3倍）
- 持仓时间异常（持仓不到1天就卖出）

**技术方法：**
- 统计方法：3-sigma原则
- 机器学习：Isolation Forest、DBSCAN

**警告提示：**
- "检测到5笔异常交易，可能存在过度拟合"
- 建议用户检查策略逻辑

### 8. 自然语言策略生成（高级功能）

**问题场景：**
用户用自然语言描述策略，AI自动生成配置。

**示例输入：**
"我想要一个稳健的策略，当5日均线上穿20日均线时买入，MACD金叉时加仓，止损5%"

**AI处理：**
1. NLP解析用户意图：
   - 策略类型：双均线 + MACD
   - 参数：5日/20日均线
   - 风控：止损5%
2. 自动生成配置JSON
3. 返回配置，用户确认后保存

**技术难点：**
- NLP模型训练（需大量标注数据）
- 策略语法解析
- 歧义消解

**初期方案：**
- 提供模板化输入（下拉菜单 + 参数填空）
- 逐步过渡到自由文本输入

## 技术要点

### AI模型选型

| 功能 | 算法/模型 | 库/框架 |
|------|----------|---------|
| 参数优化 | 遗传算法、粒子群优化 | DEAP, PySwarm |
| 策略推荐 | 协同过滤、内容推荐 | Surprise, LightFM |
| 弱点诊断 | K-Means、决策树 | Scikit-learn |
| 预测 | LSTM、ARIMA | TensorFlow, Statsmodels |
| 异常检测 | Isolation Forest | Scikit-learn |
| NLP | BERT、GPT | Transformers |

### 系统架构

**离线训练：**
- 定期（每周）训练推荐模型
- 使用历史回测数据训练预测模型
- 模型版本管理

**在线推理：**
- API接收用户请求
- 调用模型进行推理
- 返回结果（实时响应 < 3秒）

**计算资源：**
- 参数优化需要大量计算（考虑GPU加速）
- 使用任务队列异步处理（Celery）
- 结果缓存（Redis）

### 数据库设计

```sql
-- AI优化任务表
CREATE TABLE ai_optimization_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    config_id BIGINT NOT NULL,
    task_type ENUM('param_optimization', 'weakness_diagnosis', 'prediction'),

    -- 输入参数
    input_params JSON NOT NULL,

    -- 输出结果
    result JSON,
    status ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending',
    error_message TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (config_id) REFERENCES configurations(id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);

-- AI推荐记录表
CREATE TABLE ai_recommendations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    recommended_configs JSON NOT NULL,  -- 推荐配置列表
    reason TEXT,  -- 推荐理由

    clicked_config_id BIGINT,  -- 用户点击了哪个推荐
    is_adopted BOOLEAN DEFAULT FALSE,  -- 是否采纳

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id)
);
```

### API设计

```
# 参数优化
POST   /api/v1/ai/optimize-params        # 启动参数优化任务
GET    /api/v1/ai/tasks/:id              # 查询任务状态
GET    /api/v1/ai/tasks/:id/result       # 获取优化结果

# 策略诊断
POST   /api/v1/ai/diagnose               # 诊断策略弱点
GET    /api/v1/ai/diagnose/:id/report    # 获取诊断报告

# 智能推荐
GET    /api/v1/ai/recommendations        # 获取推荐策略
POST   /api/v1/ai/recommendations/:id/feedback  # 反馈推荐结果

# 预测
POST   /api/v1/ai/predict                # 预测策略表现
GET    /api/v1/ai/predict/:id            # 获取预测结果

# 组合优化
POST   /api/v1/ai/portfolio-optimize     # 优化策略组合
GET    /api/v1/ai/portfolio-optimize/:id # 获取优化方案

# NLP（高级）
POST   /api/v1/ai/nl-to-config           # 自然语言转配置
```

### 前端实现

**页面结构：**
- `/ai/optimize` - AI参数优化页面
- `/ai/diagnose` - 策略诊断页面
- `/ai/recommendations` - AI推荐
- `/ai/predict` - 策略预测

**核心组件：**
- `ParamOptimizer` - 参数优化工具
- `DiagnosisReport` - 诊断报告展示
- `RecommendationCard` - 推荐卡片
- `PredictionChart` - 预测曲线图
- `PortfolioOptimizer` - 组合优化工具

**交互体验：**
- 优化过程展示进度条
- 实时显示当前迭代结果
- 动画展示参数收敛过程

## 优先级

**P0（MVP）：**
- 智能参数优化（遗传算法）
- 基础策略推荐（协同过滤）

**P1（重要）：**
- 策略弱点诊断
- 智能止损止盈建议
- 异常交易检测

**P2（可选）：**
- 策略组合优化
- 预测未来表现
- 自然语言策略生成

## 依赖关系

**前置依赖：**
- 用户账户系统
- 配置管理系统
- 大量历史回测数据（训练模型）

**后置依赖：**
- 无

## 风险与挑战

1. **计算成本**：
   - 参数优化计算量大
   - 解决方案：限制免费用户使用次数，VIP无限制

2. **模型准确性**：
   - 预测、推荐可能不准确
   - 解决方案：明确标注"仅供参考"，收集反馈持续优化

3. **过拟合风险**：
   - 优化后的参数可能过拟合历史数据
   - 解决方案：样本外验证、鲁棒性测试

4. **用户期望管理**：
   - 用户可能过度依赖AI
   - 解决方案：教育用户，AI是辅助工具而非万能

## 成功指标

- AI优化功能使用率 > 40%
- 优化后策略性能提升 > 15%（平均）
- 推荐点击率 > 30%
- 推荐采纳率 > 20%
- 用户满意度评分 > 4.0/5.0

## 参考案例

- 聚宽：参数优化、因子挖掘
- QuantConnect：Alpha组合优化
- TradingView：Pine脚本AI助手
- AutoML平台：自动化机器学习
