# AI智能分析回测结果

## 文档信息
- **功能名称**: AI智能分析回测结果
- **优先级**: 待定
- **状态**: 待规划
- **创建日期**: 2025-11-17
- **最后更新**: 2025-11-17

## 需求概述

在用户完成回测后，在结果展示页面添加"AI智能分析"按钮。用户点击后，系统将策略信息、参数配置、回测结果（收益率、胜率、最大回撤、交易次数等关键指标）整理后发送给大模型API（如阿里云千问、智谱GLM等），获取AI对该回测结果的智能点评和优化建议。

## 核心价值

### 用户价值
1. **降低理解门槛**: 帮助用户理解回测结果的真实意义和市场含义
2. **优化指引**: 提供具体可执行的参数优化方向建议
3. **风险提示**: 给出针对性的风险控制建议
4. **学习助手**: 帮助量化交易新手快速提升策略分析能力

### 产品价值
1. **差异化竞争**: 国内同类回测平台较少提供AI分析功能
2. **用户粘性**: 增加产品智能化程度，提升用户体验
3. **降低门槛**: 吸引更多非专业用户使用量化策略
4. **数据积累**: 收集用户常见问题，优化产品设计

## 功能需求

### 功能描述

#### 用户交互流程
1. 用户完成一次回测，查看回测结果
2. 在结果页面点击"AI智能分析"按钮
3. 系统显示加载状态（"AI正在分析中，请稍候..."）
4. 3-10秒后，展示AI分析结果

#### AI分析内容
AI分析应包含以下几个维度：

1. **策略表现评估**
   - 收益率水平评价（与市场基准对比）
   - 胜率和盈亏比分析
   - 交易频率合理性评估

2. **风险分析**
   - 最大回撤风险评估
   - 连续亏损风险提示
   - 波动率分析

3. **参数优化建议**
   - 哪些参数可能需要调整
   - 调整方向和理由
   - 建议的参数范围

4. **策略改进方向**
   - 策略的优势和劣势
   - 可能的改进思路
   - 适合的市场环境

### 输入数据

发送给AI的数据应包括：
```json
{
  "stock_info": {
    "symbol": "600000",
    "name": "浦发银行",
    "period": "2023-01-01 至 2024-12-31"
  },
  "strategy_info": {
    "name": "MACD金叉策略",
    "description": "当MACD金叉时买入，死叉时卖出"
  },
  "parameters": {
    "initial_capital": 100000,
    "commission_rate": 0.0003,
    "strategy_params": {
      "fast_period": 12,
      "slow_period": 26,
      "signal_period": 9
    }
  },
  "backtest_results": {
    "total_return": 0.25,
    "win_rate": 0.55,
    "max_drawdown": 0.18,
    "profit_factor": 1.8,
    "total_trades": 24,
    "winning_trades": 13,
    "losing_trades": 11
  }
}
```

### 输出格式

AI返回的分析结果建议采用结构化的Markdown格式，便于前端渲染：

```markdown
## 策略表现评估
您的MACD金叉策略在浦发银行(600000)上表现良好...

## 风险分析
最大回撤18%处于可接受范围...

## 参数优化建议
1. 建议适当调整快线周期...
2. 可以尝试增加止损条件...

## 改进方向
- 优势：胜率较高，适合震荡行情
- 劣势：在趋势行情中可能反应较慢
- 建议：可以考虑结合趋势过滤器...
```

## 技术方案要点

### 1. 后端架构

#### 新增服务模块
创建 `app/services/ai_analysis_service.py`：
- 负责调用大模型API
- 管理prompt模板
- 处理API响应和错误

#### 新增API接口
```
POST /api/v1/backtest/analyze
Request Body:
{
  "backtest_id": "xxx",  // 可选，如果有历史记录
  "backtest_data": {...}  // 回测结果数据
}

Response:
{
  "analysis": "AI分析结果（Markdown格式）",
  "tokens_used": 1234,
  "model": "qwen-plus",
  "analysis_time": 3.5
}
```

### 2. 大模型选型

推荐使用国内大模型API（考虑网络稳定性和合规性）：

| 服务商 | 模型 | 优势 | 定价参考 |
|--------|------|------|----------|
| 阿里云 | 通义千问-Plus | 稳定性好，响应快 | ¥0.004/千tokens |
| 智谱AI | GLM-4 | 推理能力强 | ¥0.01/千tokens |
| 讯飞 | 星火V3.5 | 中文理解好 | ¥0.006/千tokens |
| 百度 | 文心一言4.0 | 生态完善 | ¥0.012/千tokens |

**推荐方案**：优先使用阿里云通义千问-Plus（性价比高，稳定）

### 3. Prompt设计

设计关键的系统提示词：

```
你是一位专业的量化交易策略分析师，专门为散户投资者分析回测结果。

用户刚刚完成了一次股票回测，你需要：
1. 从专业角度评估策略表现
2. 用通俗易懂的语言解释关键指标
3. 给出具体可执行的优化建议
4. 提示潜在风险

请用结构化的Markdown格式回复，包含以下部分：
## 策略表现评估
## 风险分析
## 参数优化建议
## 改进方向

注意：
- 避免使用过于专业的术语
- 给出的建议要具体可执行
- 保持客观，既要指出优势也要指出不足
- 控制回复长度在500-800字
```

### 4. 前端实现

#### 新增组件
在 `frontend/src/pages/BacktestPage` 添加：
- "AI智能分析"按钮
- AI分析结果展示组件（支持Markdown渲染）
- 加载状态动画

#### UI/UX设计要点
- 按钮位置：放在回测结果的顶部或侧边
- 加载状态：显示进度条和预估时间
- 结果展示：使用卡片式布局，支持折叠展开
- 错误处理：API失败时友好提示

### 5. 配置管理

#### 环境变量配置
```env
# AI Analysis Service Config
AI_PROVIDER=aliyun  # aliyun, zhipu, xfyun, baidu
AI_API_KEY=your_api_key_here
AI_API_URL=https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
AI_MODEL=qwen-plus
AI_TIMEOUT=30  # 秒
AI_MAX_TOKENS=1000
```

#### 成本控制配置
```python
# 单用户调用限制
USER_DAILY_LIMIT = 10  # 每个用户每天最多10次
GLOBAL_DAILY_LIMIT = 1000  # 全局每天最多1000次

# 缓存策略
CACHE_ENABLED = True
CACHE_TTL = 3600  # 相同回测结果缓存1小时
```

## 实现建议

### 阶段划分

#### Phase 1: MVP（最小可行产品）
- 集成阿里云通义千问API
- 实现基础的分析功能
- 简单的前端展示
- 基础的错误处理

#### Phase 2: 优化增强
- 添加缓存机制，避免重复调用
- 实现用户调用次数限制
- 优化prompt，提升分析质量
- 改进前端交互体验

#### Phase 3: 高级功能
- 支持多模型切换
- AI分析历史记录
- 用户反馈机制（分析是否有帮助）
- 基于反馈持续优化prompt

### 技术细节

#### 1. API调用超时处理
```python
import requests
from requests.exceptions import Timeout

try:
    response = requests.post(
        api_url,
        json=payload,
        headers=headers,
        timeout=30  # 30秒超时
    )
except Timeout:
    return {"error": "AI分析超时，请稍后重试"}
```

#### 2. 错误重试机制
```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
def call_ai_api(data):
    # API调用逻辑
    pass
```

#### 3. 敏感信息过滤
在发送给AI之前，确保不包含：
- 用户的个人信息
- API密钥等敏感配置
- 只发送必要的回测数据

## 注意事项

### 安全性
1. **API密钥管理**
   - 通过环境变量配置，不要硬编码
   - 不要在前端暴露API密钥
   - 所有AI调用必须通过后端

2. **数据隐私**
   - 明确告知用户回测数据会发送给第三方AI服务
   - 提供"不使用AI分析"的选项
   - 不要发送用户个人信息

### 成本控制
1. **调用限制**
   - 设置用户每日调用次数上限
   - 实现全局调用次数监控
   - 考虑VIP用户可以有更高额度

2. **缓存策略**
   - 相同回测结果缓存分析
   - 设置合理的缓存过期时间
   - 使用Redis存储缓存

3. **降级方案**
   - 当API调用失败时，返回预设的通用建议
   - 监控API调用成功率
   - 设置每日成本预算，超出后降级

### 用户体验
1. **响应时间**
   - 设置合理的超时时间（30秒）
   - 显示实时的加载状态
   - 提供"取消分析"按钮

2. **结果展示**
   - 使用Markdown渲染，保持格式美观
   - 支持复制分析结果
   - 提供"重新分析"功能

3. **错误处理**
   - API失败时给出友好提示
   - 超时时建议用户稍后重试
   - 提供"联系客服"入口

### 质量保证
1. **Prompt优化**
   - 持续测试和优化prompt
   - 收集用户反馈
   - A/B测试不同的prompt版本

2. **结果验证**
   - 人工抽查AI分析质量
   - 避免AI给出错误或误导性建议
   - 设置内容过滤规则

## 依赖关系

### 前置需求
- 无特殊前置需求，可独立开发

### 相关功能
- 可与"回测结果存储与历史查询"功能结合
- 可与"配置管理系统"结合，分析不同配置的效果
- 可为"AI辅助优化"功能提供基础

## 成功指标

### 技术指标
- API调用成功率 > 95%
- 平均响应时间 < 5秒
- 用户日均调用次数 > 100次

### 业务指标
- 功能使用率 > 30%（有回测的用户中）
- 用户满意度 > 4.0/5.0
- 用户反馈"有帮助"比例 > 70%

### 成本指标
- 单次分析成本 < ¥0.01
- 月度AI调用总成本可控

## 风险评估

### 技术风险
- **风险**: AI API服务不稳定
- **缓解**: 实现降级方案，支持多个AI服务商

### 成本风险
- **风险**: 用户调用量超预期，成本失控
- **缓解**: 严格的调用次数限制，实时成本监控

### 质量风险
- **风险**: AI给出错误或误导性建议
- **缓解**: 人工审核prompt，添加免责声明

### 合规风险
- **风险**: 数据隐私问题
- **缓解**: 明确隐私政策，用户同意后使用

## 参考资料

### AI服务商文档
- 阿里云通义千问: https://help.aliyun.com/zh/dashscope/
- 智谱AI GLM: https://open.bigmodel.cn/dev/api
- 讯飞星火: https://www.xfyun.cn/doc/spark/Web.html

### 类似产品
- 国外: QuantConnect、Alpaca等平台的AI分析功能
- 国内: 部分量化平台开始探索AI辅助分析

## 更新日志

- 2025-11-17: 创建文档，定义初版需求
