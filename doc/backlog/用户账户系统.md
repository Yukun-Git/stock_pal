# Backlog: 用户账户系统

## 功能概述

建立完整的用户账户体系，支持用户注册、登录、个人信息管理等基础功能，为后续的配置保存、社区互动、交易等功能提供身份认证基础。

## 核心价值

- **用户粘性**：通过账户体系留存用户数据和使用历史
- **个性化服务**：基于用户画像提供定制化策略推荐
- **社区基础**：为竞技场、市场等社交功能提供身份基础
- **数据安全**：保护用户的策略配置和交易信息

## 主要功能点

### 1. 用户注册与登录

**注册方式：**
- 邮箱 + 密码注册
- 手机号 + 验证码注册
- 第三方登录（微信、支付宝，可选）

**登录方式：**
- 账号密码登录
- 手机验证码登录
- 记住登录状态（7天/30天）

**安全措施：**
- 密码强度校验（至少8位，包含数字和字母）
- 密码加密存储（bcrypt）
- 登录失败次数限制（5次锁定30分钟）
- JWT Token认证
- 刷新Token机制

### 2. 用户信息管理

**基础信息：**
- 用户名（唯一，可修改一次）
- 昵称（显示名称）
- 头像（上传或选择默认头像）
- 个人简介
- 注册时间

**投资偏好（可选）：**
- 风险偏好（保守/稳健/激进）
- 投资经验（新手/有经验/专家）
- 关注板块（科技/医药/金融等）
- 投资周期偏好（短线/中线/长线）

### 3. 账户安全

- 修改密码（需验证原密码）
- 找回密码（邮箱/手机验证码）
- 绑定/解绑手机号
- 绑定/解绑邮箱
- 登录设备管理（查看历史登录记录）
- 强制下线其他设备

### 4. 个人中心

**数据统计：**
- 注册天数
- 回测次数
- 保存的配置数量
- 参与的竞技场次数
- 获得的徽章/成就

**我的资产（虚拟）：**
- 积分余额（用于购买配置、参与竞赛）
- 我的配置列表
- 收藏的配置
- 购买的配置

**交易记录：**
- 配置购买记录
- 配置出售记录
- 积分获得/消费记录

## 技术要点

### 后端实现

**技术栈：**
- Flask-JWT-Extended（JWT认证）
- Flask-Bcrypt（密码加密）
- SQLAlchemy（ORM）
- Redis（Token黑名单、登录限流）
- Celery（发送验证邮件等异步任务）

**数据库设计：**

```sql
-- 用户表
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(500),
    bio TEXT,

    -- 投资偏好
    risk_preference ENUM('conservative', 'moderate', 'aggressive'),
    experience_level ENUM('beginner', 'intermediate', 'expert'),
    investment_horizon ENUM('short', 'medium', 'long'),

    -- 状态
    status ENUM('active', 'locked', 'deleted') DEFAULT 'active',
    points INT DEFAULT 0,  -- 积分

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,

    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_username (username)
);

-- 登录历史表
CREATE TABLE login_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    ip_address VARCHAR(50),
    user_agent TEXT,
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('success', 'failed') DEFAULT 'success',

    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_login_time (login_time)
);

-- Token黑名单（用于登出）
CREATE TABLE token_blacklist (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    jti VARCHAR(255) UNIQUE NOT NULL,  -- JWT ID
    user_id BIGINT NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_jti (jti),
    INDEX idx_expires_at (expires_at)
);
```

**API设计：**

```
POST   /api/v1/auth/register          # 注册
POST   /api/v1/auth/login             # 登录
POST   /api/v1/auth/logout            # 登出
POST   /api/v1/auth/refresh           # 刷新Token
POST   /api/v1/auth/forgot-password   # 找回密码
POST   /api/v1/auth/reset-password    # 重置密码

GET    /api/v1/users/me               # 获取当前用户信息
PUT    /api/v1/users/me               # 更新用户信息
PUT    /api/v1/users/me/password      # 修改密码
POST   /api/v1/users/me/avatar        # 上传头像

GET    /api/v1/users/me/login-history # 登录历史
DELETE /api/v1/users/me/sessions      # 强制下线其他设备

GET    /api/v1/users/me/stats         # 个人统计数据
```

### 前端实现

**页面结构：**
- `/login` - 登录页
- `/register` - 注册页
- `/forgot-password` - 找回密码
- `/profile` - 个人中心
- `/profile/settings` - 账户设置
- `/profile/security` - 安全设置

**状态管理：**
- 使用 Context API 或 Zustand 管理用户登录状态
- Token 存储在 localStorage/sessionStorage
- 全局路由守卫（未登录跳转登录页）

**组件设计：**
- `LoginForm` - 登录表单
- `RegisterForm` - 注册表单
- `UserAvatar` - 用户头像组件
- `PrivateRoute` - 需要登录的路由包装器

## 优先级

**P0（必须）：**
- 注册/登录（邮箱+密码）
- JWT认证
- 用户基础信息管理
- 修改密码

**P1（重要）：**
- 手机号注册/登录
- 找回密码
- 头像上传
- 登录历史

**P2（可选）：**
- 第三方登录
- 投资偏好设置
- 强制下线设备
- 登录失败锁定

## 依赖关系

**前置依赖：**
- 无（基础功能）

**后置依赖：**
- 配置管理系统需要用户ID关联配置
- 竞技场需要用户ID参与排名
- 配置市场需要用户ID进行交易
- 社交功能需要用户ID进行互动

## 风险与挑战

1. **安全风险**：
   - 需要防止SQL注入、XSS攻击
   - Token泄露风险
   - 暴力破解密码

2. **隐私合规**：
   - 需遵守《个人信息保护法》
   - 用户协议和隐私政策
   - 数据脱敏（如手机号显示）

3. **扩展性**：
   - 未来可能需要支持企业账户
   - 多角色权限管理（普通用户/VIP/管理员）

## 成功指标

- 注册转化率 > 30%
- 7日留存率 > 40%
- 平均登录频率 > 3次/周
- 密码找回成功率 > 95%
- 登录接口响应时间 < 200ms

## 参考案例

- 聚宽（JoinQuant）：量化平台的用户体系
- 雪球：社交投资平台的账户设计
- GitHub：技术社区的用户管理
