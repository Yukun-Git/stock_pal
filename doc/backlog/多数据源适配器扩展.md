# Backlog: 多数据源适配器扩展

**创建日期**: 2025-11-19
**优先级**: High (高)
**预估工作量**: 2-3周
**状态**: Backlog
**标签**: `feature`, `data-source`, `adapter`, `stability`, `redundancy`

---

## 1. 需求概述

### 1.1 背景

当前系统仅支持两个数据源适配器：
- **AkShare**: 中国A股市场数据（免费）
- **YFinance**: 全球市场数据（免费）

存在以下问题：
- **单点故障风险**: 某个数据源失效时，系统无法自动切换到备用源
- **覆盖面有限**: 仅两个数据源，对特定市场（如港股）的支持不够完善
- **可靠性不足**: 免费数据源可能存在限流、延迟、不稳定等问题
- **数据质量差异**: 不同数据源的数据质量可能不同，缺乏对比和验证机制

### 1.2 目标

扩展系统的数据源适配器，增加多个备选数据源，提升系统稳定性、可靠性和数据覆盖面：

1. **增加5-6个新的数据源适配器**
2. **实现自动故障转移机制**（主数据源失败时自动切换备用源）
3. **支持多市场覆盖**（A股、港股、美股、其他市场）
4. **提供数据源管理界面**（查看状态、优先级配置、健康检查）

---

## 2. 候选数据源清单

### 2.1 Free-Stock-API by iTick

**市场覆盖**: A股 + 港股 + 其他市场
**价格**: 免费版本提供
**官网**: GitHub
**特点**:
- 多市场支持（中国 + 香港 + 新加坡等）
- 提供 REST + WebSocket 接口
- "机构级客户"为主描述，免费版可能有额度/延迟问题

**优先级**: Medium（中）
**评估需求**: 需测试免费版的调用限制和实际稳定性

---

### 2.2 AllTick API

**市场覆盖**: A股 + 港股
**价格**: 免费 + 付费计划
**官网**: [blog.alltick.co](https://blog.alltick.co)
**特点**:
- 提供实时行情、高频数据
- 覆盖 A股/港股市场
- 免费版通常有调用限制

**优先级**: High（高）
**评估需求**: 测试免费版的配额和延迟

---

### 2.3 Infoway API

**市场覆盖**: A股（沪深）+ 港股
**价格**: 文档中支持免费访问（具体需确认）
**官网**: [docs.infoway.io](https://docs.infoway.io)
**特点**:
- 专门面向中国及香港市场
- 免费额度未明确，可能存在"试用"性质

**优先级**: Medium（中）
**评估需求**: 确认免费额度和访问限制

---

### 2.4 China Stock API (by MCPMarket)

**市场覆盖**: A股
**价格**: 免费（历史数据 + 实时数据）
**官网**: MCP Market
**特点**:
- 支持历史数据、技术指标
- 覆盖面广
- 免费版可能有延迟、稳定性未知

**优先级**: Medium（中）
**评估需求**: 测试实际延迟和稳定性

---

### 2.5 NowAPI Stock Realtime

**市场覆盖**: A股 + 港股 + 美股
**价格**: 免费测试（扣量/流量包机制）
**官网**: [nowapi.com](https://nowapi.com)
**特点**:
- 接口简单、支持多市场
- 免费测试存在"扣量""流量包"机制，可能非常受限

**优先级**: Low（低）
**评估需求**: 确认免费版的实际可用性

---

### 2.6 其他备选数据源

- **Tushare** (中国市场数据平台，需注册积分)
- **聚宽 JoinQuant** (量化平台，提供数据API)
- **东方财富 Choice** (付费为主，可能有限免费接口)
- **Baostock** (证券宝，免费A股数据)

---

## 3. 用户故事

### US-1: 自动故障转移

**作为** 量化交易者
**我希望** 当某个数据源失败时，系统自动切换到备用数据源
**以便** 我的回测和分析不会因单一数据源故障而中断

**验收标准**:
- [x] 主数据源请求失败时，自动尝试备用数据源
- [x] 支持配置数据源优先级列表
- [x] 自动重试机制（最多3次）
- [x] 记录故障日志，便于后续排查
- [x] 前端显示当前使用的数据源

---

### US-2: 数据源健康监控

**作为** 系统管理员
**我希望** 查看所有数据源的健康状态
**以便** 我可以及时发现和处理数据源问题

**验收标准**:
- [x] 提供数据源状态页面（在线/离线/限流/异常）
- [x] 显示每个数据源的响应时间、成功率
- [x] 支持手动健康检查
- [x] 数据源状态异常时发送告警（日志记录）

---

### US-3: 灵活配置数据源优先级

**作为** 高级用户
**我希望** 自定义数据源的使用优先级
**以便** 我可以优先使用更可靠或更适合我需求的数据源

**验收标准**:
- [x] 提供配置界面，调整数据源优先级
- [x] 支持启用/禁用特定数据源
- [x] 配置保存后立即生效
- [x] 支持按市场类型配置不同优先级（如A股优先用AkShare，港股优先用YFinance）

---

### US-4: 数据源对比与验证

**作为** 量化交易者
**我希望** 对比不同数据源的同一股票数据
**以便** 我可以验证数据质量和一致性

**验收标准**:
- [x] 提供"数据对比"功能
- [x] 并排展示多个数据源的同一股票K线数据
- [x] 高亮显示差异点（价格、成交量等）
- [x] 支持导出对比报告

---

## 4. 功能需求

### 4.1 核心功能

#### F-1: 新增数据源适配器

为每个候选数据源实现适配器类：
- 继承 `BaseDataAdapter`
- 实现 `get_stock_data()`, `search_stock()`, `get_stock_info()` 方法
- 处理各数据源的特定格式和参数
- 统一返回标准化的 DataFrame 格式

**适配器清单**:
- `AllTickAdapter` (高优先级)
- `InfowayAdapter` (中优先级)
- `FreeStockAPIAdapter` (中优先级)
- `ChinaStockAPIAdapter` (中优先级)
- `NowAPIAdapter` (低优先级)
- `BaostockAdapter` (备选)

---

#### F-2: 故障转移机制

实现智能数据源切换逻辑：

```python
# backend/app/services/data_failover_service.py

class DataFailoverService:
    """数据源故障转移服务"""

    def get_stock_data_with_failover(
        self,
        symbol: str,
        start_date: str,
        end_date: str,
        adapter_priority: list = None
    ):
        """
        按优先级尝试多个数据源，直到成功或全部失败

        Args:
            symbol: 股票代码
            start_date: 开始日期
            end_date: 结束日期
            adapter_priority: 适配器优先级列表（可选）

        Returns:
            DataFrame: 股票数据
            str: 实际使用的数据源名称

        Raises:
            Exception: 所有数据源均失败时抛出
        """
        pass
```

**核心逻辑**:
1. 根据股票市场类型，选择合适的适配器列表
2. 按优先级依次尝试每个适配器
3. 捕获异常，记录日志，自动重试（最多3次）
4. 第一个成功的适配器立即返回结果
5. 所有适配器失败后，抛出聚合异常

---

#### F-3: 数据源健康监控

实现健康检查和状态管理：

```python
# backend/app/services/adapter_health_service.py

class AdapterHealthService:
    """适配器健康监控服务"""

    def check_adapter_health(self, adapter_name: str) -> dict:
        """检查单个适配器健康状态"""
        pass

    def get_all_adapters_status(self) -> list:
        """获取所有适配器状态"""
        pass

    def update_adapter_metrics(self, adapter_name: str, success: bool, response_time: float):
        """更新适配器性能指标"""
        pass
```

**健康检查指标**:
- 状态: `online` / `offline` / `degraded` / `error`
- 响应时间: 平均响应时间（ms）
- 成功率: 最近100次请求的成功率
- 最后成功时间: 最近一次成功请求的时间
- 错误信息: 最近一次失败的错误详情

---

#### F-4: 配置管理

提供数据源配置接口：

**配置项**:
```json
{
  "adapters": [
    {
      "name": "akshare",
      "enabled": true,
      "priority": 1,
      "markets": ["A-share"],
      "config": {}
    },
    {
      "name": "alltick",
      "enabled": true,
      "priority": 2,
      "markets": ["A-share", "HK"],
      "config": {
        "api_key": "xxx"
      }
    }
  ],
  "failover": {
    "enabled": true,
    "max_retries": 3,
    "retry_delay": 1
  }
}
```

**API端点**:
- `GET /api/v1/adapters/config` - 获取配置
- `PUT /api/v1/adapters/config` - 更新配置
- `POST /api/v1/adapters/{name}/enable` - 启用适配器
- `POST /api/v1/adapters/{name}/disable` - 禁用适配器

---

### 4.2 前端功能

#### P-1: 数据源状态页面

位置: `/settings/data-sources`

**展示内容**:
```
┌──────────────────────────────────────────────────────────────┐
│  数据源管理                                   [刷新] [配置]   │
├──────────────────────────────────────────────────────────────┤
│  数据源        状态      优先级  市场      成功率  响应时间   │
│  ● AkShare    在线       1      A股       98.5%   120ms     │
│  ● YFinance   在线       2      全球      95.2%   450ms     │
│  ● AllTick    在线       3      A股/港股  92.1%   200ms     │
│  ○ Infoway    离线       4      A股/港股   -        -        │
│  ● ChinaStock 降级       5      A股       85.3%   800ms     │
│                                                               │
│  [健康检查] [优先级调整] [启用/禁用]                          │
└──────────────────────────────────────────────────────────────┘
```

---

#### P-2: 数据源配置对话框

功能:
- 调整优先级（拖拽排序）
- 启用/禁用数据源
- 配置API密钥（如需要）
- 设置故障转移参数（重试次数、延迟）

---

#### P-3: 数据对比工具（可选）

位置: `/tools/data-compare`

功能:
- 选择股票 + 日期范围
- 选择2-3个数据源
- 并排展示K线图
- 差异点标注
- 导出对比报告

---

## 5. 技术方案

### 5.1 适配器工厂增强

修改现有 `AdapterFactory`，支持动态加载和优先级管理：

```python
# backend/app/adapters/factory.py

class AdapterFactory:
    """数据适配器工厂（增强版）"""

    _adapters = {}  # 已注册的适配器
    _config = None  # 配置管理器

    @classmethod
    def register_adapter(cls, name: str, adapter_class):
        """注册新适配器"""
        cls._adapters[name] = adapter_class

    @classmethod
    def get_adapter(cls, name: str = None, symbol: str = None):
        """
        获取适配器实例

        Args:
            name: 指定适配器名称（可选）
            symbol: 股票代码（用于自动选择合适适配器）

        Returns:
            适配器实例
        """
        pass

    @classmethod
    def get_adapter_priority_list(cls, market: str):
        """获取指定市场的适配器优先级列表"""
        pass
```

---

### 5.2 配置持久化

**方案1: JSON文件存储**（初期推荐）
- 文件路径: `backend/config/adapters.json`
- 优点: 简单、易于编辑、无需数据库
- 缺点: 多实例部署时需要同步

**方案2: 数据库存储**（长期方案）
- 表: `adapter_config`, `adapter_metrics`
- 优点: 支持多实例、支持历史记录
- 缺点: 需要数据库迁移

---

### 5.3 健康监控实现

使用装饰器模式，自动记录每次请求的性能指标：

```python
# backend/app/adapters/monitoring.py

def monitor_adapter(func):
    """适配器监控装饰器"""
    def wrapper(self, *args, **kwargs):
        start_time = time.time()
        adapter_name = self.name

        try:
            result = func(self, *args, **kwargs)
            response_time = (time.time() - start_time) * 1000

            # 记录成功指标
            AdapterHealthService.update_metrics(
                adapter_name,
                success=True,
                response_time=response_time
            )

            return result

        except Exception as e:
            response_time = (time.time() - start_time) * 1000

            # 记录失败指标
            AdapterHealthService.update_metrics(
                adapter_name,
                success=False,
                response_time=response_time,
                error=str(e)
            )

            raise

    return wrapper
```

---

### 5.4 故障转移流程

```
用户请求获取股票数据
      ↓
检测股票市场类型 (A股/港股/美股)
      ↓
获取该市场的适配器优先级列表
      ↓
遍历适配器列表:
  ↓
  尝试适配器N (重试最多3次)
    ├─ 成功 → 返回数据 + 记录使用的适配器
    └─ 失败 → 记录日志 → 尝试下一个适配器
      ↓
所有适配器失败 → 抛出异常
```

---

## 6. 实施计划

### 阶段1: 调研与评估 (3-5天)

- [x] 注册并测试所有候选数据源API
- [x] 评估免费版的调用限制、延迟、稳定性
- [x] 记录各数据源的接口文档和样例
- [x] 确定最终实施的数据源清单（3-5个）

---

### 阶段2: 适配器开发 (5-7天)

- [x] 实现 3-5 个新数据源适配器
- [x] 编写单元测试（每个适配器）
- [x] 标准化数据格式转换
- [x] 处理异常和边界情况

---

### 阶段3: 故障转移与健康监控 (3-4天)

- [x] 实现 `DataFailoverService`
- [x] 实现 `AdapterHealthService`
- [x] 添加监控装饰器
- [x] 配置管理（JSON文件）
- [x] 集成测试（故障转移场景）

---

### 阶段4: 前端界面 (2-3天)

- [x] 数据源状态页面
- [x] 配置对话框（优先级调整、启用/禁用）
- [x] 健康检查按钮
- [x] 当前使用数据源显示（回测页面）

---

### 阶段5: 测试与优化 (2-3天)

- [x] 端到端测试
- [x] 性能测试（并发请求）
- [x] 故障模拟测试
- [x] 文档更新（API文档、用户手册）

---

## 7. 验收标准

### 功能验收

- [x] 至少新增 3 个稳定可用的数据源适配器
- [x] 故障转移机制正常工作（主数据源失败时自动切换）
- [x] 数据源状态页面正确显示所有适配器健康状态
- [x] 可通过界面调整数据源优先级
- [x] 所有适配器返回标准化的数据格式
- [x] 异常处理完善，不会因单一数据源故障导致系统崩溃

---

### 性能验收

- [x] 单个数据源请求响应时间 < 2s（大部分情况）
- [x] 故障转移延迟 < 5s（3次重试后切换到下一个适配器）
- [x] 健康检查操作 < 500ms
- [x] 配置更新立即生效（< 100ms）

---

### 稳定性验收

- [x] 系统在任意1-2个数据源离线时仍可正常使用
- [x] 连续运行24小时无崩溃
- [x] 至少覆盖80%的异常场景（网络超时、限流、格式错误等）

---

## 8. 风险与依赖

### 风险

1. **第三方API不稳定**: 免费数据源可能频繁变更接口或限流
   - **缓解**: 多数据源冗余、定期健康检查、及时告警

2. **数据一致性问题**: 不同数据源的同一股票数据可能存在差异
   - **缓解**: 提供数据对比工具、优先使用可靠数据源、记录数据来源

3. **API密钥管理**: 部分数据源需要注册和API密钥
   - **缓解**: 配置文件加密、环境变量存储、不提交到代码库

4. **免费额度耗尽**: 高频使用可能超出免费配额
   - **缓解**: 添加请求频率限制、缓存机制、优先使用无限制数据源

---

### 依赖

1. **网络环境**: 需要稳定的互联网连接访问第三方API
2. **第三方库**: 可能需要安装各数据源的SDK或HTTP客户端
3. **配置管理**: 需要安全存储API密钥和配置信息
4. **监控存储**: 需要存储健康检查指标（内存或数据库）

---

## 9. 未来扩展

### 短期 (1-2月)

- 添加数据缓存机制（减少重复请求）
- 支持数据源的请求频率限制配置
- 数据质量评分系统（自动评估数据源可靠性）

---

### 中期 (3-6月)

- 实时数据支持（WebSocket接口）
- 数据源性能仪表盘（可视化监控）
- 自动数据修复（检测并修正异常数据点）
- 支持付费数据源接入（如Tushare积分、聚宽等）

---

### 长期 (6-12月)

- 数据融合算法（多数据源数据融合，提升准确性）
- 数据源推荐引擎（基于用户使用习惯推荐最佳数据源）
- 社区共享数据源（用户贡献自定义适配器）
- 数据源市场（用户可购买/出售数据源配置）

---

## 10. 参考资料

### 已有文档
- 数据适配器基类: `backend/app/adapters/base.py`
- AkShare适配器实现: `backend/app/adapters/akshare_adapter.py`
- YFinance适配器实现: `backend/app/adapters/yfinance_adapter.py`
- 适配器工厂: `backend/app/adapters/factory.py`

### 第三方资源
- AllTick API文档: https://blog.alltick.co
- Infoway API文档: https://docs.infoway.io
- Baostock文档: http://baostock.com/baostock/index.php/Python_API文档
- Tushare文档: https://tushare.pro/document/2

---

## 11. 成本效益分析

### 开发成本
- 人力: 1名开发者，2-3周
- 第三方服务: 大部分为免费，少数可能需要付费订阅（可选）

### 预期收益
- **稳定性提升**: 数据源故障率降低 80%+
- **用户满意度**: 减少因数据源问题导致的用户投诉
- **系统可靠性**: 99.5% → 99.9% 可用性
- **市场覆盖**: 支持更多市场（港股、美股等），吸引更多用户
- **竞争优势**: 多数据源支持是专业量化平台的标配功能

---

**备注**:
- 此功能为核心稳定性增强，建议高优先级实施
- 可以分阶段实施，优先实现2-3个高质量数据源
- 长期来看，多数据源支持是系统走向成熟的必经之路

**预期影响**:
- 系统稳定性显著提升
- 用户信任度增强
- 为未来的实时交易、多市场支持打下基础

---

**状态变更记录**:
- 2025-11-19: 创建 backlog，状态为 `Backlog`
