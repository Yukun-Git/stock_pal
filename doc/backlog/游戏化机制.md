# Backlog: 游戏化机制

## 功能概述

游戏化机制通过任务挑战、成就徽章、等级排名、赛季奖励等游戏元素，将枯燥的量化学习和策略优化变得有趣和上瘾。提升用户活跃度、留存率和参与度，形成良性的用户增长飞轮。

## 核心价值

- **提升参与度**：任务和奖励驱动用户主动探索功能
- **增强留存**：每日任务、赛季机制让用户养成使用习惯
- **降低门槛**：新手引导任务逐步教会用户使用平台
- **社交裂变**：排行榜、公会系统促进用户间互动
- **商业转化**：积分、徽章、特权引导用户付费

## 主要功能点

### 1. 每日任务系统

**任务类型：**

**新手任务（仅一次）：**
- 完成注册并填写个人信息 → 50积分
- 完成第一次回测 → 100积分
- 保存第一个配置 → 50积分
- 关注第一个用户 → 30积分
- 加入一个团队 → 50积分

**每日常规任务：**
- 每日签到 → 10积分
- 运行1次回测 → 20积分
- 发布1条帖子或评论 → 30积分
- 参与竞技场提交配置 → 50积分
- 完成AI参数优化 → 40积分

**周常任务：**
- 运行5次回测 → 100积分
- 发布3篇策略复盘文章 → 200积分
- 获得50个点赞 → 150积分
- 帮助3个新手解答问题 → 100积分

**挑战任务（高难度）：**
- 在震荡市中控制回撤 < 3% → 500积分 + "风控大师"徽章
- 使用均线策略在银行股上获得10%收益 → 300积分
- 连续7天签到 → 200积分 + "勤奋者"徽章
- 在竞技场进入Top 10 → 1000积分 + "竞技之星"徽章

**任务奖励：**
- 积分（用于购买配置、兑换VIP）
- 经验值（提升等级）
- 徽章（展示在个人主页）
- 抽奖券（参与每周抽奖）

**任务刷新机制：**
- 每日任务：每天凌晨0点刷新
- 周常任务：每周一凌晨刷新
- 挑战任务：不定期更新，完成后消失

### 2. 成就与徽章系统

**成就分类：**

**新手成就：**
- "破冰者"：完成第一次回测
- "策略收藏家"：保存10个配置
- "社交达人"：关注20个用户
- "分享之心"：公开第一个配置

**交易成就：**
- "盈利高手"：单次回测收益率 > 50%
- "稳健投资者"：回撤始终 < 5%
- "百战不殆"：完成100次回测
- "千锤百炼"：完成1000次回测

**竞技成就：**
- "新秀崛起"：首次进入竞技场Top 50
- "王者归来"：连续3周排名Top 10
- "赛季冠军"：获得赛季第一名
- "全能王"：在3个不同赛道都进入Top 20

**社交成就：**
- "受欢迎的创作者"：配置被Fork 100次
- "知识分享者"：发布10篇高赞文章
- "帮助他人"：被点赞1000次
- "导师"：培养5个徒弟出师

**收藏成就：**
- "策略大师"：拥有50个配置
- "收藏家"：收藏100个配置
- "市场猎手"：购买20个付费配置

**徽章等级：**
- 铜牌（初级）
- 银牌（中级）
- 金牌（高级）
- 钻石（顶级）

**徽章展示：**
- 个人主页展示墙（最多展示12个）
- 帖子/评论旁显示徽章（如"金牌导师"）
- 稀有徽章特效（闪光动画）

**隐藏成就（彩蛋）：**
- "夜猫子"：凌晨2-4点完成回测
- "幸运儿"：回测收益率恰好等于10.00%
- "完美主义者"：参数调整次数超过100次

### 3. 等级与经验系统

**经验值获取：**
- 完成任务：获得经验值（与积分同时获得）
- 回测：+5 EXP/次
- 发帖：+10 EXP/篇
- 获得点赞：+2 EXP/个
- 竞技场排名：Top 10额外 +500 EXP

**等级划分：**
| 等级 | 称号 | 所需经验 | 特权 |
|------|------|---------|------|
| 1-10 | 量化新手 | 0-1000 | 基础功能 |
| 11-20 | 策略学徒 | 1000-5000 | 解锁AI优化 |
| 21-30 | 交易高手 | 5000-15000 | 参与高级竞技场 |
| 31-40 | 量化专家 | 15000-40000 | 创建团队 |
| 41-50 | 策略大师 | 40000-100000 | 申请导师 |
| 51+ | 传奇交易员 | 100000+ | 全部功能 + 专属客服 |

**升级奖励：**
- 每升5级：500积分 + 抽奖券x1
- 每升10级：特殊徽章 + VIP体验券（7天）
- 达到50级：永久VIP（或大额优惠）

**等级可视化：**
- 进度条展示距离下一级的进度
- 升级时页面特效（烟花、彩带）
- 等级图标（不同等级不同颜色边框）

### 4. 排行榜系统

**全局排行榜：**
- **财富榜**：按积分总量排序
- **等级榜**：按等级和经验值排序
- **活跃榜**：按近30天活跃度排序
- **贡献榜**：按帮助他人数量排序（点赞、Fork、评论）

**竞技场排行榜：**
- 各赛道实时排名（见竞技场backlog）

**社交排行榜：**
- **最受欢迎配置**：按Fork数排序
- **最受欢迎用户**：按粉丝数排序
- **最佳作者**：按文章点赞数排序

**时间维度：**
- 日榜/周榜/月榜/总榜
- 赛季榜（每季度重置）

**排行榜奖励：**
- 每周榜单Top 3：额外积分奖励
- 月榜Top 10：实物奖品（如书籍、优盘）
- 赛季榜Top 1：高额奖金 + 专属徽章

**排行榜显示：**
- 前10名详细信息（头像、昵称、数值）
- 11-100名简略信息
- 自己的排名高亮显示（无论在第几位）

### 5. 赛季机制

**赛季时长：**
- 每赛季3个月（季度）
- 全年4个赛季：春/夏/秋/冬

**赛季开始：**
- 排行榜重置（但用户等级和积分保留）
- 发布赛季任务和挑战
- 宣布赛季主题（如"震荡市求生赛季"）

**赛季任务：**
- 特殊主题挑战（如在熊市环境中保持正收益）
- 完成可获得赛季专属徽章
- 赛季积分（与常规积分分开）

**赛季结算：**
- 赛季末根据排名发放奖励
- 前10%：金牌徽章
- 前30%：银牌徽章
- 前50%：铜牌徽章
- 所有参与者：纪念徽章

**赛季通行证（Battle Pass）：**
- 免费通行证：完成任务获得基础奖励
- 付费通行证（如30元/赛季）：额外丰厚奖励
  - 双倍积分
  - 专属徽章
  - VIP权限
  - 实物奖品（达到指定等级）

**赛季回顾：**
- 赛季结束后生成个人数据报告
- 包括：完成任务数、排名变化、最佳配置、成长曲线
- 可分享到社交平台

### 6. 公会/战队系统

**公会创建：**
- 等级达到30级可创建公会
- 设置公会名称、标志、宣言
- 最多容纳50人（可升级扩容）

**公会活动：**
- **公会竞技场**：公会间对抗赛
  - 每周选3名代表参赛
  - 公会总分 = 代表平均分
  - 获胜公会全员奖励
- **公会任务**：
  - 全公会协作完成任务（如"本周累计回测1000次"）
  - 完成后全员获得奖励
- **公会捐献**：
  - 成员捐献积分到公会金库
  - 用于公会升级、发放福利

**公会等级：**
- 通过完成任务、竞技场排名提升公会等级
- 高等级公会特权：
  - 更多成员名额
  - 专属公会徽章
  - 优先参与测试新功能

**公会排行榜：**
- 按公会总积分排序
- 每赛季结算奖励

**公会福利：**
- 会长可给成员发红包（积分）
- 公会内部配置共享库
- 公会专属聊天频道

### 7. 抽奖与盲盒

**抽奖券获取：**
- 完成周常任务
- 升级奖励
- 充值赠送

**每周抽奖：**
- 每周五晚8点开奖
- 奖品池：
  - 一等奖（1名）：1000积分或VIP月卡
  - 二等奖（5名）：500积分
  - 三等奖（20名）：200积分
  - 参与奖（所有人）：10积分

**盲盒系统：**
- 消耗积分购买盲盒（如100积分/个）
- 随机开出：
  - 普通奖励（70%）：50-100积分
  - 稀有奖励（25%）：200-500积分
  - 传奇奖励（5%）：1000积分或稀有徽章

**保底机制：**
- 连续10次未中稀有，第11次必出稀有

### 8. 日常签到

**签到奖励：**
- 连续签到天数越多，奖励越高
- 第1天：10积分
- 第7天：50积分 + 抽奖券x1
- 第30天：300积分 + 稀有徽章

**补签功能：**
- 漏签可花费积分补签（50积分/次）
- 每月最多补签3次

**签到日历：**
- 可视化展示签到历史
- 未签到日期灰色，已签到绿色

## 技术要点

### 数据库设计

```sql
-- 任务表
CREATE TABLE tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_type ENUM('daily', 'weekly', 'challenge', 'newbie'),
    title VARCHAR(200) NOT NULL,
    description TEXT,

    -- 完成条件
    condition_type VARCHAR(50),  -- 如 'backtest_count', 'post_count'
    condition_value INT,         -- 需要完成的数量

    -- 奖励
    reward_points INT DEFAULT 0,
    reward_exp INT DEFAULT 0,
    reward_badge_id BIGINT,

    -- 时间限制
    start_date DATE,
    end_date DATE,

    status ENUM('active', 'expired') DEFAULT 'active',

    INDEX idx_task_type (task_type),
    INDEX idx_status (status)
);

-- 用户任务进度表
CREATE TABLE user_task_progress (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    task_id BIGINT NOT NULL,

    current_progress INT DEFAULT 0,  -- 当前进度
    is_completed BOOLEAN DEFAULT FALSE,
    is_claimed BOOLEAN DEFAULT FALSE,  -- 是否领取奖励

    completed_at TIMESTAMP,
    claimed_at TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    UNIQUE KEY uk_user_task (user_id, task_id),
    INDEX idx_user_id (user_id)
);

-- 成就表
CREATE TABLE achievements (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    badge_icon VARCHAR(200),  -- 徽章图标URL

    category ENUM('newbie', 'trading', 'competition', 'social', 'collection'),
    tier ENUM('bronze', 'silver', 'gold', 'diamond') DEFAULT 'bronze',

    -- 解锁条件
    unlock_condition JSON,

    -- 奖励
    reward_points INT DEFAULT 0,
    reward_exp INT DEFAULT 0,

    is_hidden BOOLEAN DEFAULT FALSE,  -- 隐藏成就
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户成就表
CREATE TABLE user_achievements (
    user_id BIGINT NOT NULL,
    achievement_id BIGINT NOT NULL,
    unlocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (user_id, achievement_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (achievement_id) REFERENCES achievements(id)
);

-- 用户等级扩展（添加到users表）
ALTER TABLE users ADD COLUMN level INT DEFAULT 1;
ALTER TABLE users ADD COLUMN exp INT DEFAULT 0;
ALTER TABLE users ADD COLUMN next_level_exp INT DEFAULT 100;

-- 签到记录表
CREATE TABLE user_checkins (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    checkin_date DATE NOT NULL,
    consecutive_days INT DEFAULT 1,  -- 连续签到天数

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY uk_user_date (user_id, checkin_date),
    INDEX idx_user_id (user_id)
);

-- 公会表
CREATE TABLE guilds (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    logo_url VARCHAR(500),

    leader_id BIGINT NOT NULL,
    member_count INT DEFAULT 1,
    max_members INT DEFAULT 50,

    level INT DEFAULT 1,
    exp INT DEFAULT 0,
    total_points INT DEFAULT 0,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (leader_id) REFERENCES users(id),
    INDEX idx_leader_id (leader_id),
    INDEX idx_total_points (total_points)
);

-- 公会成员表
CREATE TABLE guild_members (
    guild_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    role ENUM('leader', 'officer', 'member') DEFAULT 'member',
    contribution INT DEFAULT 0,  -- 贡献度

    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (guild_id, user_id),
    FOREIGN KEY (guild_id) REFERENCES guilds(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id)
);

-- 抽奖券表
CREATE TABLE user_lottery_tickets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    ticket_count INT DEFAULT 0,

    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE KEY uk_user (user_id)
);

-- 抽奖记录表
CREATE TABLE lottery_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    lottery_type ENUM('weekly', 'blind_box'),

    prize_type VARCHAR(50),  -- 'points', 'vip', 'badge'
    prize_value VARCHAR(100),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);
```

### API设计

```
# 任务系统
GET    /api/v1/tasks                      # 获取任务列表
GET    /api/v1/tasks/my-progress          # 我的任务进度
POST   /api/v1/tasks/:id/claim            # 领取任务奖励

# 成就系统
GET    /api/v1/achievements               # 获取成就列表
GET    /api/v1/achievements/my            # 我的成就
POST   /api/v1/achievements/:id/showcase  # 展示到个人主页

# 等级系统
GET    /api/v1/users/me/level             # 我的等级信息
GET    /api/v1/leaderboard/level          # 等级排行榜

# 签到
POST   /api/v1/checkin                    # 签到
GET    /api/v1/checkin/history            # 签到历史
POST   /api/v1/checkin/makeup             # 补签

# 公会
POST   /api/v1/guilds                     # 创建公会
GET    /api/v1/guilds                     # 公会列表
GET    /api/v1/guilds/:id                 # 公会详情
POST   /api/v1/guilds/:id/join            # 加入公会
POST   /api/v1/guilds/:id/leave           # 退出公会
POST   /api/v1/guilds/:id/donate          # 捐献积分
GET    /api/v1/guilds/:id/members         # 成员列表
GET    /api/v1/guilds/leaderboard         # 公会排行榜

# 抽奖
GET    /api/v1/lottery/tickets            # 我的抽奖券
POST   /api/v1/lottery/draw               # 抽奖
POST   /api/v1/lottery/open-box           # 开盲盒
GET    /api/v1/lottery/history            # 抽奖记录

# 排行榜
GET    /api/v1/leaderboard/points         # 积分榜
GET    /api/v1/leaderboard/level          # 等级榜
GET    /api/v1/leaderboard/active         # 活跃榜
GET    /api/v1/leaderboard/contribution   # 贡献榜
```

### 游戏化事件触发

**后端事件监听：**
使用事件驱动模式，当用户完成特定操作时触发任务进度更新和成就检查。

```python
# 事件示例
@app.after_request
def check_gamification_events(response):
    if current_action == 'backtest_completed':
        update_task_progress(user_id, 'daily_backtest')
        check_achievement_unlock(user_id, 'backtest_count')
    return response
```

**异步处理：**
- 使用Celery异步更新任务进度
- 避免阻塞主流程

### 前端实现

**页面结构：**
- `/tasks` - 任务中心
- `/achievements` - 成就墙
- `/leaderboard` - 排行榜
- `/guilds` - 公会列表
- `/guilds/:id` - 公会详情
- `/season` - 赛季信息

**核心组件：**
- `TaskList` - 任务列表
- `AchievementWall` - 成就墙
- `LevelProgress` - 等级进度条
- `Leaderboard` - 排行榜组件
- `CheckinCalendar` - 签到日历
- `LotteryWheel` - 抽奖转盘动画

**动效设计：**
- 任务完成：打钩动画 + 音效
- 升级：烟花特效 + 升级提示
- 解锁成就：徽章翻转动画
- 抽奖：转盘旋转 + 中奖弹窗

## 优先级

**P0（MVP）：**
- 每日任务（基础）
- 等级与经验
- 签到系统
- 积分排行榜

**P1（重要）：**
- 成就与徽章
- 挑战任务
- 竞技场排行榜
- 赛季机制

**P2（可选）：**
- 公会系统
- 抽奖与盲盒
- 赛季通行证
- 隐藏成就

## 依赖关系

**前置依赖：**
- 用户账户系统
- 配置管理系统
- 竞技场系统
- 社交功能

**后置依赖：**
- 无

## 风险与挑战

1. **游戏化过度**：
   - 用户过度关注积分而忽视策略学习
   - 解决方案：平衡游戏性和教育性，核心还是策略

2. **积分通胀**：
   - 积分发放过多导致贬值
   - 解决方案：定期调整任务奖励，增加积分消耗渠道

3. **刷任务行为**：
   - 用户恶意刷任务赚积分
   - 解决方案：检测异常行为、限制频率、人工审核

4. **开发成本**：
   - 游戏化功能开发和维护成本高
   - 解决方案：分阶段上线，从简单任务开始

## 成功指标

- 日活跃用户（DAU）提升 > 40%
- 7日留存率提升 > 25%
- 平均使用时长提升 > 50%
- 任务完成率 > 60%
- 签到率 > 70%
- 赛季参与率 > 50%

## 参考案例

- 王者荣耀：赛季、通行证、段位系统
- 原神：每日任务、成就、抽卡
- Duolingo：连续签到、经验值、排行榜
- GitHub：贡献图、徽章、成就
