# Backlog: 风险控制系统（进阶）

## 功能概述

风险控制系统（进阶）是在基础风控（止损、止盈）之上的多层级、全方位风险管理体系。它包括账户级风险控制（单日/单周亏损限制、总仓位控制）、持仓级风险控制（单股风险、行业集中度）、交易级风险控制（连续亏损暂停、回撤降仓）等模块，帮助用户在不同维度上控制风险，保护本金，避免重大损失。

## 核心价值

- **保护本金**：通过多层防护机制，防止因连续亏损、情绪化交易导致的资金大幅回撤
- **专业化风控**：提供机构级别的风险管理工具，弥补散户在风险意识上的不足
- **避免情绪化交易**：自动化风控规则强制执行，避免"越亏越赌"的心态
- **提升长期生存率**：量化交易的核心是长期稳定盈利，而非短期暴利，风控是生存基础
- **合规性**：为未来对接实盘打下基础，专业交易平台必备的风控体系

## 与其他 Backlog 的关系

### 与市场自适应配置的关系

- **协同作用**：市场自适应识别市场环境并切换策略，风控系统在不同市场环境下应用不同的风控强度
  - 牛市：风控相对宽松（止损-8%，总仓位80%）
  - 熊市：风控极度严格（止损-3%，总仓位20%，单日亏损限制1%）
  - 震荡市：适中风控（止损-5%，总仓位50%）

- **风控参数动态调整**：市场状态切换时，风控系统自动调整参数
  - 示例：牛市转熊市时，自动收紧止损，降低总仓位上限

### 与仓位管理的关系

- **前后依赖**：仓位管理决定"买多少"，风控系统约束"最多能买多少"
  - 仓位管理：凯利公式计算建议仓位40%
  - 风控系统：总仓位上限50% → 实际仓位=min(40%, 50%)=40%

- **多维限制**：
  - 单笔仓位限制（仓位管理）
  - 总仓位限制（风控系统）
  - 单股仓位上限（风控系统）
  - 回撤时降仓（风控系统）

### 与持仓退出管理的关系

- **互补关系**：持仓退出管理决定"何时卖出"，风控系统提供"强制退出"机制
  - 持仓退出：移动止损、时间止损、信号反转退出（主动退出）
  - 风控系统：单日亏损达限、连续亏损暂停、回撤过大强制清仓（被动防御）

- **优先级**：风控系统优先级更高
  - 示例：即使移动止损未触发，但单日亏损已达限，强制停止交易

### 三者组合的完整逻辑

```
市场自适应 → 仓位管理 → 风控系统 → 持仓退出管理
     ↓           ↓          ↓            ↓
识别牛市     建议仓位40%  检查限制     正常止损卖出
             (凯利公式)   总仓位<80%   (移动止损-10%)
                         单股<30% ✓
                         单日亏损<3% ✓

                         执行买入40%

                         持仓中...

                         (价格下跌)

持仓退出     移动止损触发 → 卖出 ✓

风控系统     单日亏损2.8% → 警告 ⚠️
            (未达3%限制)

            连续亏损3次 → 继续观察

市场自适应   牛市→熊市 → 强制清仓 🚨
```

## 主要功能点

### 1. 账户级风险控制

#### 1.1 总仓位控制

**问题**：同时持有多只股票时，总仓位可能过高，集中风险

**功能需求**：

**1.1.1 固定总仓位上限**
- **原理**：所有持仓加起来不超过X%
- **配置参数**：
  - 最大总仓位：0-100%（建议50-80%）
  - 最小现金比例：保留至少X%现金应对机会
- **计算逻辑**：
  ```
  当前持仓市值：60万
  账户总资产：100万
  当前总仓位：60%

  总仓位上限：70%
  剩余可用仓位：10万

  如果新买入需要15万 → 拒绝交易
  ```
- **适用场景**：多股票组合管理

**1.1.2 动态总仓位（根据市场环境）**
- **原理**：不同市场环境设置不同的总仓位上限
- **配置参数**：
  ```
  牛市：总仓位上限 80%
  震荡市：总仓位上限 50%
  熊市：总仓位上限 20%（防守为主）
  ```
- **自动调整**：市场状态切换时自动调整上限
- **仓位降级处理**：
  ```
  当前总仓位：70%
  市场从牛市转为熊市
  新上限：20%

  处理方式：
  - 立即清仓至20%（激进）
  - 逐步减仓（稳健）
  - 禁止新开仓，等待自然减仓（保守）
  ```

**1.1.3 分散化要求**
- **原理**：避免过度集中于单只股票
- **配置参数**：
  - 最多持仓N只股票：如5只
  - 至少持仓M只股票：如3只（分散风险）
  - 单股最大仓位占比：如30%

**实施优先级**：⭐⭐⭐⭐ 高（多股票场景必须）

---

#### 1.2 单日/单周/单月亏损限制

**问题**：连续亏损时情绪化交易，越亏越多，需要强制熔断机制

**功能需求**：

**1.2.1 单日最大亏损**
- **原理**：当日账户净值亏损达到阈值时，停止所有交易
- **配置参数**：
  - 单日最大亏损金额：如5000元
  - 单日最大亏损比例：如3%（基于日初资产）
  - 限制范围：
    - 禁止开新仓（持仓可继续）
    - 强制清仓（激进，高风险）
    - 只允许平仓（只出不进）
- **计算逻辑**：
  ```
  账户日初资产：10万
  单日亏损限制：3%（3000元）

  当日交易1：亏损1500元
  当日交易2：亏损800元
  当日交易3：亏损500元

  累计亏损：2800元（未达限制）

  当日交易4：预计亏损300元
  触发前检查：2800 + 300 = 3100 > 3000

  系统拒绝交易，提示"达到单日亏损限制"
  ```
- **适用场景**：避免单日暴亏，保护本金

**1.2.2 单周最大亏损**
- **原理**：一周累计亏损达到阈值，本周停止所有交易
- **配置参数**：
  - 单周最大亏损：如5%（基于周初资产）
  - 重置时间：每周一00:00
  - 恢复条件：
    - 下周自动恢复
    - 盈利回血后恢复
- **计算逻辑**：
  ```
  周一资产：10万
  周一亏损：2000元（2%）
  周二亏损：1500元（1.5%）
  周三盈利：500元
  周四亏损：2000元（2%）

  累计亏损：(2000 + 1500 - 500 + 2000) / 100000 = 5%

  触发单周亏损限制，本周剩余时间停止交易
  ```

**1.2.3 单月最大亏损**
- **原理**：月度亏损限制，更长周期的保护
- **配置参数**：
  - 单月最大亏损：如10%
  - 重置时间：每月1号
- **适用场景**：长期风险控制

**1.2.4 触发后的操作**
- **提示**：
  ```
  ⚠️ 单日亏损限制触发

  当前亏损：3100元 / 3.1%
  限制阈值：3000元 / 3.0%

  已禁止开新仓，明日自动恢复。

  建议：
  - 停止交易，休息一天
  - 复盘今日亏损原因
  - 调整策略或参数

  [查看交易记录] [关闭]
  ```
- **日志记录**：所有触发事件记录到数据库，供分析

**实施优先级**：⭐⭐⭐⭐⭐ 极高，保护本金的最后一道防线

---

### 2. 持仓级风险控制

#### 2.1 单股风险控制

**问题**：单只股票亏损过大，拖累整体收益

**功能需求**：

**2.1.1 单股最大亏损金额**
- **原理**：单只股票最多亏损X元或X%
- **配置参数**：
  - 单股最大亏损金额：如5000元
  - 单股最大亏损比例：如20%（相对买入价）
  - 超过后动作：强制止损
- **计算逻辑**：
  ```
  买入：贵州茅台，1000股，成本价1000元
  投入：100万

  单股亏损限制：-20%
  止损价格：1000 × (1 - 20%) = 800元

  当前价格：790元
  当前亏损：(790 - 1000) / 1000 = -21%

  触发单股亏损限制，强制卖出
  ```

**2.1.2 单股仓位上限**
- **原理**：单只股票不超过总资金X%
- **配置参数**：
  - 单股最大仓位：如30%
  - 限制方式：
    - 初始建仓时限制
    - 加仓时检查
    - 持仓市值上涨时不强制卖出（允许自然上涨突破）
- **示例**：
  ```
  账户总资产：100万
  单股仓位上限：30%

  买入A股票：25万 ✓ (25% < 30%)
  加仓A股票：8万 → 检查：33万 / 100万 = 33% > 30% ✗
  系统提示：单股仓位超限，最多可加仓5万
  ```

**2.1.3 单股持仓时间上限**
- **原理**：单只股票最长持仓N天，避免死拿
- **配置参数**：
  - 最长持仓天数：1-365天（如30天）
  - 到期动作：强制卖出 / 提醒用户
- **适用场景**：
  - 短线策略：最长5天
  - 中线策略：最长30天
  - 长线策略：不限制或120天

**实施优先级**：⭐⭐⭐ 中，单股票场景优先级低，多股票场景优先级高

---

#### 2.2 行业/风格集中度控制

**问题**：过度集中于某个行业或风格，黑天鹅风险（如教育双减、医药反腐）

**功能需求**：

**2.2.1 行业集中度限制**
- **原理**：同一行业持仓不超过X%
- **配置参数**：
  - 单一行业上限：如40%
  - 行业分类标准：申万一级行业 / 自定义
  - 限制范围：总资产或总持仓
- **示例**：
  ```
  账户总资产：100万
  行业集中度上限：40%

  当前持仓：
  - 贵州茅台（白酒）：30万
  - 五粮液（白酒）：15万
  - 洋河股份（白酒）：？

  白酒行业占比：45万 / 100万 = 45% > 40%
  系统禁止买入洋河股份，提示"行业集中度超限"
  ```

**2.2.2 风格分散要求**
- **原理**：要求持仓覆盖多个行业或风格
- **配置参数**：
  - 至少持有N个行业：如3个
  - 大盘股/小盘股比例：如6:4
  - 成长股/价值股比例
- **适用场景**：分散风险，避免单一行业暴雷

**2.2.3 行业黑名单**
- **原理**：禁止买入特定行业的股票
- **配置参数**：
  - 行业黑名单：如房地产、煤炭
  - 原因标注：政策风险、周期性强等
- **示例**：
  ```
  用户设置：禁止买入房地产行业

  系统生成买入信号：万科A（房地产）
  检查行业黑名单：房地产 ✗
  拒绝买入，提示"该行业在黑名单中"
  ```

**实施优先级**：⭐⭐ 低，多股票场景后期实现

---

### 3. 交易级风险控制

#### 3.1 连续亏损控制

**问题**：策略可能进入失效期，连续亏损时需要暂停交易，避免继续亏损

**功能需求**：

**3.1.1 连续亏损次数暂停**
- **原理**：连续亏损N次后，暂停交易M天
- **配置参数**：
  - 连续亏损次数阈值：如5次
  - 暂停天数：如3天
  - 暂停方式：
    - 完全停止交易
    - 仅观察模式（模拟交易，不实际下单）
  - 恢复条件：
    - 时间到期自动恢复
    - 盈利一次后恢复
- **计算逻辑**：
  ```
  交易1：亏损 -2%
  交易2：亏损 -1.5%
  交易3：亏损 -3%
  交易4：盈利 +2% → 重置计数器
  交易5：亏损 -1%
  交易6：亏损 -2%
  交易7：亏损 -1%
  交易8：亏损 -2%
  交易9：亏损 -1.5%

  连续亏损5次，触发暂停
  提示："策略可能失效，暂停3天"
  ```
- **提示界面**：
  ```
  🚨 连续亏损暂停触发

  连续亏损：5次
  累计亏损：-10.5%
  暂停时间：3天（至2024-01-20）

  建议：
  - 复盘近期交易
  - 检查策略是否适应当前市场
  - 考虑调整参数或暂停策略

  观察模式：[开启] / [关闭]
  强制恢复：[恢复交易]（风险自负）
  ```

**3.1.2 亏损加速暂停**
- **原理**：短时间内快速连续亏损，立即暂停
- **配置参数**：
  - 时间窗口：如3天
  - 亏损次数：如3次
  - 暂停天数：如7天（比普通暂停更长）
- **示例**：
  ```
  3天内连续亏损3次，累计-8%
  判断：亏损加速，策略严重失效
  触发：暂停7天
  ```

**3.1.3 观察模式**
- **原理**：暂停期间继续模拟交易，但不实际下单
- **功能**：
  - 记录模拟交易信号和结果
  - 用户查看"如果继续交易会怎样"
  - 帮助判断策略是否恢复有效
- **恢复判断**：
  ```
  暂停期间观察模式：
  模拟交易1：盈利 +2%
  模拟交易2：盈利 +3%
  模拟交易3：盈利 +1.5%

  连续3次模拟盈利 → 策略可能恢复
  提示用户："策略表现改善，是否恢复交易？"
  ```

**实施优先级**：⭐⭐⭐⭐ 高，避免情绪化交易

---

#### 3.2 回撤暂停/降仓

**问题**：最大回撤过大时，需要主动防御，降低风险敞口

**功能需求**：

**3.2.1 回撤分级降仓**
- **原理**：根据当前回撤幅度，分级降低仓位
- **配置参数**：
  ```
  回撤 < 5%：      正常交易，100%仓位
  回撤 5-10%：     降低仓位至50%
  回撤 10-15%：    降低仓位至20%
  回撤 > 15%：     暂停所有交易（空仓）
  ```
- **计算逻辑**：
  ```
  历史最高权益：12万
  当前权益：10.2万
  当前回撤：(12 - 10.2) / 12 = 15%

  触发：回撤10-15%区间
  动作：降低仓位至20%

  当前持仓：8万（80%仓位）
  需减仓至：2万（20%仓位）
  减仓金额：6万

  系统提示："回撤过大，建议减仓至20%"
  用户选择：
  - [立即减仓]：卖出6万持仓
  - [暂不减仓]：忽略建议（风险自负）
  ```

**3.2.2 回撤暂停**
- **原理**：回撤达到极限时，强制空仓
- **配置参数**：
  - 最大回撤阈值：如20%
  - 暂停天数：如7天
  - 强制清仓：是/否
- **触发动作**：
  ```
  回撤 > 20% → 强制清仓
  提示："回撤过大，已强制清仓，暂停7天"
  ```

**3.2.3 恢复机制**
- **权益创新高恢复**：
  ```
  历史最高权益：12万
  当前权益：12.5万（创新高）

  回撤：0%
  恢复：仓位上限恢复至100%
  ```
- **回撤降低恢复**：
  ```
  之前回撤：15% → 仓位20%
  当前回撤：8% → 仓位恢复至50%
  当前回撤：4% → 仓位恢复至100%
  ```

**实施优先级**：⭐⭐⭐⭐ 高，保护资金

---

### 4. 风险监控与预警

#### 4.1 实时风险监控面板

**功能：**
- 实时显示各项风险指标
- 接近限制时预警

**监控指标：**
```
┌─────────────────────────────────────┐
│ 风险监控面板                         │
├─────────────────────────────────────┤
│ 账户级风险                           │
│ - 总仓位：65% / 80% 🟢               │
│ - 单日亏损：2.1% / 3.0% 🟡          │
│ - 单周亏损：3.5% / 5.0% 🟢          │
│ - 当前回撤：6.2% / 10.0% 🟢         │
│                                      │
│ 持仓级风险                           │
│ - 单股最大仓位：28% / 30% 🟡        │
│ - 行业集中度：白酒 35% / 40% 🟢     │
│                                      │
│ 交易级风险                           │
│ - 连续亏损：2次 / 5次 🟢            │
│ - 最近7天交易：8次 🟢               │
│                                      │
│ 预警信息                             │
│ ⚠️ 单日亏损接近限制（剩余0.9%）    │
│ ⚠️ 茅台仓位接近上限（剩余2%）      │
└─────────────────────────────────────┘
```

**颜色编码：**
- 🟢 绿色：安全（< 70%限制）
- 🟡 黄色：警告（70-90%限制）
- 🔴 红色：危险（90-100%限制）
- 🚨 紫色：已触发限制

#### 4.2 预警通知

**触发条件：**
- 达到限制的70%时：黄色警告
- 达到限制的90%时：红色警告
- 达到限制的100%时：强制停止

**通知方式：**
- 页面内通知（Notification）
- 邮件通知（可选）
- 短信/微信推送（未来）

**示例通知：**
```
⚠️ 风险预警

类型：单日亏损警告
当前：2.7% / 3.0%
剩余：0.3%

建议：
- 停止新开仓
- 检查现有持仓
- 考虑提前止损

[查看详情] [忽略]
```

#### 4.3 风险报告

**功能：**
- 定期生成风险报告（每日/每周/每月）
- 分析风险指标趋势
- 提供优化建议

**报告内容：**
```
📊 风险报告（2024-01）

## 风险概览
- 触发限制次数：2次
  - 单日亏损限制：1次（1月15日）
  - 连续亏损暂停：1次（1月20日）

## 风险指标分析
- 平均单日亏损：1.2%
- 最大单日亏损：3.1%（触发限制）
- 平均回撤：5.8%
- 最大回撤：12.5%

## 触发事件详情
1. 2024-01-15：单日亏损3.1%
   - 原因：市场暴跌，策略失效
   - 损失金额：3100元
   - 处理：禁止开新仓，次日恢复

2. 2024-01-20：连续亏损5次
   - 累计损失：-10.5%
   - 处理：暂停3天，开启观察模式

## 改进建议
1. 考虑降低单日亏损限制至2%
2. 熊市环境下启用更严格风控
3. 检查策略参数是否需要优化

[下载报告] [查看详细数据]
```

**实施优先级**：⭐⭐⭐ 中，提升用户体验

---

### 5. 与其他系统的集成

#### 5.1 与市场自适应配置集成

**场景：**
- 不同市场环境使用不同的风控参数

**实现：**
```json
{
  "bull_market": {
    "risk_control": {
      "max_total_position": 0.8,
      "max_daily_loss": 0.03,
      "max_drawdown": 0.15,
      "consecutive_loss_threshold": 5
    }
  },
  "bear_market": {
    "risk_control": {
      "max_total_position": 0.2,
      "max_daily_loss": 0.01,
      "max_drawdown": 0.08,
      "consecutive_loss_threshold": 3
    }
  },
  "range_market": {
    "risk_control": {
      "max_total_position": 0.5,
      "max_daily_loss": 0.02,
      "max_drawdown": 0.12,
      "consecutive_loss_threshold": 4
    }
  }
}
```

**切换逻辑：**
```
市场状态：牛市 → 熊市
风控参数自动调整：
- 总仓位上限：80% → 20%
- 单日亏损限制：3% → 1%
- 连续亏损阈值：5次 → 3次

当前状态检查：
- 当前总仓位：65% > 新上限20%
- 触发：强制减仓至20%
```

#### 5.2 与仓位管理集成

**场景：**
- 风控系统约束仓位管理的结果

**实现：**
```python
def calculate_actual_position(strategy_position, risk_limits):
    """
    综合考虑仓位管理和风控限制，计算实际仓位
    """
    # 策略建议仓位（来自凯利公式等）
    suggested_position = strategy_position

    # 风控限制
    max_total_position = risk_limits['max_total_position']
    max_single_stock = risk_limits['max_single_stock']
    current_total_position = get_current_total_position()

    # 检查总仓位限制
    remaining_position = max_total_position - current_total_position
    if remaining_position <= 0:
        return 0, "总仓位已达上限"

    # 检查单股仓位限制
    actual_position = min(
        suggested_position,
        remaining_position,
        max_single_stock
    )

    # 检查单日亏损限制
    if is_daily_loss_limit_reached():
        return 0, "已达单日亏损限制"

    # 检查回撤降仓
    drawdown = calculate_current_drawdown()
    if drawdown > 0.10:
        actual_position *= 0.2  # 降仓至20%
    elif drawdown > 0.05:
        actual_position *= 0.5  # 降仓至50%

    return actual_position, "正常"
```

#### 5.3 与持仓退出管理集成

**场景：**
- 风控系统触发强制退出

**优先级：**
```
风控强制退出 > 持仓退出管理 > 策略信号

示例：
1. 策略信号：继续持有（未触发止损）
2. 移动止损：未触发
3. 单日亏损限制：已触发 → 强制清仓
```

**退出类型标记：**
```json
{
  "exit_type": "RISK_CONTROL_FORCED",
  "reason": "单日亏损限制触发",
  "trigger_value": 0.031,
  "limit_value": 0.03
}
```

---

## 优先级划分

### P0（MVP - 必须实现）

**时间：1-2周**

1. **单日亏损限制**
   - 最核心的风控功能
   - 防止单日暴亏
   - 数据库设计和API

2. **总仓位控制**
   - 多股票场景必须
   - 固定上限和动态调整

3. **风险监控面板（基础）**
   - 实时显示风险指标
   - 接近限制时预警

4. **回测引擎改造**
   - 支持风控规则检查
   - 记录触发事件

### P1（重要功能）

**时间：1-2周**

5. **连续亏损暂停**
   - 避免策略失效期持续亏损
   - 观察模式

6. **回撤降仓**
   - 分级降仓逻辑
   - 自动恢复机制

7. **单周/单月亏损限制**
   - 更长周期的保护
   - 与单日亏损限制类似实现

8. **单股风险控制**
   - 单股仓位上限
   - 单股最大亏损

9. **与市场自适应集成**
   - 不同市场环境的风控参数
   - 自动切换

### P2（高级功能）

**时间：2-3周**

10. **行业集中度控制**
    - 行业仓位限制
    - 风格分散要求

11. **风险报告**
    - 定期生成报告
    - 趋势分析和建议

12. **高级预警**
    - 邮件/短信通知
    - 自定义预警规则

13. **观察模式增强**
    - 模拟交易
    - 策略恢复判断

14. **风控策略优化**
    - 基于历史数据优化风控参数
    - A/B测试不同风控配置

## 技术要点

### 数据库设计

```sql
-- 扩展configurations表，增加风控配置
ALTER TABLE configurations
ADD COLUMN risk_control_config JSON;

-- 风控配置JSON结构
/*
{
  "account_level": {
    "max_total_position": 0.8,
    "min_cash_ratio": 0.2,
    "max_daily_loss_ratio": 0.03,
    "max_daily_loss_amount": 5000,
    "max_weekly_loss_ratio": 0.05,
    "max_monthly_loss_ratio": 0.10,
    "loss_limit_action": "FORBID_NEW_POSITION"  // FORBID_NEW_POSITION | FORCE_CLOSE | CLOSE_ONLY
  },
  "position_level": {
    "max_single_stock_position": 0.3,
    "max_single_stock_loss": 0.2,
    "max_holding_days": 30,
    "industry_concentration_limit": 0.4,
    "min_holdings_count": 3,
    "max_holdings_count": 10
  },
  "trading_level": {
    "consecutive_loss_threshold": 5,
    "consecutive_loss_pause_days": 3,
    "fast_loss_window_days": 3,
    "fast_loss_threshold": 3,
    "fast_loss_pause_days": 7,
    "observation_mode_enabled": true
  },
  "drawdown_control": {
    "drawdown_levels": [
      {"threshold": 0.05, "position_ratio": 1.0},
      {"threshold": 0.10, "position_ratio": 0.5},
      {"threshold": 0.15, "position_ratio": 0.2},
      {"threshold": 0.20, "position_ratio": 0.0}
    ],
    "recovery_condition": "NEW_HIGH"  // NEW_HIGH | DRAWDOWN_DECREASE
  }
}
*/

-- 风控事件记录表
CREATE TABLE risk_control_events (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    backtest_id BIGINT,
    event_type VARCHAR(50) NOT NULL,  -- DAILY_LOSS_LIMIT | CONSECUTIVE_LOSS | DRAWDOWN_PAUSE 等
    trigger_date DATE NOT NULL,

    -- 触发详情
    trigger_value DECIMAL(10, 4),  -- 实际值
    limit_value DECIMAL(10, 4),    -- 限制值
    trigger_reason TEXT,

    -- 执行动作
    action VARCHAR(50),  -- FORBID_NEW | FORCE_CLOSE | REDUCE_POSITION | PAUSE_TRADING
    action_details TEXT,

    -- 影响
    affected_trades TEXT,  -- JSON，受影响的交易ID列表

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (backtest_id) REFERENCES backtest_results(id),
    INDEX idx_backtest_id (backtest_id),
    INDEX idx_event_type (event_type),
    INDEX idx_trigger_date (trigger_date)
);

-- 每日风险统计表
CREATE TABLE daily_risk_stats (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    backtest_id BIGINT,
    date DATE NOT NULL,

    -- 账户级指标
    total_position_ratio DECIMAL(10, 4),
    daily_pnl DECIMAL(15, 2),
    daily_pnl_ratio DECIMAL(10, 4),
    weekly_pnl_ratio DECIMAL(10, 4),
    monthly_pnl_ratio DECIMAL(10, 4),
    current_drawdown DECIMAL(10, 4),

    -- 持仓级指标
    holdings_count INT,
    max_single_stock_position DECIMAL(10, 4),
    industry_concentration JSON,  -- {"白酒": 0.35, "医药": 0.25, ...}

    -- 交易级指标
    consecutive_loss_count INT,
    trades_count INT,

    -- 风险状态
    risk_warnings JSON,  -- [{"type": "DAILY_LOSS_WARNING", "message": "..."}]

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (backtest_id) REFERENCES backtest_results(id),
    INDEX idx_backtest_date (backtest_id, date)
);
```

### API设计

```
# 风控配置
POST   /api/v1/configs/:id/risk-control       # 保存风控配置
GET    /api/v1/configs/:id/risk-control       # 获取配置
PUT    /api/v1/configs/:id/risk-control       # 更新配置

# 风控监控
GET    /api/v1/backtest/:id/risk-monitor      # 获取实时风险监控数据
GET    /api/v1/backtest/:id/risk-events       # 获取风控事件列表
GET    /api/v1/backtest/:id/risk-stats        # 获取风险统计

# 风控报告
GET    /api/v1/backtest/:id/risk-report       # 生成风控报告
POST   /api/v1/risk/batch-check               # 批量检查风控规则

# 回测（支持风控）
POST   /api/v1/backtest/with-risk-control     # 运行带风控的回测
```

### 核心算法

#### 单日亏损检查

```python
def check_daily_loss_limit(backtest_state, trade, config):
    """
    检查单日亏损限制
    """
    today = trade['date'].date()

    # 计算今日已亏损
    daily_trades = [t for t in backtest_state['trades']
                   if t['date'].date() == today]
    daily_pnl = sum(t['pnl'] for t in daily_trades)

    # 计算预计交易盈亏（估算）
    estimated_pnl = estimate_trade_pnl(trade, backtest_state)

    # 总亏损
    total_daily_pnl = daily_pnl + estimated_pnl

    # 日初资产
    start_of_day_equity = backtest_state['equity_at_start_of_day']

    # 亏损比例
    daily_loss_ratio = abs(total_daily_pnl) / start_of_day_equity

    # 检查限制
    max_daily_loss = config['max_daily_loss_ratio']

    if total_daily_pnl < 0 and daily_loss_ratio > max_daily_loss:
        return False, {
            'reason': 'DAILY_LOSS_LIMIT',
            'daily_loss_ratio': daily_loss_ratio,
            'limit': max_daily_loss,
            'message': f'单日亏损{daily_loss_ratio:.2%}超过限制{max_daily_loss:.2%}'
        }

    return True, None
```

#### 回撤降仓

```python
def calculate_position_ratio_by_drawdown(current_drawdown, config):
    """
    根据回撤计算仓位比例
    """
    drawdown_levels = config['drawdown_levels']

    # 按回撤从小到大排序
    sorted_levels = sorted(drawdown_levels, key=lambda x: x['threshold'])

    for level in sorted_levels:
        if current_drawdown < level['threshold']:
            return level['position_ratio']

    # 超过最大回撤阈值，空仓
    return 0.0

# 示例
config = {
    'drawdown_levels': [
        {'threshold': 0.05, 'position_ratio': 1.0},
        {'threshold': 0.10, 'position_ratio': 0.5},
        {'threshold': 0.15, 'position_ratio': 0.2},
        {'threshold': 0.20, 'position_ratio': 0.0}
    ]
}

current_drawdown = 0.12
position_ratio = calculate_position_ratio_by_drawdown(current_drawdown, config)
# position_ratio = 0.2 (回撤12%，在10-15%区间)
```

#### 连续亏损检查

```python
def check_consecutive_loss(backtest_state, config):
    """
    检查连续亏损
    """
    recent_trades = backtest_state['trades'][-10:]  # 最近10笔交易

    consecutive_loss = 0
    for trade in reversed(recent_trades):
        if trade['pnl'] < 0:
            consecutive_loss += 1
        else:
            break  # 遇到盈利交易，重置

    threshold = config['consecutive_loss_threshold']

    if consecutive_loss >= threshold:
        return False, {
            'reason': 'CONSECUTIVE_LOSS',
            'consecutive_loss_count': consecutive_loss,
            'threshold': threshold,
            'pause_days': config['consecutive_loss_pause_days'],
            'message': f'连续亏损{consecutive_loss}次，暂停交易'
        }

    return True, None
```

### 前端实现

#### 风控配置面板

```typescript
interface RiskControlConfig {
  accountLevel: {
    maxTotalPosition: number;
    minCashRatio: number;
    maxDailyLossRatio: number;
    maxWeeklyLossRatio: number;
    maxMonthlyLossRatio: number;
    lossLimitAction: 'FORBID_NEW' | 'FORCE_CLOSE' | 'CLOSE_ONLY';
  };
  positionLevel: {
    maxSingleStockPosition: number;
    maxSingleStockLoss: number;
    maxHoldingDays: number;
    industryConcentrationLimit: number;
  };
  tradingLevel: {
    consecutiveLossThreshold: number;
    consecutiveLossPauseDays: number;
    observationModeEnabled: boolean;
  };
  drawdownControl: {
    drawdownLevels: Array<{
      threshold: number;
      positionRatio: number;
    }>;
  };
}

const RiskControlPanel: React.FC = () => {
  const [config, setConfig] = useState<RiskControlConfig>({...});

  return (
    <div className="risk-control-panel">
      <Tabs>
        <TabPane tab="账户级风控" key="account">
          <Form.Item label="总仓位上限">
            <Slider
              min={0}
              max={100}
              value={config.accountLevel.maxTotalPosition * 100}
              onChange={(val) => updateConfig('maxTotalPosition', val / 100)}
            />
          </Form.Item>

          <Form.Item label="单日最大亏损">
            <InputNumber
              min={0}
              max={10}
              step={0.1}
              value={config.accountLevel.maxDailyLossRatio * 100}
              formatter={(val) => `${val}%`}
              onChange={(val) => updateConfig('maxDailyLossRatio', val / 100)}
            />
          </Form.Item>

          {/* 其他配置项... */}
        </TabPane>

        <TabPane tab="持仓级风控" key="position">
          {/* ... */}
        </TabPane>

        <TabPane tab="交易级风控" key="trading">
          {/* ... */}
        </TabPane>

        <TabPane tab="回撤控制" key="drawdown">
          <DrawdownLevelsConfig
            levels={config.drawdownControl.drawdownLevels}
            onChange={(levels) => updateDrawdownLevels(levels)}
          />
        </TabPane>
      </Tabs>
    </div>
  );
};
```

#### 风险监控面板

```typescript
const RiskMonitorPanel: React.FC<{backtestId: number}> = ({backtestId}) => {
  const {data: riskData} = useRiskMonitor(backtestId);

  const getRiskLevel = (current: number, limit: number) => {
    const ratio = current / limit;
    if (ratio < 0.7) return 'success';
    if (ratio < 0.9) return 'warning';
    return 'error';
  };

  return (
    <Card title="风险监控">
      <Descriptions column={2}>
        <Descriptions.Item label="总仓位">
          <Progress
            percent={(riskData.totalPosition / riskData.maxTotalPosition) * 100}
            status={getRiskLevel(riskData.totalPosition, riskData.maxTotalPosition)}
            format={() => `${(riskData.totalPosition * 100).toFixed(1)}% / ${(riskData.maxTotalPosition * 100).toFixed(0)}%`}
          />
        </Descriptions.Item>

        <Descriptions.Item label="单日亏损">
          <Progress
            percent={(Math.abs(riskData.dailyLoss) / riskData.maxDailyLoss) * 100}
            status={getRiskLevel(Math.abs(riskData.dailyLoss), riskData.maxDailyLoss)}
            format={() => `${(riskData.dailyLoss * 100).toFixed(2)}% / ${(riskData.maxDailyLoss * 100).toFixed(1)}%`}
          />
        </Descriptions.Item>

        <Descriptions.Item label="当前回撤">
          <Progress
            percent={(riskData.currentDrawdown / 0.2) * 100}  // 假设20%为极限
            status={getRiskLevel(riskData.currentDrawdown, 0.2)}
            format={() => `${(riskData.currentDrawdown * 100).toFixed(2)}%`}
          />
        </Descriptions.Item>

        <Descriptions.Item label="连续亏损">
          <Tag color={riskData.consecutiveLoss >= riskData.consecutiveLossThreshold ? 'red' : 'green'}>
            {riskData.consecutiveLoss} / {riskData.consecutiveLossThreshold}次
          </Tag>
        </Descriptions.Item>
      </Descriptions>

      {riskData.warnings.length > 0 && (
        <Alert
          type="warning"
          message="风险预警"
          description={
            <ul>
              {riskData.warnings.map((w, idx) => (
                <li key={idx}>{w.message}</li>
              ))}
            </ul>
          }
        />
      )}
    </Card>
  );
};
```

#### 风控事件时间轴

```typescript
const RiskEventsTimeline: React.FC<{events: RiskEvent[]}> = ({events}) => {
  const getEventIcon = (type: string) => {
    switch (type) {
      case 'DAILY_LOSS_LIMIT':
        return <ExclamationCircleOutlined style={{color: 'red'}} />;
      case 'CONSECUTIVE_LOSS':
        return <WarningOutlined style={{color: 'orange'}} />;
      case 'DRAWDOWN_PAUSE':
        return <StopOutlined style={{color: 'red'}} />;
      default:
        return <InfoCircleOutlined />;
    }
  };

  return (
    <Timeline>
      {events.map((event) => (
        <Timeline.Item
          key={event.id}
          dot={getEventIcon(event.eventType)}
          color={event.eventType.includes('LIMIT') ? 'red' : 'orange'}
        >
          <p>{event.triggerDate}</p>
          <p><strong>{event.triggerReason}</strong></p>
          <p>触发值: {(event.triggerValue * 100).toFixed(2)}% / 限制: {(event.limitValue * 100).toFixed(2)}%</p>
          <p>动作: {event.action}</p>
        </Timeline.Item>
      ))}
    </Timeline>
  );
};
```

## 依赖关系

### 前置依赖

1. **回测引擎**：需要能够执行交易逻辑和计算权益
2. **配置系统**：需要保存和加载风控配置
3. **数据库**：需要记录风控事件和统计数据

### 后置依赖

1. **市场自适应配置**：风控参数根据市场环境动态调整
2. **仓位管理**：风控系统约束仓位管理的结果
3. **持仓退出管理**：风控系统触发强制退出

### 协同关系

- **与市场自适应配置**：不同市场环境使用不同的风控强度
- **与仓位管理**：风控系统是仓位管理的约束条件
- **与持仓退出管理**：风控系统是最后一道防线，优先级最高

## 风险与挑战

### 1. 风控规则冲突

**风险：**
- 多个风控规则同时触发
- 不同规则的动作相互矛盾

**解决方案：**
- 定义风控规则优先级
- 冲突时选择更保守的动作
- 清晰的日志记录

### 2. 用户抵触

**风险：**
- 用户认为风控限制过于严格
- 强制清仓导致错过后续反弹

**解决方案：**
- 所有风控规则可配置
- 提供"风险自负"选项绕过限制（需明确警告）
- 观察模式允许查看"如果不暂停会怎样"

### 3. 回测准确性

**风险：**
- 风控规则的回测实现与实盘可能有偏差
- 边界条件处理不当

**解决方案：**
- 详细的单元测试
- 边界情况的专项测试
- 提供回测日志供验证

### 4. 性能影响

**风险：**
- 每笔交易前都要检查多个风控规则
- 回测速度变慢

**解决方案：**
- 优化风控检查逻辑
- 缓存风险统计数据
- 并行计算

### 5. 过度保护

**风险：**
- 风控过于严格，限制盈利空间
- 频繁触发暂停，交易次数过少

**解决方案：**
- 提供多种风控模板（保守/稳健/激进）
- 允许用户自定义阈值
- 回测时对比有无风控的差异

## 成功指标

### 产品指标

- **功能使用率**：> 40% 的用户启用高级风控功能
- **配置保存率**：> 70% 的用户保存风控配置
- **满意度**：评分 > 4.0/5.0

### 性能指标

- **回撤减少**：平均最大回撤减少 > 30%
- **爆仓率**：使用风控系统的策略爆仓率 < 5%（vs 无风控 > 20%）
- **夏普比率**：风控系统提升夏普比率 > 15%
- **生存率**：连续12个月不触发极限风控的策略 > 80%

### 风控有效性

- **触发准确性**：风控规则触发后，如果不暂停继续交易，后续亏损加剧的概率 > 70%
- **恢复正确性**：暂停后恢复交易，策略表现改善的概率 > 60%
- **误判率**：风控错误触发（不该暂停但暂停了）的比例 < 15%

### 技术指标

- **风控检查延迟**：每笔交易的风控检查时间 < 50ms
- **回测速度**：带风控的回测时间 < 不带风控的1.3倍
- **API响应时间**：风控监控API响应 < 300ms

## 参考案例

### 国内平台

1. **期货公司风控系统**
   - 强制平仓机制
   - 持仓限额
   - 资金使用率监控

2. **券商两融业务**
   - 维持担保比例监控
   - 低于阈值强制平仓

### 国外平台

3. **Interactive Brokers**
   - 实时风险监控
   - 保证金要求
   - 自动清算机制

4. **TD Ameritrade**
   - Pattern Day Trader规则
   - 账户限制和保护

### 量化交易理论

5. **《海龟交易法则》**
   - 风险管理的重要性
   - 单笔风险不超过账户的2%

6. **凯利公式**
   - 数学上的最优风险控制
   - 避免过度下注

7. **风险平价理论**
   - 等风险贡献
   - 动态调整仓位

## 实施建议

### 第1周：核心功能

- [ ] 数据库设计（风控配置表、事件表）
- [ ] 单日亏损限制后端实现
- [ ] 总仓位控制后端实现
- [ ] 风控检查逻辑集成到回测引擎

### 第2周：前端界面

- [ ] 风控配置面板开发
- [ ] 风险监控面板开发
- [ ] 风控事件展示
- [ ] 预警通知

### 第3周：高级功能

- [ ] 连续亏损控制
- [ ] 回撤降仓
- [ ] 单周/单月亏损限制
- [ ] 观察模式

### 第4周：集成与测试

- [ ] 与市场自适应配置集成
- [ ] 与仓位管理集成
- [ ] 单元测试和集成测试
- [ ] 性能优化

### 第5-6周：扩展功能（可选）

- [ ] 单股风险控制
- [ ] 行业集中度控制
- [ ] 风险报告生成
- [ ] 高级预警和推送

## 总结

风险控制系统（进阶）是量化交易平台的**生命线**。它与市场自适应配置、仓位管理、持仓退出管理共同构成完整的交易系统四大支柱：

1. **市场自适应配置**：识别环境，选择策略（智能大脑）
2. **仓位管理**：决定投入多少资金（资金分配）
3. **持仓退出管理**：决定何时退出（执行策略）
4. **风险控制系统**：最后防线，保护本金（安全气囊）

**核心价值：**
- 保护本金：量化交易的第一原则
- 延长生存期：避免爆仓，活得更久才能盈利
- 强制纪律：克服人性弱点，严格执行规则
- 专业化：提供机构级别的风控工具

**建议优先级：High（P0-P1功能2-3周完成）**

这个功能是平台的**核心竞争力**之一，也是对用户**最负责任**的功能。在宣传时应重点突出"帮助用户避免重大损失"这一核心价值。
