# 多策略组合功能开发进度

## 功能概述
实现方案A：策略信号组合功能，允许用户选择多个策略，并设置组合规则（AND/OR/VOTE）进行回测。

---

## ✅ 已完成工作

### 1. 后端实现（100%完成）

#### 1.1 创建策略组合器服务
- **文件**: `backend/app/services/strategy_combiner.py`
- **功能**:
  - `combine_signals()` - 合并多个策略的信号
  - 支持三种组合模式：
    - **AND模式**: 所有策略必须同时发出信号才执行
    - **OR模式**: 任一策略发出信号即执行
    - **VOTE模式**: N个策略中有M个发出信号才执行
  - `get_strategy_signal_column()` - 生成策略信号列名

#### 1.2 修改回测API
- **文件**: `backend/app/api/v1/backtest.py`
- **改动**:
  - 支持接收 `strategy_ids` 数组（多策略）
  - 兼容原有的 `strategy_id` 单策略模式
  - 新增参数：
    - `combine_mode`: 组合模式（'AND', 'OR', 'VOTE'）
    - `vote_threshold`: 投票模式的阈值
  - 为每个策略生成独立的信号列
  - 使用 `StrategyCombiner` 合并信号
  - 返回数据包含策略组合信息

#### 1.3 部署
- ✅ 文件已复制到Docker容器
- ✅ 后端服务已重启
- ✅ API可用性待测试

---

## 🚧 进行中的工作

### 2. 前端实现（约40%完成）

#### 2.1 已完成
- ✅ 状态管理修改：`selectedStrategy` → `selectedStrategies[]`
- ✅ 创建 `handleStrategyToggle()` 函数处理多选
- ✅ 修改 `handleSubmit()` 函数：
  - 支持构建多策略请求数据
  - 根据选中策略数量决定使用 `strategy_id` 或 `strategy_ids`
  - 传递组合模式参数

#### 2.2 待完成
- ❌ 修改左侧策略卡片渲染逻辑
  - 将 `isSelected = selectedStrategy?.id === strategy.id` 改为 `isSelected = selectedStrategies.includes(strategy.id)`
  - 点击事件改为调用 `handleStrategyToggle()`
  - 支持多个策略同时高亮显示
  - 显示选中数量标识

---

## ⏳ 待开发功能

### 3. 前端UI组件（0%完成）

#### 3.1 组合模式选择器
**位置**: 回测配置区域，策略参数上方

```tsx
<Form.Item
  label="策略组合模式"
  name="combineMode"
  tooltip="选择多个策略时如何组合它们的信号"
>
  <Select>
    <Option value="AND">AND - 所有策略同时确认</Option>
    <Option value="OR">OR - 任一策略触发</Option>
    <Option value="VOTE">VOTE - 投票机制</Option>
  </Select>
</Form.Item>
```

#### 3.2 投票阈值输入
**显示条件**: 当 `combineMode === 'VOTE'` 时显示

```tsx
{values.combineMode === 'VOTE' && (
  <Form.Item
    label="投票阈值"
    name="voteThreshold"
    tooltip="需要多少个策略发出信号才执行交易"
  >
    <InputNumber
      min={1}
      max={selectedStrategies.length}
      defaultValue={Math.ceil(selectedStrategies.length / 2)}
    />
  </Form.Item>
)}
```

#### 3.3 多策略参数显示优化
**问题**: 不同策略可能有不同参数
**方案**:
- 显示第一个选中策略的参数（当前实现）
- 或者：合并所有策略的参数，去重后显示
- 或者：为每个策略单独显示参数区域（复杂）

#### 3.4 回测结果显示优化
**修改**: 策略名称显示
- 单策略：`strategy: "ma_cross"`
- 多策略：`strategy: { strategies: ["ma_cross", "macd_cross"], combine_mode: "AND" }`

需要在结果展示区域友好显示组合信息，例如：
```
策略: 均线金叉 + MACD金叉 (AND模式)
```

---

## 📝 下次开发清单

### 优先级1（核心功能）
1. [ ] 修改策略卡片渲染逻辑支持多选
2. [ ] 添加组合模式选择器
3. [ ] 添加投票阈值输入框
4. [ ] 重新构建前端镜像
5. [ ] 测试单策略模式（确保向后兼容）
6. [ ] 测试多策略AND模式
7. [ ] 测试多策略OR模式
8. [ ] 测试多策略VOTE模式

### 优先级2（优化）
9. [ ] 优化多策略结果展示
10. [ ] 添加策略选择数量提示（如："已选择2个策略"）
11. [ ] 添加清空选择按钮
12. [ ] 优化参数显示逻辑

### 优先级3（文档）
13. [ ] 更新API文档
14. [ ] 添加用户使用说明
15. [ ] 添加多策略示例

---

## 🔧 技术细节备忘

### 后端API格式

**单策略（兼容旧格式）**:
```json
{
  "symbol": "600519",
  "strategy_id": "ma_cross",
  "start_date": "20240101",
  "end_date": "20241231",
  "initial_capital": 100000,
  "commission_rate": 0.0003,
  "strategy_params": { "fast_period": 5, "slow_period": 20 }
}
```

**多策略**:
```json
{
  "symbol": "600519",
  "strategy_ids": ["ma_cross", "macd_cross"],
  "combine_mode": "AND",
  "vote_threshold": 2,
  "start_date": "20240101",
  "end_date": "20241231",
  "initial_capital": 100000,
  "commission_rate": 0.0003,
  "strategy_params": {}
}
```

### 前端状态管理
```tsx
// 已修改
const [selectedStrategies, setSelectedStrategies] = useState<string[]>([]);

// 选择/取消选择策略
const handleStrategyToggle = (strategyId: string) => {
  // 已实现
}

// 提交表单
const handleSubmit = async (values: any) => {
  // 已更新支持多策略
}
```

---

## 🐛 已知问题

1. **参数共享问题**: 当前所有策略共用同一组参数，不同策略可能需要不同参数
2. **UI状态同步**: 需要测试策略选择和表单状态是否正确同步

---

## 📊 完成度估算

| 模块 | 完成度 | 预计剩余时间 |
|------|--------|------------|
| 后端API | 100% | - |
| 前端逻辑 | 40% | 20分钟 |
| 前端UI | 0% | 30分钟 |
| 测试 | 0% | 15分钟 |
| **总计** | **35%** | **65分钟** |

---

## 💡 后续增强建议

1. **策略权重**: 为每个策略设置权重，加权组合信号
2. **参数独立**: 为每个策略设置独立的参数
3. **信号可视化**: 在K线图上用不同颜色标注不同策略的信号
4. **性能对比**: 显示单策略 vs 多策略的回测对比
5. **策略模板**: 保存常用的策略组合作为模板

---

**记录时间**: 2025-11-07
**下次开发**: 从"修改策略卡片渲染逻辑"开始
