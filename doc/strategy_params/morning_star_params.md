# Morning Star 策略参数设计文档

**策略ID**: `morning_star`
**策略名称**: 早晨之星
**文档版本**: v1.0
**创建日期**: 2025-11-11

---

## 参数设计概述

本文档定义了早晨之星策略的所有可配置参数。早晨之星是一个经典的**K线形态策略**（Pattern Strategy），属于底部反转形态，由三根连续的K线组成，预示着下跌趋势可能结束，上涨趋势即将开始。

---

## 早晨之星形态原理简述

### 形态构成（经典定义）

早晨之星由三根连续K线组成：

**第一根K线**：长阴线（实体较大）
- 表示下跌趋势延续
- 收盘价远低于开盘价

**第二根K线**：十字星或小实体（星线）
- 开盘价和收盘价接近（实体很小）
- 表示多空力量暂时平衡
- 可以是十字星、陀螺线或小阴线/小阳线

**第三根K线**：长阳线（实体较大）
- 表示多头反攻
- 收盘价远高于开盘价
- 理想情况下，收盘价应深入第一根阴线实体

### 形态意义
- **市场心理**：卖方力量衰竭，买方力量恢复
- **反转信号**：底部反转，看涨
- **出现位置**：通常在下跌趋势末期或重要支撑位

### 识别要点
1. ✅ 前期有明显下跌趋势
2. ✅ 三根K线组合完整
3. ✅ 第二根星线实体小，与前后K线有跳空缺口（理想情况）
4. ✅ 第三根阳线实体大，深入第一根阴线

---

## 参数分类

### 1. 基础参数

#### 1.1 时间周期

| 参数名 | 类型 | 默认值 | 可选值 | 说明 |
|--------|------|--------|--------|------|
| `timeframe` | select | `D` | `D`(日线), `W`(周线) | 策略运行的时间周期 |

**设计说明**：
- 日线：最常用，信号频率适中
- 周线：信号更稳定但更少，适合长线投资

---

#### 1.2 持有周期

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `hold_periods` | integer | 5 | 1-30 | 买入后持有的周期数（天/周） |

**设计说明**：
- 形态策略通常没有明确的卖出形态
- 默认持有固定周期后卖出
- 也可以通过检测反向形态（暮星）提前卖出

**周期选择指导**：
- 短期（3-5天）：捕捉短期反弹
- 中期（7-10天）：捕捉波段行情
- 长期（15-20天）：跟踪趋势反转

---

### 2. 形态识别参数（待实现，Phase 2）

#### 2.1 严格性控制

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `strict_mode` | boolean | false | 是否使用严格识别模式 |
| `require_gap` | boolean | false | 是否要求跳空缺口 |
| `min_body_ratio` | float | 0.6 | 第一根/第三根K线的最小实体比例 |

**参数说明**：

**strict_mode（严格模式）**：
- false：宽松识别，第二根星线可以是小实体
- true：严格识别，第二根必须是十字星（实体极小）

**require_gap（跳空要求）**：
- false：允许无跳空的早晨之星
- true：要求第二根星线与第一、第三根K线有跳空缺口（更经典）

**min_body_ratio（实体比例）**：
- 定义"长实体"的标准
- 实体比例 = (close - open) / (high - low)
- 例如：0.6表示实体至少占K线全长的60%

---

#### 2.2 趋势要求（待实现，Phase 2）

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `require_downtrend` | boolean | true | - | 是否要求前期有下跌趋势 |
| `downtrend_periods` | integer | 5 | 3-20 | 判断下跌趋势的回看周期 |
| `downtrend_threshold` | float | -0.05 | -0.2 to -0.02 | 下跌幅度阈值（如-5%） |

**设计说明**：
- 经典早晨之星应该出现在下跌趋势之后
- 如果前期是上涨趋势，信号可靠性降低
- `downtrend_periods`: 回看N天，判断是否有下跌趋势
- `downtrend_threshold`: 要求N天内至少下跌X%

---

### 3. 卖出策略参数

#### 3.1 反向形态卖出

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `use_evening_star_exit` | boolean | true | 是否检测暮星形态提前卖出 |

**设计说明**：
- 暮星（Evening Star）是早晨之星的镜像形态（顶部反转）
- 如果持仓期间检测到暮星，提前卖出
- 避免从盈利变成亏损

**暮星形态**：
1. 第一根：长阳线（上涨）
2. 第二根：星线（十字星或小实体）
3. 第三根：长阴线（下跌）

---

#### 3.2 固定持有周期（已实现）

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `hold_periods` | integer | 5 | 1-30 | 持有周期数 |

**逻辑**：
- 买入后持有N个周期
- 到期后自动卖出
- 简单但有效

---

## 信号生成逻辑（当前实现）

### 买入信号（检测到早晨之星）
```
条件：检测到完整的早晨之星形态

逻辑：
  for i in range(2, len(df)):  # 至少需要3根K线
      if detect_morning_star(df, i):
          signal[i] = BUY

检测逻辑（IndicatorService.detect_morning_star）：
  1. 第一根K线：阴线（close < open）且实体较大
  2. 第二根K线：星线（实体很小）
  3. 第三根K线：阳线（close > open）且实体较大
```

### 卖出信号
```
条件1：持有周期到期
  buy_date + hold_periods天后 → SELL

条件2：检测到暮星形态（如启用）
  if use_evening_star_exit and detect_evening_star(df, i):
      signal[i] = SELL
```

---

## 形态识别算法详解

### 早晨之星识别逻辑（当前实现）

```python
def detect_morning_star(df, i):
    """检测早晨之星形态."""
    if i < 2:
        return False

    # 获取三根K线
    k1 = df.iloc[i-2]  # 第一根：长阴线
    k2 = df.iloc[i-1]  # 第二根：星线
    k3 = df.iloc[i]    # 第三根：长阳线

    # 第一根：阴线且实体较大
    body1 = abs(k1['close'] - k1['open'])
    is_bearish_1 = k1['close'] < k1['open']
    is_large_body_1 = body1 > (k1['high'] - k1['low']) * 0.6

    # 第二根：星线（实体很小）
    body2 = abs(k2['close'] - k2['open'])
    is_small_body_2 = body2 < (k2['high'] - k2['low']) * 0.3

    # 第三根：阳线且实体较大
    body3 = abs(k3['close'] - k3['open'])
    is_bullish_3 = k3['close'] > k3['open']
    is_large_body_3 = body3 > (k3['high'] - k3['low']) * 0.6

    # 理想情况：第三根收盘价深入第一根实体
    deep_penetration = k3['close'] > (k1['open'] + k1['close']) / 2

    # 组合判断
    return (is_bearish_1 and is_large_body_1 and
            is_small_body_2 and
            is_bullish_3 and is_large_body_3)
```

**当前算法的不足**：
- 未检查前期是否有下跌趋势
- 未检查跳空缺口
- 未考虑成交量
- 阈值（0.6, 0.3）是硬编码的

**Phase 2优化方向**：
- 添加前期趋势检查
- 添加跳空要求（可选）
- 添加成交量确认
- 参数化阈值

---

## 参数优化建议

### 优化目标维度

1. **提高胜率**：
   - 使用严格模式（strict_mode=true）
   - 要求前期下跌趋势
   - 要求跳空缺口
   - 结合成交量确认

2. **增加交易频率**：
   - 使用宽松模式（strict_mode=false）
   - 不要求跳空
   - 降低实体比例要求

3. **平衡收益与频率**：
   - 标准设置 + 趋势过滤
   - 持有周期优化（回测确定最佳值）

---

## 参数预设方案

### 方案1：标准版（默认）
```json
{
  "hold_periods": 5,
  "use_evening_star_exit": true,
  "timeframe": "D"
}
```
- 特点：基础识别，持有5天
- 适合：普通散户，短期波段
- 预期：年化信号10-30次，胜率50-60%

### 方案2：严格版（高质量）
```json
{
  "strict_mode": true,
  "require_gap": true,
  "require_downtrend": true,
  "downtrend_periods": 10,
  "hold_periods": 7,
  "use_evening_star_exit": true,
  "timeframe": "D"
}
```
- 特点：严格识别，信号少但质量高
- 适合：稳健投资者
- 预期：年化信号5-15次，胜率65-75%

### 方案3：宽松版（高频）
```json
{
  "strict_mode": false,
  "require_gap": false,
  "min_body_ratio": 0.5,
  "hold_periods": 3,
  "use_evening_star_exit": true,
  "timeframe": "D"
}
```
- 特点：宽松识别，信号多
- 适合：短线交易者
- 预期：年化信号30-60次，胜率45-55%

### 方案4：趋势跟随版
```json
{
  "require_downtrend": true,
  "downtrend_threshold": -0.10,
  "hold_periods": 15,
  "use_evening_star_exit": true,
  "trend_ma_filter": 200,
  "timeframe": "D"
}
```
- 特点：深度下跌后反转，长期持有
- 适合：捕捉大级别反转
- 预期：年化信号3-10次，单次收益高

### 方案5：周线级别
```json
{
  "hold_periods": 3,
  "use_evening_star_exit": true,
  "timeframe": "W"
}
```
- 特点：周线形态，信号稳定
- 适合：长线投资者
- 预期：年化信号2-8次，胜率60-70%

---

## 常见问题与优化

### Q1: 形态识别准确率不高？
**答**：K线形态识别是主观的，算法难以完美

**优化方案**：
1. **人工复核**：
   - 提供形态识别结果的可视化
   - 用户可手动确认是否符合

2. **机器学习**：
   - 收集专家标注的形态数据
   - 训练分类模型识别形态

3. **多重确认**：
   - 结合技术指标（如RSI超卖、MACD金叉）
   - 结合成交量（第三根放量）

### Q2: 信号太少？
**答**：经典形态出现频率本身就不高

**优化方案**：
1. **放宽识别标准**：
   - 不要求跳空
   - 降低实体比例要求
   - 允许"类早晨之星"形态

2. **扩展形态库**：
   - 添加其他反转形态（锤子线、刺透形态等）
   - 组合多种形态策略

3. **缩短周期**：
   - 使用小时K线或30分钟K线（但需要更多数据）

### Q3: 假信号多？
**答**：不是所有形态都会成功反转

**优化方案**：
1. **趋势过滤**：
   - 仅在价格位于长期均线附近时交易
   - 避免在强下跌趋势中"接飞刀"

2. **位置过滤**：
   - 仅在重要支撑位附近出现的早晨之星才交易
   - 使用斐波那契回撤位、前期低点等作为参考

3. **确认等待**：
   - 不在形态完成当天买入
   - 等待第二天继续上涨再确认

---

## 高级优化方向（Phase 2/3）

### 1. 形态强度评分（推荐实现）

为每个识别到的形态打分，优先交易高分形态：

```
评分维度：
1. 实体比例（第一、第三根越大越好）
2. 穿透深度（第三根深入第一根越多越好）
3. 跳空幅度（有跳空加分）
4. 成交量（第三根放量加分）
5. 前期趋势（明显下跌趋势加分）
6. 位置（接近支撑位加分）

总分：0-100
建议：只交易评分>70的形态
```

### 2. 成交量确认（推荐实现）

```
买入条件：
  检测到早晨之星
  AND 第三根K线成交量 > 前5日均量 × 1.5
  → 量价配合，信号更可靠
```

### 3. 多重形态组合

```
强烈买入信号：
  早晨之星 + RSI超卖反弹 + MACD金叉
  → 形态、超卖、动能三重确认
```

---

## 与其他策略的组合

### 组合1：早晨之星 + 均线
```
买入条件：
  早晨之星 AND 价格在MA(50)上方
  → 形态反转 + 中期趋势向上
```

### 组合2：早晨之星 + RSI
```
买入条件：
  早晨之星 AND RSI < 30
  → 形态反转 + 超卖确认
```

### 组合3：早晨之星 + 支撑位
```
买入条件：
  早晨之星 AND 价格在前期低点±2%范围内
  → 形态反转 + 支撑位支撑
```

---

## 参数回测建议

### 参数搜索范围

```python
param_grid = {
    'hold_periods': [3, 5, 7, 10, 15],
    'strict_mode': [False, True],
    'require_downtrend': [False, True],
    'use_evening_star_exit': [False, True]
}

# 评估每种组合的胜率、收益率、交易频率
```

### 评估指标

1. **胜率**：形态策略应追求55-65%胜率
2. **信号频率**：年化10-30次为宜（太少没价值，太多不可靠）
3. **单次平均收益**：目标3-8%
4. **最大回撤**：控制在10%以内

---

## 风险控制建议

### 1. 止损设置（重要！）
```json
{
  "stop_loss_pct": 0.05,     // 下跌5%止损（形态失败）
  "time_stop_days": 2        // 2天不涨则止损
}
```

**理由**：
- 形态反转失败往往很快显现
- 第三根阳线后如果继续下跌，说明反转失败
- 及时止损避免深套

### 2. 分批买入
```json
{
  "first_position": 0.5,     // 形态完成时买入50%
  "second_position": 0.5,    // 第二天继续上涨再买入50%
  "confirm_threshold": 0.02  // 要求上涨2%才确认
}
```

### 3. 持仓管理
```json
{
  "max_hold_days": 15,       // 最长持有15天
  "trailing_stop": 0.08      // 从高点回撤8%止盈
}
```

---

## 实现优先级

### Phase 1（已实现）✅
- ✅ 基础早晨之星识别
- ✅ 固定持有周期卖出
- ✅ 暮星形态提前卖出（use_evening_star_exit）

### Phase 2（建议实现）📋
- 📋 严格模式/宽松模式切换
- 📋 跳空要求（可选）
- 📋 前期趋势检查
- 📋 实体比例参数化（min_body_ratio）
- 📋 成交量确认
- 📋 形态强度评分

### Phase 3（高级功能）⭕
- ⭕ 其他反转形态（锤子线、刺透形态等）
- ⭕ 形态库扩展（黄昏之星、乌云盖顶等）
- ⭕ 机器学习形态识别
- ⭕ 支撑位/阻力位识别

---

## 参数校验规则

```python
def validate_params(params):
    hold_periods = params.get('hold_periods', 5)

    assert 1 <= hold_periods <= 30, "持有周期必须在1-30之间"
    assert params['timeframe'] in ['D', 'W'], "时间周期必须是D或W"

    # Phase 2参数校验
    if 'min_body_ratio' in params:
        assert 0.3 <= params['min_body_ratio'] <= 0.9, \
            "实体比例必须在0.3-0.9之间"

    if 'downtrend_threshold' in params:
        assert -0.3 <= params['downtrend_threshold'] <= -0.02, \
            "下跌阈值必须在-30%到-2%之间"

    return True
```

---

## 性能考虑

1. **计算复杂度**：O(n)，逐K线扫描识别形态
2. **识别难度**：中等，需要精确的形态匹配算法
3. **实时性**：适合每日收盘后分析

---

## 其他反转形态（未来扩展）

早晨之星只是众多K线形态之一，未来可以扩展：

### 底部反转形态
- **锤子线（Hammer）**：单根K线，下影线很长
- **倒锤子线（Inverted Hammer）**：单根K线，上影线很长
- **刺透形态（Piercing Pattern）**：两根K线，阳线深入阴线
- **启明星（Morning Doji Star）**：早晨之星的变种，第二根是十字星

### 顶部反转形态
- **暮星（Evening Star）**：早晨之星的镜像（已部分实现）
- **射击之星（Shooting Star）**：单根K线，上影线很长
- **乌云盖顶（Dark Cloud Cover）**：两根K线，阴线深入阳线
- **黄昏星（Evening Doji Star）**：暮星的变种

---

## 文档变更记录

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2025-11-11 | 初始版本，定义Morning Star策略所有参数 |
