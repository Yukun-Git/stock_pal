# MACD Cross 策略参数设计文档

**策略ID**: `macd_cross`
**策略名称**: MACD金叉
**文档版本**: v1.0
**创建日期**: 2025-11-10

---

## 参数设计概述

本文档定义了 MACD Cross 策略的所有可配置参数。这些参数基于策略文档中的优化建议，旨在为用户提供灵活的配置选项，以适应不同的市场环境和交易风格。

---

## 参数分类

### 1. 基础参数

#### 1.1 MACD 指标参数

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `macd_fast` | integer | 12 | 5-30 | MACD快线EMA周期 |
| `macd_slow` | integer | 26 | 20-60 | MACD慢线EMA周期 |
| `macd_signal` | integer | 9 | 5-20 | MACD信号线EMA周期 |

**设计说明**：
- 默认使用标准参数 (12, 26, 9)
- 文档建议：快速参数 (6, 19, 6)，慢速参数 (19, 39, 9)
- 允许用户自定义，但提供预设选项

**前端展示**：
- 可以提供"标准"、"快速"、"慢速"三个预设选项
- 或提供三个独立的数字输入框

---

### 2. 信号过滤参数

#### 2.1 0轴位置过滤

| 参数名 | 类型 | 默认值 | 可选值 | 说明 |
|--------|------|--------|--------|------|
| `zero_line_filter` | select | `none` | `none`, `above_only`, `below_only`, `near_only` | 0轴位置过滤 |

**可选值说明**：
- `none`: 不过滤，所有金叉都交易
- `above_only`: 仅交易0轴以上的金叉（强信号）
- `below_only`: 仅交易0轴以下的金叉（弱反弹，较少使用）
- `near_only`: 仅交易0轴附近的金叉（趋势转换初期）

**实现逻辑**：
- 0轴即 DIF = 0
- "附近"定义为 DIF 在 [-阈值, +阈值] 范围内
- 需要配合 `zero_line_threshold` 参数

#### 2.2 0轴附近阈值

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `zero_line_threshold` | float | 0.05 | 0.01-0.5 | 定义"0轴附近"的范围（DIF的绝对值） |

**设计说明**：
- 仅当 `zero_line_filter` = `near_only` 时生效
- 例如：阈值0.05表示 DIF 在 [-0.05, 0.05] 时视为0轴附近

---

#### 2.3 第二次金叉过滤

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `second_cross_only` | boolean | false | 是否仅交易第二次金叉 |
| `cross_lookback` | integer | 10 | 查找前一次金叉的回看周期数 |

**设计说明**：
- 第二次金叉 = 出现金叉后一段时间内再次金叉
- `cross_lookback`: 在过去N个周期内寻找前一次金叉
- 如果找到前一次金叉且间隔适当，则视为"第二次金叉"

**实现逻辑**：
1. 检测当前金叉
2. 向前查找 `cross_lookback` 个周期
3. 如果找到之前的金叉（且中间出现过死叉），则确认为第二次金叉

---

#### 2.4 背离分析

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `use_divergence` | boolean | false | 是否启用背离分析 |
| `divergence_lookback` | integer | 20 | 寻找背离的回看周期数 |
| `divergence_type` | select | `both` | `bullish`, `bearish`, `both` - 使用哪种背离 |

**可选值说明**：
- `bullish`: 仅使用底背离（买入信号增强）
- `bearish`: 仅使用顶背离（卖出信号增强）
- `both`: 同时使用底背离和顶背离

**背离定义**：
- **底背离（Bullish Divergence）**：
  - 价格创新低，但 MACD 的 DIF 不创新低
  - 表示下跌动能减弱，可能反转向上
  - 增强买入信号

- **顶背离（Bearish Divergence）**：
  - 价格创新高，但 MACD 的 DIF 不创新高
  - 表示上涨动能减弱，可能反转向下
  - 增强卖出信号

**实现逻辑**：
1. 在过去 `divergence_lookback` 个周期内
2. 比较价格的高点/低点与 DIF 的高点/低点
3. 检测是否存在背离

---

#### 2.5 MACD柱状图确认

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `histogram_confirm` | boolean | false | 是否要求柱状图确认 |
| `histogram_increasing` | boolean | true | 是否要求柱状图放大（增强信号） |

**设计说明**：
- `histogram_confirm`: 金叉时要求 MACD 柱由负转正
- `histogram_increasing`: 要求柱状图连续放大（动能增强）

**实现逻辑**：
- MACD柱 = (DIF - DEA) × 2
- 金叉时检查：
  - 前一日柱 < 0，当日柱 > 0（由负转正）
  - 当日柱 > 前一日柱（放大）

---

### 3. 趋势过滤参数

#### 3.1 均线趋势过滤

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `trend_ma_period` | integer | 0 | 0, 20-250 | 趋势过滤均线周期（0=不启用） |
| `trend_ma_position` | select | `above` | `above`, `below`, `any` | 价格相对均线的位置要求 |

**设计说明**：
- `trend_ma_period = 0`: 不使用趋势过滤
- `trend_ma_period = 200`: 使用200日均线过滤（文档建议）
- `above`: 仅在价格位于均线上方时做金叉买入
- `below`: 仅在价格位于均线下方时做金叉买入（较少使用）
- `any`: 不限制位置

**实现逻辑**：
- 计算指定周期的简单移动平均线 MA(N)
- 买入信号时检查：收盘价与 MA 的位置关系

---

### 4. 多周期共振（高级功能）

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `require_higher_timeframe` | boolean | false | 是否要求更大周期确认 |
| `higher_timeframe` | select | `W` | `W`, `M` - 更大周期 |

**设计说明**：
- 仅在当前周期为 `D`（日线）时生效
- 要求周线（W）或月线（M）也处于金叉状态
- 提高信号可靠性，但会减少交易频率

**实现逻辑**：
1. 将日线数据重采样为周线/月线
2. 在更大周期上计算 MACD
3. 检查更大周期是否也是金叉状态
4. 仅当两个周期都金叉时才发出买入信号

**注意**：此功能实现复杂度较高，可作为第二阶段开发

---

### 5. 止损参数

#### 5.1 固定比例止损

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `stop_loss_pct` | float | 0 | 0, 0.03-0.15 | 固定止损比例（0=不启用） |

**设计说明**：
- 买入后，如果价格下跌超过该比例，强制卖出
- 例如：`stop_loss_pct = 0.08` 表示下跌8%止损
- 0 表示不使用固定止损，仅依赖死叉卖出

**实现逻辑**：
- 记录买入价格
- 每日检查：当前价格 < 买入价格 × (1 - stop_loss_pct)
- 触发止损后立即卖出

---

## 参数优先级和组合规则

### 买入信号确认流程

```
1. 基础条件：MACD金叉（DIF上穿DEA）
   ↓
2. 0轴过滤（如启用）
   ↓
3. 第二次金叉检查（如启用）
   ↓
4. 背离分析（如启用）
   ↓
5. 柱状图确认（如启用）
   ↓
6. 趋势过滤（如启用）
   ↓
7. 多周期共振（如启用）
   ↓
最终买入信号
```

### 卖出信号确认流程

```
1. 持有中...
   ↓
2. 检查止损（如启用）→ 触发？→ 卖出
   ↓
3. MACD死叉（DIF下穿DEA）→ 卖出
```

---

## 参数分组建议

为了前端展示清晰，建议将参数分为以下几组：

### 基础组
- MACD参数 (macd_fast, macd_slow, macd_signal)
- 时间周期 (timeframe)

### 信号过滤组
- 0轴过滤 (zero_line_filter, zero_line_threshold)
- 第二次金叉 (second_cross_only, cross_lookback)
- 背离分析 (use_divergence, divergence_lookback, divergence_type)
- 柱状图确认 (histogram_confirm, histogram_increasing)

### 趋势过滤组
- 均线过滤 (trend_ma_period, trend_ma_position)

### 风控组
- 固定止损 (stop_loss_pct)

### 高级组
- 多周期共振 (require_higher_timeframe, higher_timeframe)

---

## 参数预设方案

为用户提供几个预设的参数组合：

### 方案1：基础版
- 所有过滤均关闭
- 适合：初学者，了解基础MACD信号

### 方案2：稳健版
- 0轴过滤：仅0轴以上
- 趋势过滤：200日均线上方
- 止损：8%
- 适合：稳健投资者

### 方案3：激进版
- 第二次金叉：开启
- 背离分析：开启
- 柱状图确认：开启
- 适合：追求高胜率的交易者

### 方案4：专业版
- 所有过滤开启
- 多周期共振
- 适合：专业交易者

---

## 实现优先级

### Phase 1（核心功能）- 必须实现
- ✅ 0轴过滤
- ✅ 趋势过滤（均线）
- ✅ 固定止损
- ✅ 柱状图确认

### Phase 2（增强功能）- 推荐实现
- ✅ 第二次金叉
- ✅ 背离分析
- ✅ MACD参数可配置

### Phase 3（高级功能）- 可选实现
- ⭕ 多周期共振

---

## 参数校验规则

1. `macd_fast < macd_slow`（快线周期必须小于慢线）
2. `trend_ma_period = 0 或 >= 20`（均线周期0或大于20）
3. `stop_loss_pct = 0 或 0.03 <= stop_loss_pct <= 0.15`（止损3%-15%或不启用）
4. `zero_line_threshold > 0`（阈值必须大于0）
5. `cross_lookback >= 5`（回看周期至少5个）
6. `divergence_lookback >= 10`（背离回看至少10个周期）

---

## 性能考虑

1. **计算开销**：
   - 背离分析需要遍历历史数据，开销较大
   - 多周期共振需要重采样数据，额外计算
   - 建议缓存中间结果

2. **参数数量**：
   - 当前设计约15个参数
   - 前端需要良好的UI分组和折叠

3. **回测时间**：
   - 开启所有过滤后，回测时间可能增加2-3倍
   - 建议显示计算进度

---

## 后续扩展

未来可以考虑的扩展：

1. **动态参数**：根据市场波动率自动调整 MACD 参数
2. **仓位管理**：根据信号强度调整买入仓位
3. **分批止盈**：设置多个止盈目标
4. **时间止损**：持仓超过N天后强制平仓
5. **ATR止损**：基于波动率的动态止损

---

## 文档变更记录

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2025-11-10 | 初始版本，定义所有MACD策略参数 |
