# Stock Pal 产品需求文档（PRD）v0.1

最后更新：2025-11-12 负责人：Owner TBD 存放路径：`doc/requirements/product_requirements_stock_pal.md`

## 1. 愿景与目标
- 愿景：为广大道散户提供“可信回测 + 一键生成次日执行清单”的轻量化投研与执行工具，以“风险先行、简单可用、长期可坚持”为核心价值。
- 北极星指标：用户完成“筛股 → 回测 → 次日计划 → 提醒 → 复盘”的完整闭环次数。

## 2. 用户画像与 Jobs-to-be-Done
- 新手入门者：需要少而清晰的买卖规则与风险护栏，避免踩雷。
- 上班族投资者：想用最少时间完成“筛股-计划-执行-复盘”的日常闭环。
- 技术派短线/波段：需要高质量选股器、热点/连板追踪、严谨A股回测与参数迭代。
- 基本面/中长线：希望结合质量与估值、行业轮动，控制组合风险与回撤。
- 复盘型用户：需要热点与市场情绪总览，以及“本策略近期是否失效”的提示。

## 3. A股交易规则与回测约束（关键合规性）
- 交易制度：T+1；不同板块涨跌幅约束（主板±10%，创业/科创±20%，ST ±5%）。
- 盘中机制：集合竞价（9:15–9:25）、连续竞价、停复牌；炸板/回封；封单无法成交。
- 价格与复权：前/后复权一致性；除权除息处理；成交价需符合撮合逻辑与滑点/成本模型。
- 标的状态：停牌、退市、ST、重大违规、财务雷等需过滤或约束交易。
- 指标与参考：北向资金、龙虎榜、融资融券、行业/概念归属、限售解禁、增减持、回购、业绩节奏。

## 4. 功能需求与优先级

### 4.1 必备一：可信回测（MUST）
验收标准（AC）：
- 满足A股规则（T+1、涨跌停与停牌约束）与费用/滑点模型；结果可复现（相同输入→相同输出）。
- 输出指标：年化、最大回撤、Calmar、Sharpe、Sortino、胜率、盈亏比、仓位暴露、换手、基准对比（沪深300/中证500/创业板指/科创50）。
- 提供训练/验证/测试或走步验证（walk-forward）能力，避免过拟合；参数网格与热力图结果可导出。

范围（Scope）：撮合器、成本/滑点、风险模块（止损/止盈/回撤保护）、因子/信号库接口、行业/指数数据接入。

### 4.2 必备二：选股与扫描（MUST）
AC：
- 提供一组首批模板（技术3–5个 + 基础面2–3个）；可配置参数；支持组合过滤（技术+基本面+事件）。
- 支持“一键回测”与“加入观察列表”；筛选结果附带打分与入场区间建议。
- 支持基于交易日的EOD批量扫描（定时任务），缓存结果至 `data/`（带TTL与交易日感知）。

### 4.3 必备三：风险与“地雷”过滤（MUST）
AC：
- 内置过滤：ST/退市、财务预警、巨额商誉、连续亏损、被立案、异常负债等。
- 策略级风控：单票/组合止损止盈、最大回撤阈值、仓位上限、波动目标（Vol Targeting）。

### 4.4 必备四：次日计划与提醒（MUST）
AC：
- 基于策略扫描与风险护栏生成“次日计划表”（候选标的、入场区间、仓位建议、风险提示），可导出。
- 提醒：先实现EOD与开盘前/后站内或邮件提醒（到价/炸板/回封/放量等关键事件）。
- 观察列表（Watchlist）：分组管理、标注理由、追踪执行结果。

### 4.5 提升一：组合与复盘（SHOULD）
- 多标的组合回测；相关性/行业暴露；与指数β；定期再平衡；一页式Tearsheet。
- 每日/每周复盘：热点风向、北向资金、板块景气、策略表现晴雨表（近期是否失效）。

### 4.6 提升二：可视化与可解释性（SHOULD）
- K线叠加买卖点/事件；回撤区间标注；收益来源分解（选股 vs 仓位 vs 市场）。
- 策略体检卡：最差年份、连续亏损段、脆弱因子、建议停止使用条件。

### 4.7 增强：轻量社区与分享（COULD）
- 回测报告分享链接、策略模板库、可复制参数；排行榜以“风险收益质量”为主，而非单一年化。

## 5. 非功能需求（NFR）
- 性能：回测耗时P95目标≤5s（近3年日频，单策略）；筛选耗时P95≤3s（缓存命中）。
- 可复现性：相同输入（数据快照/参数/版本）保证相同输出；记录元数据（数据版本、撮合/费用配置、代码版本）。
- 可观测性：关键链路日志、指标（延迟、错误率）、追踪ID；异常报警。
- 可靠性：接口可降级（缓存兜底）；错误提示可解释。
- 端口与配置：所有端口配置需先参考 `/Users/yukun-admin/projects/web3/web3-demo/PORT_INFO.md`，并与本仓库 `PORT_INFO.md` 保持一致，避免冲突。
- 代码质量：遵循 `AGENTS.md` 约定（Black/Flake8、Pytest、前后端结构与命名约定）。

## 6. 数据与来源（优先EOD可得）
- 行情：日线（必须）、后续扩展到分钟线；前/后复权一致；交易日历与停牌数据。
- 参考/事件：北向净买、龙虎榜、限售解禁、回购/增减持、业绩预告/季报、行业/概念映射。
- 缓存：`data/` 目录统一管理，含TTL、交易日感知与快照标记。

## 7. API 设计草案（backend/app/api/v1）

备注：遵循现有风格（如 `backtest.py`），新增接口以 `v1` 前缀归类。示例为建议形态，具体以实现为准。

1) 选股扫描 `POST /api/v1/scan`
- 入参示例：
```json
{
  "universe": "CN_STOCKS",
  "date": "2025-11-11",
  "templates": [
    {"id": "ma_trend", "params": {"ma_short": 10, "ma_long": 60}},
    {"id": "breakout", "params": {"lookback": 20}}
  ],
  "fundamental_filters": {"roe_min": 10, "pe_max": 40},
  "risk_filters": {"exclude_st": true, "exclude_susp": true}
}
```
- 返回示例：
```json
{
  "date": "2025-11-11",
  "candidates": [
    {
      "symbol": "SH600000",
      "name": "浦发银行",
      "score": 0.78,
      "reasons": ["MA趋势向上", "量价配合"],
      "entry_range": {"lower": 9.80, "upper": 9.98},
      "stop": 9.40,
      "risk_flags": ["行业景气一般"]
    }
  ]
}
```

2) 回测 `POST /api/v1/backtest`（已存在，建议补充分支）
- 入参扩展：撮合与费用、风控、基准、分段验证。
```json
{
  "strategy_id": "ma_cross",
  "params": {"short": 10, "long": 60},
  "universe": "CN_STOCKS",
  "start_date": "2020-01-01",
  "end_date": "2025-11-11",
  "initial_capital": 100000,
  "commission_bps": 2.5,
  "slippage_bps": 5,
  "risk_controls": {"max_drawdown": 0.2, "position_cap": 0.2},
  "benchmark": "CSI300",
  "walk_forward": {"train_years": 3, "test_years": 1}
}
```
- 返回扩展示例：
```json
{
  "metrics": {
    "cagr": 0.18,
    "max_drawdown": 0.15,
    "sharpe": 1.2,
    "calmar": 1.2,
    "win_rate": 0.52,
    "profit_factor": 1.6
  },
  "equity_curve": [
    {"date": "2020-01-02", "value": 100200},
    {"date": "2020-01-03", "value": 100180}
  ],
  "trades": [
    {"symbol": "SZ000001", "date": "2021-03-05", "side": "BUY", "price": 12.34, "size": 800},
    {"symbol": "SZ000001", "date": "2021-04-20", "side": "SELL", "price": 13.80, "size": 800}
  ],
  "holdings": [{"date": "2021-03-06", "exposure": 0.8}],
  "benchmark": {"symbol": "CSI300", "equity_curve": []}
}
```

3) 次日计划 `POST /api/v1/plan`
- 入参：与 `/scan` 输出结合，附策略与风控配置。
- 返回：可执行清单（入场区间、仓位建议、风险提示、取消/替换建议）。

4) 提醒订阅与推送
- 创建订阅 `POST /api/v1/alerts`（到价、均线、炸板/回封、量能等条件）；
- 列表与删除 `GET/DELETE /api/v1/alerts`；
- 发送（内部定时任务触发，支持站内/邮件）。

5) 组合回测 `POST /api/v1/portfolio_backtest`
- 多策略/多标的权重与再平衡；相关性与行业暴露输出。

错误约定：
- 标准HTTP码 + 业务码（`code`）与可解释 `message`；附 `trace_id` 便于排查。

## 8. 前端页面与交互（MVP）
- Dashboard：今日概览（指数/热点/北向/情绪）、策略表现卡、最近提醒、EOD复盘入口。
- Screener：技术/基本面/事件筛选；结果一键回测与加入观察列表；批量标注理由。
- Strategy Lab：参数表单、回测报告（指标/曲线/交易点）、对比与保存；体检卡片。
- Backtests：历史回测列表、对比与导出；参数热力图与走步验证结果展示。
- Watchlist：分组/标注/到价与事件提醒设置；执行结果标记。
- Alerts：提醒规则管理与触发记录。

## 9. MVP（两周可交付）与验收标准
交付物：
- 可信回测V1：T+1、涨跌停/停牌约束、费用/滑点、基准对比；`/api/v1/backtest` 支持新参数，导出Tearsheet。
- 选股器V1：3–5个技术模板，筛选→一键回测；结果加入观察列表。
- 次日计划表V1：`/api/v1/plan` 返回买入区间、仓位建议、风险提示（EOD）。
- 观察列表 + EOD提醒V1：站内或邮件通道可配置；发送开关与频率控制。
- Dashboard V1：热点/北向/指数概览 + 策略表现卡片。

验收：
- 回测P95≤5s（3年日频，单策略，缓存命中后≤3s）；筛选P95≤3s（缓存命中≤1s）。
- 单测：撮合/规则、费用/滑点、ST与涨跌停边界、复权正确性；`pytest -q app/services` 通过。
- 端口与配置符合 `AGENTS.md` 与 `/Users/yukun-admin/projects/web3/web3-demo/PORT_INFO.md` 约束；文档更新 `PORT_INFO.md`。

## 10. 里程碑（8–12周）
- 第0期（1–2周）：数据与规则夯实；回测内核复现性；单测覆盖核心规则；定时任务骨架（APScheduler）。
- 第1期（2–3周）：选股器→一键回测→次日计划；观察列表与EOD提醒；前端五大页面骨架。
- 第2期（2–3周）：风险/地雷过滤；参数网格与OOS分段；组合回测与暴露；Tearsheet完善。
- 第3期（2–4周）：每日复盘/晨报；提醒到盘中关键事件；分享链接与手机端优化。

## 11. 成功指标（Metrics）
- 闭环：日均完成“筛股→回测→计划→提醒→复盘”次数。
- 高意图：提醒数、保存策略数、回测对比次数、观察列表活跃度。
- 留存：7日/30日留存、晨报打开率、交易日活跃率。
- 质量：回测耗时P95、数据延迟、结果复现率、接口错误率。

## 12. 商业化与合规
- Freemium：免费EOD与基础回测/模板；付费解锁批量扫描/提醒、参数网格、组合回测、走步验证、更高频数据等。
- 订阅：月/季/年；团队版（多设备/共享模板）。
- 合规：非投顾声明；数据来源与许可清晰；用户协议/隐私政策；限制导出敏感数据。

## 13. 测试与质量保障
- 单元测试：撮合/费用/滑点、T+1与涨跌停、停牌、复权、风控边界。
- 集成测试：端到端回测一致性、`/scan`→`/backtest`→`/plan` 流程闭环。
- 回测不变式（Invariants）：
  - 仅在可成交价位成交；涨停/封单不成交；T+1禁止当日卖出；
  - 加入成本/滑点后收益率应劣化或相同，不应优于无成本情景；
  - 数据快照版本改变才允许结果改变。
- 代码风格：Black/Flake8；前端ESLint；提交前格式化。

## 14. 风险与未决问题
- 数据可得性与许可：优先选结构化且易缓存的数据源；明示许可与使用边界。
- 回测耗时与并发：必要时引入异步/批处理与结果缓存；参数网格作业排队。
- 合规边界：明示非投顾；限制个股过度曝光；提醒文案避免“承诺收益”。

## 15. 参考与现有文档
- 竞品分析：`doc/requirements/competitor_analysis.md`
- 产品路线：`doc/requirements/product_roadmap.md`
- 技术指标与方法论：`doc/散户常用技术指标与交易方法论.md`
- 端口与部署：仓库 `PORT_INFO.md` 与外部 `/Users/yukun-admin/projects/web3/web3-demo/PORT_INFO.md`

---

附录A：涨跌幅与交易规则速查（实现参考）
- 主板：±10%；创业/科创：±20%；ST：±5%。
- 集合竞价：9:15–9:25；停牌期间不可成交；封涨停/跌停视为不可成交价位。
- 价格撮合：以可成交的下一跳价（含滑点）模拟，成交量受限于可用流动性（简化版先忽略盘口深度）。

附录B：返回字段约定（片段）
- `metrics`：`cagr`，`max_drawdown`，`sharpe`，`sortino`，`calmar`，`win_rate`，`profit_factor`，`exposure`
- `trade`：`symbol`，`date`，`side`，`price`，`size`，`reason`
- `plan_item`：`symbol`，`entry_range.lower/upper`，`stop`，`position_suggested`，`risk_flags`，`notes`

