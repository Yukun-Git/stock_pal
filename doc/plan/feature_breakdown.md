# Stock Pal 功能需求提炼与开发规划

**生成时间**：2025-11-12
**来源文档**：`doc/requirements/product_requirements_stock_pal.md`
**目标**：将 PRD 提炼为可执行的功能开发清单

---

## 核心功能（MUST - MVP 必备）

### 1. 可信回测引擎升级

**当前状态**：已有基础回测功能（`app/services/backtest_service.py`）

**需要增强**：
- **A股交易规则约束**
  - T+1 制度（当日买入次日才能卖出）
  - 涨跌停板限制（主板±10%、创业/科创±20%、ST±5%）
  - 停牌期间不可交易
  - 集合竞价时段处理（9:15-9:25）

- **更精确的成本模型**
  - 滑点模拟（slippage_bps）
  - 撮合逻辑（价格必须在可成交范围内）
  - 涨停/跌停封单不可成交

- **扩展性能指标**
  - 现有：总收益、胜率、最大回撤、盈亏比
  - 新增：年化收益（CAGR）、Calmar比率、Sortino比率
  - 基准对比（沪深300/中证500/创业板指/科创50）
  - 仓位暴露、换手率

- **参数优化与验证**
  - 参数网格搜索（Grid Search）
  - 热力图可视化
  - 走步验证（Walk-Forward）防止过拟合

- **结果可复现性**
  - 记录元数据（数据版本、参数、代码版本）
  - 相同输入保证相同输出

**API 影响**：扩展现有 `POST /api/v1/backtest` 接口参数

**验收标准**：
- 回测 P95 耗时 ≤5s（3年日频，单策略）
- 单元测试覆盖所有交易规则边界
- 输出完整的 Tearsheet 报告

---

### 2. 选股器系统（全新功能）

**核心能力**：
- **技术指标模板**（3-5个首批模板）
  - MA 趋势突破
  - 放量突破
  - 多均线排列
  - MACD/KDJ 金叉
  - RSI 超卖反弹

- **基本面过滤器**（2-3个）
  - ROE 下限
  - PE/PB 上限
  - 营收增长率

- **事件过滤**
  - 北向资金净买入
  - 龙虎榜上榜
  - 重要公告

- **结果输出**
  - 候选股票列表
  - 综合打分
  - 入场区间建议（lower/upper）
  - 止损价建议
  - 风险标签（行业景气、流动性等）

- **交互功能**
  - 筛选结果一键回测
  - 批量加入观察列表
  - 导出/保存筛选配置

**新增 API**：
- `POST /api/v1/scan` - 执行选股扫描
- `GET /api/v1/scan/templates` - 获取可用模板列表

**数据依赖**：
- 日线行情数据（OHLCV）
- 基本面数据（财务指标）
- 事件数据（北向、龙虎榜等）

**验收标准**：
- 筛选 P95 耗时 ≤3s（全市场，缓存命中后≤1s）
- 支持定时任务 EOD 批量扫描
- 结果缓存至 `data/` 目录（带 TTL 和交易日感知）

---

### 3. 风险过滤系统（全新功能）

**内置过滤规则**：
- ST/退市股票
- 财务预警（连续亏损、资不抵债）
- 商誉风险（巨额商誉占比过高）
- 监管风险（被立案、重大违规）
- 异常负债（资产负债率过高）
- 停牌中股票

**策略级风控**：
- 单票止损止盈（百分比或绝对价格）
- 组合最大回撤阈值
- 单票仓位上限（position_cap）
- 波动率目标（Vol Targeting）

**实现方式**：
- 数据层：`app/services/risk_service.py`
- 与选股器集成：`risk_filters` 参数
- 与回测集成：`risk_controls` 参数

**验收标准**：
- 过滤规则可配置开关
- 风险标签明确可解释
- 不合规股票自动剔除

---

### 4. 次日计划与提醒（全新功能）

**次日计划表生成**：
- 基于选股结果 + 风控规则
- 输出内容：
  - 候选标的列表
  - 入场区间（价格范围）
  - 建议仓位大小
  - 风险提示
  - 取消/替换建议
- 可导出为 CSV/Excel

**观察列表（Watchlist）**：
- 分组管理（自选股分组）
- 标注理由（为何关注）
- 追踪执行结果（买入/卖出记录）
- 支持拖拽排序

**提醒系统**：
- **提醒类型**：
  - 到价提醒（触及目标价/止损价）
  - 均线突破提醒
  - 炸板/回封提醒
  - 放量异动提醒
  - 开盘前计划提醒

- **推送通道**：
  - 站内通知（优先实现）
  - 邮件通知
  - 后续：短信/微信/推送通知

- **定时任务**：
  - EOD 扫描（每日收盘后）
  - 开盘前提醒（9:00）
  - 盘中监控（需要实时数据）

**新增 API**：
- `POST /api/v1/plan` - 生成次日计划
- `GET /api/v1/watchlist` - 获取观察列表
- `POST /api/v1/watchlist` - 添加到观察列表
- `POST /api/v1/alerts` - 创建提醒规则
- `GET /api/v1/alerts` - 获取提醒列表
- `DELETE /api/v1/alerts/{id}` - 删除提醒

**技术实现**：
- 定时任务：APScheduler
- 交易日判断：需要交易日历数据
- 邮件发送：SMTP 配置

**验收标准**：
- 计划表可导出
- 提醒准确触发（误报率<5%）
- EOD 任务稳定运行

---

### 5. Dashboard 与市场概览（全新功能）

**今日概览**：
- 主要指数（上证、深证、创业板、科创）
- 涨跌幅、成交量、成交额
- 涨停/跌停家数
- 市场情绪指标

**热点板块**：
- 行业/概念涨跌幅排行
- 资金流向
- 龙虎榜热门

**北向资金**：
- 当日净买入额
- 十大活跃股
- 历史趋势

**策略表现卡片**：
- 我的策略列表
- 近期收益率
- 是否失效提示（连续回撤/胜率下降）

**最近提醒**：
- 今日触发的提醒
- 待处理计划

**复盘入口**：
- 每日/每周复盘报告
- 策略体检

**前端页面**：`frontend/src/pages/DashboardPage.tsx`

**验收标准**：
- 数据实时更新（或 EOD 更新）
- 页面加载 <2s
- 移动端友好

---

## 提升功能（SHOULD - 后续迭代）

### 6. 组合回测与复盘

**组合回测**：
- 多标的组合
- 相关性矩阵
- 行业暴露分析
- 与指数 Beta
- 定期再平衡策略
- 一页式 Tearsheet

**复盘功能**：
- 每日复盘：热点风向、板块景气
- 每周复盘：策略表现汇总
- 晨报生成（自动推送）
- 策略失效预警

**新增 API**：
- `POST /api/v1/portfolio_backtest` - 组合回测

---

### 7. 可视化与可解释性

**增强图表**：
- K线叠加买卖点与事件标注
- 回撤区间高亮显示
- 收益来源分解（选股 vs 仓位 vs 市场）

**策略体检卡**：
- 最差年份表现
- 最长连续亏损段
- 脆弱因子识别
- 建议停止使用条件

**前端实现**：
- 扩展 `KLineChart.tsx`
- 新增 `EquityDecompositionChart.tsx`
- 新增 `StrategyHealthCard.tsx`

---

### 8. 轻量社区与分享（COULD - 长期规划）

**分享功能**：
- 回测报告生成分享链接
- 策略模板库（公开/私有）
- 参数配置一键复制

**排行榜**：
- 以"风险调整后收益"为主（Sharpe/Calmar）
- 避免单一年化误导

**社区互动**：
- 策略讨论区
- 复盘笔记分享

---

## 建议开发顺序（MVP 两周交付）

### 第一周：核心引擎 + 数据基础

**Day 1-2：回测引擎升级（功能点1）**
- T+1 规则实现
- 涨跌停约束
- 滑点与成本模型
- 扩展指标计算

**Day 3-4：风险过滤基础（功能点3）**
- ST/退市过滤
- 停牌处理
- 基础风控参数

**Day 5：数据服务增强**
- 交易日历集成
- 数据缓存机制
- 基本面数据接入（如有必要）

---

### 第二周：选股 + 计划 + 前端

**Day 6-7：选股器实现（功能点2）**
- 3-5个技术模板
- `/api/v1/scan` 接口
- 批量扫描与缓存

**Day 8-9：次日计划与观察列表（功能点4）**
- `/api/v1/plan` 接口
- 观察列表 CRUD
- 定时任务骨架（APScheduler）

**Day 10：Dashboard 骨架（功能点5）**
- 指数概览
- 策略卡片
- 前端页面布局

**Day 11-12：提醒系统（功能点4续）**
- 提醒规则管理
- EOD 邮件/站内通知
- 触发逻辑实现

**Day 13-14：集成测试与优化**
- 端到端流程测试
- 性能优化（缓存、异步）
- 文档更新

---

## 技术债与非功能需求

### 性能目标
- 回测 P95 ≤5s（3年日频，单策略）
- 筛选 P95 ≤3s（缓存命中 ≤1s）
- Dashboard 加载 <2s

### 可观测性
- 关键链路日志（结构化）
- 性能指标监控（延迟、错误率）
- 追踪 ID（trace_id）
- 异常报警

### 数据质量
- 数据版本管理
- 缓存 TTL 与交易日感知
- 复权一致性检查

### 代码质量
- Black/Flake8 格式化
- Pytest 单元测试覆盖核心逻辑
- 前端 ESLint/TypeScript 严格模式

### 端口配置
- 参考 `/Users/yukun-admin/projects/web3/web3-demo/PORT_INFO.md`
- 更新本仓库 `PORT_INFO.md`
- 避免端口冲突

---

## 下一步行动

**建议起点**：从**功能点1（回测引擎升级）**开始，因为它是整个系统的基石。

**问题**：你想从哪个功能开始？还是按照建议的两周 MVP 计划逐步推进？
