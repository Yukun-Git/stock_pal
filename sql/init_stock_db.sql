-- ============================================================================
-- Stock Pal 数据库初始化脚本 (PostgreSQL 15+)
-- ============================================================================
-- 功能: 初始化StockPal数据库的完整Schema
-- 数据库: PostgreSQL 15+
-- 创建时间: 2025-11-17
-- 用途: 在Docker容器启动时自动初始化数据库结构
-- ============================================================================

\echo '========================================'
\echo '  Stock Pal 数据库初始化开始'
\echo '========================================'
\echo ''

-- ----------------------------------------------------------------------------
-- 数据库扩展初始化
-- ----------------------------------------------------------------------------

\echo '>>> 正在初始化数据库扩展...'

-- UUID 生成扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 加密函数扩展
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

\echo '>>> 扩展初始化完成'
\echo ''

-- ----------------------------------------------------------------------------
-- 执行模块化 SQL 脚本
-- ----------------------------------------------------------------------------

\echo '>>> 正在加载模块 1: 股票数据缓存...'
\i /docker-entrypoint-initdb.d/modules/01_stock_data_cache.sql
\echo '>>> 模块 1 加载完成'
\echo ''

\echo '>>> 正在加载模块 2: 回测结果存储...'
\i /docker-entrypoint-initdb.d/modules/02_backtest_results.sql
\echo '>>> 模块 2 加载完成'
\echo ''

\echo '>>> 正在加载模块 3: 用户管理（预留）...'
\i /docker-entrypoint-initdb.d/modules/03_user_management.sql
\echo '>>> 模块 3 加载完成'
\echo ''

\echo '>>> 正在加载模块 4: 观察列表与提醒...'
\i /docker-entrypoint-initdb.d/modules/04_watchlist.sql
\echo '>>> 模块 4 加载完成'
\echo ''

-- ----------------------------------------------------------------------------
-- 导入 Mock 数据（可选）
-- ----------------------------------------------------------------------------

-- 如果 mock_data 目录下有数据文件，在此导入
-- \echo '>>> 正在导入 Mock 数据...'
-- \i /docker-entrypoint-initdb.d/mock_data/sample_data.sql
-- \echo '>>> Mock 数据导入完成'
-- \echo ''

-- ----------------------------------------------------------------------------
-- 验证数据库结构
-- ----------------------------------------------------------------------------

\echo '========================================'
\echo '  数据库结构验证'
\echo '========================================'
\echo ''

-- 显示所有表
\echo '>>> 已创建的表：'
\dt

\echo ''
\echo '========================================'
\echo '  Stock Pal 数据库初始化完成'
\echo '========================================'
\echo ''
