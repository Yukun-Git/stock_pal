# SQL æ¨¡å—è¯´æ˜

æœ¬ç›®å½•åŒ…å« Stock Pal ç³»ç»Ÿçš„æ‰€æœ‰æ•°æ®åº“æ¨¡å—å®šä¹‰ã€‚æ¯ä¸ªæ¨¡å—ä½¿ç”¨ç‹¬ç«‹çš„ SQL æ–‡ä»¶ç®¡ç†ã€‚

---

## æ¨¡å—åˆ—è¡¨

| æ–‡ä»¶ | æ¨¡å—åç§° | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| `01_stock_data_cache.sql` | è‚¡ç¥¨æ•°æ®ç¼“å­˜ | âœ… å·²å®ç° | ç¼“å­˜AkShareè¡Œæƒ…æ•°æ® |
| `02_backtest_results.sql` | å›æµ‹ç»“æœå­˜å‚¨ | ğŸ”¶ è®¾è®¡ä¸­ | å­˜å‚¨å›æµ‹è¿è¡Œè®°å½• |
| `03_user_management.sql` | ç”¨æˆ·ç®¡ç† | ğŸ“‹ é¢„ç•™ | ç”¨æˆ·è®¤è¯ä¸æˆæƒï¼ˆå¤šç”¨æˆ·ç‰ˆæœ¬ï¼‰ |
| `04_watchlist.sql` | è§‚å¯Ÿåˆ—è¡¨ä¸æé†’ | ğŸ“‹ é¢„ç•™ | è‡ªé€‰è‚¡ã€ä»·æ ¼æé†’ |

**çŠ¶æ€è¯´æ˜**ï¼š
- âœ… å·²å®ç°ï¼šä»£ç å·²ç¼–å†™å¹¶åœ¨ä½¿ç”¨ä¸­
- ğŸ”¶ è®¾è®¡ä¸­ï¼šæœ‰è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼Œå³å°†å®ç°
- ğŸ“‹ é¢„ç•™ï¼šéœ€æ±‚å·²ç¡®å®šï¼Œæœªæ¥ç‰ˆæœ¬å®ç°

---

## æ•°æ®åº“ç±»å‹

å½“å‰ç³»ç»Ÿä½¿ç”¨ **SQLite**ï¼ˆæ–‡ä»¶ï¼š`data/stock_cache.db`ï¼‰

### SQLite ç‰¹ç‚¹
- âœ… æ— éœ€ç‹¬ç«‹æ•°æ®åº“æœåŠ¡å™¨
- âœ… é€‚åˆå•ç”¨æˆ·/å°è§„æ¨¡éƒ¨ç½²
- âœ… è½»é‡çº§ã€é›¶é…ç½®
- âš ï¸ å¹¶å‘å†™å…¥æ€§èƒ½æœ‰é™
- âš ï¸ ä¸æ”¯æŒæŸäº›é«˜çº§ç‰¹æ€§ï¼ˆå¦‚ ENUMã€å¤æ‚çº¦æŸï¼‰

### æœªæ¥è¿ç§»è®¡åˆ’
å½“ç³»ç»Ÿéœ€è¦æ”¯æŒä»¥ä¸‹åœºæ™¯æ—¶ï¼Œè€ƒè™‘è¿ç§»åˆ° **PostgreSQL** æˆ– **MySQL**ï¼š
- å¤šç”¨æˆ·å¹¶å‘è®¿é—®
- å¤§è§„æ¨¡æ•°æ®é‡ï¼ˆ>10GBï¼‰
- åˆ†å¸ƒå¼éƒ¨ç½²
- é«˜çº§æŸ¥è¯¢ä¼˜åŒ–

---

## ä½¿ç”¨æŒ‡å—

### 1. åˆå§‹åŒ–æ•°æ®åº“

**æ–¹å¼ä¸€ï¼šé€šè¿‡ä»£ç åˆå§‹åŒ–ï¼ˆæ¨èï¼‰**
```python
# Pythonä»£ç ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
from app.services.cache_service import CacheService
cache_service = CacheService()  # è‡ªåŠ¨è°ƒç”¨ _init_database()
```

**æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡ŒSQL**
```bash
# SQLite
cd /Users/yukun-admin/projects/stock_pal
sqlite3 data/stock_cache.db < sql/modules/01_stock_data_cache.sql
```

### 2. æŸ¥çœ‹è¡¨ç»“æ„

```bash
# SQLite
sqlite3 data/stock_cache.db ".schema"

# æŸ¥çœ‹ç‰¹å®šè¡¨
sqlite3 data/stock_cache.db ".schema stock_data"
```

### 3. æŸ¥è¯¢ç¤ºä¾‹

```bash
# è¿›å…¥SQLiteå‘½ä»¤è¡Œ
sqlite3 data/stock_cache.db

# æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡
SELECT COUNT(DISTINCT symbol) as stock_count, COUNT(*) as total_records FROM stock_data;

# æŸ¥è¯¢æŸåªè‚¡ç¥¨çš„æ•°æ®
SELECT * FROM stock_data WHERE symbol='000001' LIMIT 10;

# æŸ¥çœ‹åŒæ­¥æ—¥å¿—
SELECT * FROM data_sync_log;
```

### 4. æ•°æ®ç»´æŠ¤

```bash
# æ¸…ç†1å¹´å‰çš„æ—§æ•°æ®
sqlite3 data/stock_cache.db "DELETE FROM stock_data WHERE date < date('now', '-1 year');"

# ä¼˜åŒ–æ•°æ®åº“ï¼ˆå›æ”¶ç©ºé—´ï¼‰
sqlite3 data/stock_cache.db "VACUUM;"

# é‡å»ºç´¢å¼•
sqlite3 data/stock_cache.db "REINDEX;"
```

### 5. å¤‡ä»½ä¸æ¢å¤

```bash
# å¤‡ä»½
cp data/stock_cache.db data/stock_cache.db.backup_$(date +%Y%m%d)

# æ¢å¤
cp data/stock_cache.db.backup_20251112 data/stock_cache.db

# å¯¼å‡ºä¸ºSQL
sqlite3 data/stock_cache.db .dump > backup.sql

# ä»SQLå¯¼å…¥
sqlite3 data/stock_cache.db < backup.sql
```

---

## SQL æ–‡ä»¶è§„èŒƒ

æ¯ä¸ªæ¨¡å—çš„ SQL æ–‡ä»¶åº”éµå¾ªä»¥ä¸‹è§„èŒƒï¼š

### æ–‡ä»¶å‘½å
- æ ¼å¼ï¼š`{åºå·}_{æ¨¡å—å}.sql`
- åºå·ï¼šä¸¤ä½æ•°å­—ï¼ˆ01-99ï¼‰ï¼Œè¡¨ç¤ºåŠ è½½é¡ºåº
- ç¤ºä¾‹ï¼š`01_stock_data_cache.sql`

### æ–‡ä»¶ç»“æ„
```sql
-- ============================================================================
-- æ¨¡å—æ ‡é¢˜
-- ============================================================================
-- åŠŸèƒ½: æ¨¡å—åŠŸèƒ½ç®€è¿°
-- ä½¿ç”¨: ä½¿ç”¨è¯¥æ¨¡å—çš„æœåŠ¡/ç»„ä»¶
-- åˆ›å»ºæ—¶é—´: YYYY-MM-DD
-- çŠ¶æ€: å·²å®ç°/è®¾è®¡ä¸­/é¢„ç•™
-- ============================================================================

-- ----------------------------------------------------------------------------
-- è¡¨: table_name
-- è¯´æ˜: è¡¨çš„ç”¨é€”
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS table_name (
    -- ä¸»é”®
    id PRIMARY KEY,

    -- å­—æ®µï¼ˆå¸¦æ³¨é‡Šï¼‰
    field_name TYPE,  -- å­—æ®µè¯´æ˜

    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (field) REFERENCES other_table(id),

    -- ç´¢å¼•
    INDEX idx_name (field)
);

-- ----------------------------------------------------------------------------
-- ç¤ºä¾‹æŸ¥è¯¢
-- ----------------------------------------------------------------------------
-- ç¤ºä¾‹SQLæŸ¥è¯¢ï¼ˆå¸¦æ³¨é‡Šï¼‰

-- ============================================================================
-- ç»´æŠ¤è¯´æ˜
-- ============================================================================
-- 1. ç»´æŠ¤æ³¨æ„äº‹é¡¹
-- 2. æ¸…ç†ç­–ç•¥
-- 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
```

### æ³¨é‡Šè§„èŒƒ
- âœ… æ¯ä¸ªè¡¨ã€å­—æ®µéƒ½æœ‰æ¸…æ™°æ³¨é‡Š
- âœ… æä¾›å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹
- âœ… è¯´æ˜ç»´æŠ¤å»ºè®®
- âœ… æ ‡æ³¨çŠ¶æ€å’Œä¾èµ–

### å…¼å®¹æ€§
- ä¸»æ–‡ä»¶ä½¿ç”¨æ ‡å‡†SQLè¯­æ³•ï¼ˆMySQL/PostgreSQLï¼‰
- åœ¨æ³¨é‡ŠåŒºåŸŸæä¾›SQLiteé€‚é…ç‰ˆæœ¬
- è¯´æ˜æ•°æ®ç±»å‹å·®å¼‚ï¼ˆå¦‚ `BOOLEAN` vs `INTEGER`ï¼‰

---

## æ•°æ®åº“é…ç½®

### SQLite é…ç½®
```python
# backend/app/config.py
DB_PATH = os.getenv('DB_PATH', '/app/data/stock_cache.db')
```

### ç¯å¢ƒå˜é‡
```bash
# .env
DB_PATH=/app/data/stock_cache.db
```

### Docker æŒ‚è½½
```yaml
# docker-compose.yml
volumes:
  - ./data:/app/data  # æŒä¹…åŒ–æ•°æ®åº“æ–‡ä»¶
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–
- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- é¿å…è¿‡å¤šç´¢å¼•ï¼ˆå½±å“å†™å…¥æ€§èƒ½ï¼‰
- å®šæœŸé‡å»ºç´¢å¼•ï¼ˆ`REINDEX`ï¼‰

### 2. æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ `EXPLAIN QUERY PLAN` åˆ†ææŸ¥è¯¢
- é¿å… `SELECT *`ï¼ŒåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼ˆ`LIMIT` + `OFFSET`ï¼‰

### 3. æ•°æ®æ¸…ç†
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- ä½¿ç”¨ `VACUUM` å›æ”¶ç©ºé—´
- å½’æ¡£å†å²æ•°æ®

### 4. ç¼“å­˜ç­–ç•¥
- åœ¨åº”ç”¨å±‚å®ç°ç¼“å­˜ï¼ˆRedis/Memcachedï¼‰
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢é¢‘ç‡
- ä½¿ç”¨è¿æ¥æ± 

---

## å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“æ–‡ä»¶è¿‡å¤§æ€ä¹ˆåŠï¼Ÿ
**A**:
1. æ¸…ç†æ—§æ•°æ®ï¼š`DELETE FROM stock_data WHERE date < date('now', '-2 years');`
2. æ‰§è¡Œ VACUUMï¼š`sqlite3 data/stock_cache.db "VACUUM;"`
3. å½’æ¡£å†å²æ•°æ®åˆ°å•ç‹¬æ–‡ä»¶

### Q2: å¦‚ä½•è¿ç§»åˆ° PostgreSQLï¼Ÿ
**A**:
1. ä½¿ç”¨ `pgloader` å·¥å…·è‡ªåŠ¨è¿ç§»
2. æˆ–æ‰‹åŠ¨å¯¼å‡ºæ•°æ®ï¼Œè°ƒæ•´SQLè¯­æ³•åå¯¼å…¥
3. ä¿®æ”¹åº”ç”¨ä»£ç çš„æ•°æ®åº“è¿æ¥é…ç½®

### Q3: æ•°æ®åº“é”å®šé”™è¯¯ï¼ˆdatabase is lockedï¼‰
**A**:
1. æ£€æŸ¥æ˜¯å¦æœ‰é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
2. ä½¿ç”¨ `PRAGMA busy_timeout = 5000;` å¢åŠ è¶…æ—¶æ—¶é—´
3. è€ƒè™‘ä½¿ç”¨WALæ¨¡å¼ï¼š`PRAGMA journal_mode=WAL;`

### Q4: å¦‚ä½•é‡ç½®æ•°æ®åº“ï¼Ÿ
**A**:
```bash
# åˆ é™¤æ•°æ®åº“æ–‡ä»¶
rm data/stock_cache.db

# é‡å¯æœåŠ¡ï¼Œä¼šè‡ªåŠ¨é‡å»ºè¡¨ç»“æ„
docker-compose restart backend
```

---

## å‚è€ƒèµ„æ–™

- [SQLite å®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)
- [SQLite æ€§èƒ½ä¼˜åŒ–](https://www.sqlite.org/optoverview.html)
- [MySQL to SQLite å·®å¼‚](https://www.sqlite.org/sqlitevsmysql.html)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)

---

**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-12
